<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-4.5.2.css">
    <script src="../../static/js/jquery_351/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-5.1.2npm.css">

    <!-- commented for dromdown menu hover bug -->
    <!-- <link href="../../static/library/bootstrap-theme.min-3.3.6.css" rel="stylesheet"> -->
    <script src="../../static/library/bootstrap-5.1.2.bundle.min.js"></script>

    <!--BS Icons -->
    <link rel="stylesheet" href="../../static/library/bootstrap-icons-1.3.0.css">
    <!-- Fontawesome Icons -->

    <link rel="stylesheet" href="../../static/library/fontawesome-5.10.0.all.css"  />
    <link rel="stylesheet" href="../../static/library/font-awesome.min-4.7.0.css">


    <!-- anychart modules -->
    <script src="../../static/library/anychart-8.10.0-core.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-graph.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-pie.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-exports.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-cartesian.min.js"></script>

    <link rel="stylesheet" type="text/css" href="../../static/library/tom-select-2.2.1.css">
    <script src="../../static/library/tom-select.complete-2.2.1.min.js"></script>
    <script type="text/javascript" src="../../static/js/searchable-select.js"></script>

    <!-- Intro Js -->
    <script src="../../static/library/intro.min-4.3.0.js"></script>
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs.min-4.3.0.css">
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs-rtl.min-4.3.0.css">
    <link rel="stylesheet" href="../../static/styles/user_guide_tour.css">

    <link rel="stylesheet" href="../../static/styles/index2.css">
    <link rel="stylesheet" href="../../static/styles/information_chart.css">

    <!-- Multi Select  -->
    <link rel="stylesheet" type="text/css" href="../../static/styles/multiselect/multiselect-style.css">
    <script type="text/javascript" src="../../static/js/multiselect/jquery-2.2.4.min.js"></script>
    <script type="text/javascript" src="../../static/js/multiselect/jquery.multi-select.js"></script>

    <!-- Footable  -->
    <script src="../../static/js/footable/demo-rows.js"></script>
    <script src="../../static/js/footable/ie10-viewport-bug-workaround.js"></script>
    <script src="../../static/js/footable/footable.js"></script>
    <link href="../../static/styles/footable/footable.bootstrap.min.css" rel="stylesheet">
    <link href="../../static/styles/footable/docs.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.Glyphicons.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.FontAwesome.css" rel="stylesheet">



    <!-- Notyf  -->
    <link rel="stylesheet" type="text/css" href="../../static/library/notyf.min-npm.css">
    <script src="../../static/library/notyf.min.js"></script>

    <!--<script type="text/javascript" src="http://l2.io/ip.js?var=myip">
    </script>-->

    <meta charset="UTF-8">

    <title>تحلیل تعاریف</title>
    {% include "doc/title_icon.html" %}
</head>

<body>
    <!-- Menu -->
    <nav dir="rtl" class="navbar nav_menu navbar-expand-lg fixed-top p-0 mt-0">
        {% include "doc/header2.html" %}
    </nav>
    <script>
        $(document).ready(function () {

            // Active panel
            $('#SepecificDropdown').addClass('active');
            $('#definition').addClass('active');

            $('select#language').on('change', function (e) {

                let selected_language = this.value;
                let current_url = window.location.href;
                if (selected_language === 'England') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'en')
                    window.location = requested_url;
                } else if (selected_language === 'Russia') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'ru')
                    window.location = requested_url;
                }

            });
        });
    </script>


    <!-- End of Menu -->

    <!-- Main Container -->
    <div class="row flex-row-reverse px-0 py-5 px-md-5 py-md-5 m-0 mt-4">

        <!-- Form Inputs -->
        <form action="" id="information_form" class="custom-control mx-auto needs-validation"
            enctype="multipart/form-data" method="post" novalidate>
            <div class="row flex-row-reverse mx-auto">

                <!-- Country select -->
                <div class="col-md-6 col-12 col-lg-3 bg-light pt-3  mt-1" dir="rtl">
                    <label for="country" class=" text-right bg-light float-right">مجموعه سند:</label>
                    <select dir="rtl" id="country" name="country" class="form-select text-right float-right searchable-select"
                        onchange="CountryChanged()">
                        {% for k,v in countries.items %}
                        <option value="{{ k }}">{{ v }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Subject select -->
                <div id="selectDiv" class="col-md-6 pt-3 col-12 col-lg-3 bg-light mt-1" dir="rtl">
                    <label for="SubjectSelect" class="text-right bg-light float-right">موضوع سند <span
                            style="color: red">(*)</span>:</label>
                    <select id="SubjectSelect" class="form-select text-right float-right searchable-multi-select" style="direction: rtl;">
                    </select>
                </div>

                <!-- Show button -->
                <div class="col-lg-4 col-md-6 pt-5 col-12">
                    <button type="button" id="document_search" onclick="ShowResult()"
                        class="btn d-flex float-right mt-1 mr-4">
                        <div class="spinner-border text-light" role="status">
                            <span class="sr-only">درحال جستجو ...</span>
                        </div>
                        نمایش
                    </button>
                </div>
            </div>
        </form>

        <!--Original Tabs: Only show on large screens -->
        <ul id="original_tabs" class="nav nav-pills  mt-5 mx-auto  pr-3 pr-sm-0  float-right  d-block" id="pills-tab"
            role="tablist">

            <li class="nav-item float-right" role="presentation">
                <button id="keywords_extraction_tab" class="nav-link active" data-bs-toggle="pill"
                    data-bs-target="#keywords_extraction_pane" type="button" role="tab"
                    aria-controls="keywords_extraction_pane" aria-selected="false">واژه‌نامه‌ی تعاریف</button>
            </li>

            <li class="nav-item float-right" role="presentation">
                <button id="keywords_chart_tab" class="nav-link" data-bs-toggle="pill" data-bs-target="#keywords_chart"
                    type="button" role="tab" aria-controls="keywords_chart" aria-selected="true">توزیع
                    کلیدواژگان</button>
            </li>
            <li class="nav-item float-right" role="presentation">
                <button id="keywords_graph_tab" class="nav-link" data-bs-toggle="pill"
                    data-bs-target="#keywords_graph_pane" type="button" role="tab" aria-controls="keywords_graph_pane"
                    aria-selected="false">گراف
                    کلیدواژگان</button>
            </li>


            <!-- Download Buttons -->
            <!-- <button type="button" data-bs-toggle="tooltip" data-bs-placement="top" title="دانلود اسناد"
                class="btn float-left p-0 px-1 mt-2" id="DownloadBtn" onclick="DownloadSerachResultFunction()"
                type="button">
                <i class="far fa-file-archive m-0" style="font-size: 25px;margin: 0px;"></i>
            </button> -->

            <!-- Download Buttons -->
            <button type="button" data-bs-toggle="tooltip" data-bs-placement="top" title="دانلود اسناد"
                class="btn float-left p-0 px-1 mt-2" id="DownloadBtn" onclick="DownloadSerachResultFunction()"
                type="button">
                <i class="far fa-file-archive m-0" style="font-size: 25px;margin: 0px;"></i>

            </button>

            <button class="btn float-left p-0 px-1 mt-2" id="ExportExcel" data-bs-toggle="tooltip"
                data-bs-placement="top" title="خروجی اکسل" onclick="ExportExcelSerachResultFunction()" type="button">
                <i class="far fa-file-excel text-success m-0" style="font-size: 25px;margin: 0px;"></i>
            </button>

            <!-- Result Count -->
            <p id="SearchResultLable" class="text-left float-left text-secondary pl-2"></p>

        </ul>

        <div id="original_pane" class="tab-content float-right bg-white px-1" style="position: relative;"
            id="pills-tabContent">

            <!-- keywords chart Pane -->
            <div id="keywords_chart" class="tab-pane w-100 fade  float-right" role="tabpanel"
                aria-labelledby="keywords_chart">
                <h5 class="subject_distribution pr-2 w-100 mt-4 text-center float-right">توزیع کلیدواژگان</h5>
                <div id="keywords_chart_container" style="height: 400px" class="bg-white w-100 mt-3 p-4 border border-2">

                </div>


            </div>

            <!-- graph Pane -->
            <div id="keywords_graph_pane" class="tab-pane w-100 fade float-right  px-0 border-0" role="tabpanel"
                aria-labelledby="keywords_graph_tab">

                <!-- keyword graph container -->
                <div class="row mt-4 w-100 flex-row mx-0 px-4 pb-5">

                    <div id="keywords_graph_container" class="w-100 border" style="height: 500px;">
                    </div>
                </div>

            </div>


            <!-- keyword extraction Pane -->
            <div class="tab-pane fade show active float-right w-100 " id="keywords_extraction_pane" role="tabpanel"
                aria-labelledby="keywords_extraction_tab">

                <div class="table-responsive keywords_extraction_table mt-4">
                    <table class="table table-striped SearchTable" style="min-height: 200px;" id="SearchTable" dir="rtl">
                    </table>
                </div>
            </div>

            <!-- Modal Container for detail  -->
            <div class="modal fade" id="detailModal">
                <div class="modal-dialog modal-dialog-scrollable modal-lg">
                    <div class="modal-content">

                        <!-- Modal Header -->
                        <div style="direction: rtl !important;" class="modal-header">
                            <h5 id="ModalHeader" class="modal-title">عنوان</h5>
                            <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                        </div>

                        <!-- Modal body -->
                        <div id="DetailText" class="modal-body text-justify">
                        </div>

                        <!-- Modal footer -->
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
                        </div>

                    </div>
                </div>
            </div>

            <!-- ChartModal Container -->
            <button type="button" id="ChartModalBtn" class="btn d-none modal_btn" data-bs-toggle="modal"
                data-bs-target="#ChartModal"></button>
            <div class="modal fade" id="ChartModal">
                <div class="modal-dialog modal-dialog-scrollable modal-lg">
                    <div class="modal-content">

                        <!-- Modal Header -->
                        <div style="direction: rtl !important;" class="modal-header">
                            <h5 id="ChartModalHeader" class="modal-title"></h5>
                            <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                        </div>

                        <!-- Modal body -->
                        <div id="ChartModalText" class="modal-body text-justify">
                        </div>

                        <!-- Modal footer -->
                        <div dir="rtl" class="modal-footer">

                        </div>

                    </div>
                </div>
            </div>


            <!-- EdgeModal Container -->
            <button type="button" id="EdgeModalBtn" class="btn d-none modal_btn" data-bs-toggle="modal"
                data-bs-target="#EdgeModal"></button>
            <div class="modal fade" id="EdgeModal">
                <div class="modal-dialog modal-dialog-scrollable modal-lg">
                    <div class="modal-content">

                        <!-- Modal Header -->
                        <div style="direction: rtl !important;" class="modal-header">
                            <h5 id="EdgeModalHeader" class="modal-title"></h5>
                            <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                        </div>

                        <!-- Modal body -->
                        <div id="EdgeModalText" class="modal-body text-justify">
                        </div>

                        <!-- Modal footer -->
                        <div dir="rtl" class="modal-footer">

                        </div>

                    </div>
                </div>
            </div>


            <button id="scroll_btn" class="p-0" title="بالای صفحه" onclick="topFunction()">
                <i class="far fa-caret-square-up"></i>
                <!-- <i class="bi bi-chevron-up"></i> -->
                <!-- <i class="bi bi-chevron-double-up"></i> -->
                <!-- <i class="bi bi-arrow-up-circle"></i> -->
            </button>
            <script src="../../static/js/logincheck.js"></script>
            <script src="../../static/js/scroll_button_handler.js">
            </script>
        </div>
    </div>

    <!-- save log user -->
    <script>
        async function UserLog(form_data) {
            if (getCookie("username") !== "") {
                const user_name = getCookie("username")
                let page_url = window.location.pathname
                const user_ip = "127.0.0.0"
                page_url = page_url.slice(0, -1);
                if (page_url === "") {
                    page_url = "/0";
                }


                let link_request = 'http://' + location.host + "/UserLogSaved/" + user_name + page_url + "/" + user_ip + "/";

                $.ajax({
                    url: link_request,
                    data: form_data,
                    type: 'POST',
                    contentType: false,
                    processData: false,
                    async: true,


                }).done(function (res) {
                    console.log("done")

                }).fail(function (res) {
                    console.log("fail")
                });

            }
        }
    </script>


    <script>

        initSearchableSelects();

        container_id_list = ['SearchTable', 'SearchResultLable',
            'keywords_chart_container', 'keywords_graph_container']

        function clearPrevResults(container_id_list) {

            for (container_id of container_id_list) {
                document.getElementById(container_id).innerHTML = "";
            }
        }

        //subject multiselect
        async function CountryChanged() {

            clearPrevResults(container_id_list);
            countryId = document.getElementById("country").value

            /******************* Get Subject Options **********************/
            const request_link = 'http://' + location.host + "/GetSubjectsByCountryId/" + countryId + "/";
            let response = await fetch(request_link).then(response => response.json());
            response = response["documents_subject_list"]

            let options = [{ value: "0", text: "همه"}];
            console.log(response)
            console.log(document.getElementById("SubjectSelect"))
            for (var i = 0; i < response.length; i++) {
                const subject_id = response[i]["id"]
                const subject_name = response[i]["subject"]

                options.push({value:subject_id, text: subject_name});

            }
            syncSelectOptions('SubjectSelect', options)

            //user log
            let form_data = new FormData()
            let detail_type = "نمایش پنل"
            form_data.append('detail_type', detail_type);
            UserLog(form_data)

        }

        CountryChanged()

        async function showChart(data, position, keySort, xAxisTitle) {
            if (keySort === true) {
                data.sort(function (element_a, element_b) {
                    return element_a[0] - element_b[0];
                });
            }
            else {
                data.sort(function (element_a, element_b) {
                    return element_a[1] - element_b[1];
                });
            }


            data.sort(function(x,y){ return x[0] === 'نامشخص' ? -1 : y[0] === 'نامشخص' ? 1 : 0; });


            chart = anychart.column();

            // create a column series and set the data
            var series = chart.column(data);

            chart.animation(true);
            chart.background().fill('#f8f9fa');
            chart.background().fill('white');

            series.normal().fill("#488fb8", 1);
            series.normal().stroke("#488fb8", 0);

            // x axix labels font setting
            var xAxisLabels = chart.xAxis().labels();
            xAxisLabels.fontFamily("vazir");
            xAxisLabels.rotation(315);

            var yAxisLabels = chart.yAxis().labels();
            yAxisLabels.fontFamily("vazir");

            // Not allow labels overlapping
            var xAxis = chart.xAxis();
            xAxis.overlapMode("noOverlap");
            xAxis.title(xAxisTitle);
            xAxis.title().fontFamily('vazir');
xAxis.title().fontWeight("bold");
            xAxis.title().height(40);

            // tooltip content font setting
            var tooltip = chart.tooltip();
            tooltip.fontFamily("vazir");

            // tooltip title font setting
            var title = chart.tooltip().title();
            title.fontFamily("vazir");

            chart.tooltip().hAlign('center').format("{%value}");

            // set all axis title
            var xAxis = chart.xAxis();
            xAxis.title("کلید واژه");
            xAxis.title().fontFamily('vazir');
xAxis.title().fontWeight("bold");

            var yAxis = chart.yAxis();
            yAxis.title("تعداد اسناد");
            yAxis.title().fontFamily('vazir');
yAxis.title().fontWeight("bold");
            chart.yAxis().labels().format("{%value}");
            // force ticks to stick to integer values
            chart.yScale().ticks().allowFractional(false);
            chart.xAxis().labels().height(30);

            chart.container(position);
            chart.draw();
            chart.listen("mouseOver", function(e){
              document.body.style.cursor = "pointer";
            });
            chart.listen("mouseOut", function(e){
              document.body.style.cursor = "auto";
            });
            /******************************* show definitions for each keywords: keywords chart tab **********************************/
            chart.listen('Click', async function (event) {
                const click_tag = event.domTarget.tag;
                const index = click_tag["index"]
                const word = data[index][0]
                DetailFunction(word, 'ChartModalHeader', 'ChartModalText');
                $("#ChartModalBtn").click();

            });
        }


        async function ShowResult() {
            clearPrevResults(container_id_list);

            const multiselect_subject_value = GetMultiSelectSubjectValue();

            if (multiselect_subject_value == "") {
                alert('موضوعی انتخاب نشده‌است.');
            }
            else {
                await SpinnerModeFunction("Active");

                /******************************* keywords: keywords chart tab **********************************/
                notyf.dismissAll();
                startBlockUI('keywords_chart');

                const country_id = document.getElementById("country").value;
                request_link = 'http://' + location.host + "/GetMostRepetitiveKeywords/" + country_id + "/" + multiselect_subject_value + "/";
                response = await fetch(request_link).then(response => response.json());
                result_dict = response['result_dict']

                let chart_value_list = []
                for (const [word, word_count] of Object.entries(result_dict)) {

                    chart_value_list.push([word, word_count])

                }

                document.getElementById("keywords_chart_container").innerHTML = "";
                showChart(chart_value_list, "keywords_chart_container", "کلیدواژه");

                stopBlockUI('keywords_chart','توزیع کلیدواژگان');

                //for extraction keywords table:
                startBlockUI('SearchTable');
                startBlockUI('keywords_graph_container');

                request_link_1 = 'http://' + location.host + "/SearchDocumentsDefinitionByCountryId/" + country_id + "/" + GetMultiSelectSubjectValue() + "/";
                response = await fetch(request_link_1).then(response => response.json());

                keywords_information_result = response['keywords_information']

                await showDocumentInformation(keywords_information_result);
                stopBlockUI('SearchTable','واژه‌نامه تعاریف');

                createKeywordsGraphData(keywords_information_result);
                stopBlockUI('keywords_graph_container','گراف کلیدواژگان');

                await SpinnerModeFunction("Disable");

                
            }

            //user log
            let form_data = new FormData()
            let detail_type = "نتایج جست و جو"
            let country_name_select = $("#country option:selected").text();
            var multi_subject_select = "";
            $("#SubjectSelect option:selected").each(function () {
                multi_subject_select += $(this).text() + "، ";
            });
            form_data.append('detail_type', detail_type);
            form_data.append('country_name_select', country_name_select);
            form_data.append('subject_select', multi_subject_select);
            UserLog(form_data)

        }

        async function SpinnerModeFunction(mode) {
            if (mode === "Active") {
                $(".spinner-border").addClass("active");
            } else if (mode === "Disable") {
                $(".spinner-border").removeClass("active");
            }

        }

        async function createKeywordsGraphData(keywords_information_result) {

            document.getElementById("SearchResultLable").innerText = (Object.keys(keywords_information_result).length).toString() + " کلیدواژه یافت شد";
            nodes = []
            edges = []
            chart_data = []

            for (const [keyword, documents_list] of Object.entries(keywords_information_result)) {

                if (documents_list.length > 1) {
                    common_keyword_node = {
                        'id': keyword, 'name': keyword, 'fill': {
                            'src': "../../static/icons/question1.png"
                        }, 'group': 'common_keyword'
                    }
                    nodes.push(common_keyword_node);
                } else {
                    keyword_node = { 'id': keyword, 'name': keyword, 'group': 'keyword' };
                    nodes.push(keyword_node);
                }

                for (doc_info of documents_list) {
                    const document_id = doc_info["id"]
                    const document_name = doc_info["name"]
                    const document_link = 'http://' + location.host + "/information/?id=" + document_id
                    const doc_name = '<a target="to_blank" href="' + document_link + '">' + document_name + "</a>"

                    document_node = {
                        'id': document_id, 'name': document_name, 'fill': {
                            'src': "../../static/icons/docs.png"
                        }, 'group': 'document'
                    }
                    nodes.push(document_node);

                    edge = {
                        'id': document_id + '__' + keyword,
                        'from': document_id,
                        'to': keyword,
                        'from_name': document_name
                    };

                    edges.push(edge);
                }


            }

            chart_data = {
                'nodes': nodes,
                'edges': edges
            }

            keywords_graph_container
            showKeywordsGraph('keywords_graph_container', chart_data)

        }

        async function showKeywordsGraph(chart_container, chart_data) {


            document.getElementById(chart_container).innerHTML = ''
            // create a chart and set the data
            var chart = anychart.graph(chart_data);

            // set the container id
            chart.container(chart_container);

            // configure labels of keywords
            let keywords = chart.group("keyword");
            let common_keywords = chart.group("common_keyword");
            let documents = chart.group("document");



            if (common_keywords != undefined) {
                common_keywords.normal().height(35);
                common_keywords.hovered().height(40);
                common_keywords.selected().height(40);
                common_keywords.normal().stroke(null);

                common_keywords.labels().enabled(true);
                common_keywords.labels().format("{%id}").fontFamily('vazir');
                common_keywords.labels().fontSize(14);
                common_keywords.labels().fontWeight(600);
            }


            if (documents != undefined) {
                documents.normal().height(35);
                documents.hovered().height(40);
                documents.selected().height(40);
                documents.normal().stroke(null);
            }

            chart.nodes().tooltip().format("{%name}");
            chart.edges().tooltip().format(" سند:  {%from_name} \n کلیدواژه:  {%to}");
            chart.edges().tooltip().fontFamily('vazir');
            chart.nodes().tooltip().fontFamily('vazir');

            // initiate drawing the chart
            chart.draw();
            chart.listen("mouseOver", function(e){
              document.body.style.cursor = "pointer";
            });
            chart.listen("mouseOut", function(e){
              document.body.style.cursor = "auto";
            });

            chart.listen('Click', async function (event) {

                const click_tag = event.domTarget.tag;
                console.log(click_tag)
                if (click_tag["type"] === "node") {

                    // window.open('http://' + location.host + "/information?id=" + click_tag["id"]);
                } else if (click_tag["type"] === "edge") {

                    edge_data = click_tag["id"].split('__');
                    doc_id = edge_data[0]
                    keyword = edge_data[1]

                    const link = 'http://' + location.host + "/GetKeywordsDefinitionByDocumentId/" + doc_id + "/" + keyword + "/";
                    response = await fetch(link).then(response => response.json());
                    response = response['keyword_information']

                    document.getElementById('EdgeModalHeader').innerText = 'کلیدواژه: ' + keyword

                    paragraph_text = response['croped_text']
                    keyword_tag = "<span class='bg-success text-white px-1 rounded'>" + keyword + "</span>: "
                    paragraph_text = paragraph_text.replaceAll(keyword + ':', keyword_tag)

                    keyword_tag = "<span class='bg-success text-white px-1 rounded'>" + keyword + "</span>: "
                    paragraph_text = paragraph_text.replaceAll(keyword + ' :', keyword_tag)


                    const document_address = 'http://' + location.host + "/information/?id=" + response["doc_id"]
                    const document_link = '<a target = "to_blank" href = "' + document_address + '">' + response["doc_name"] + ':</a>'

                    doc_tag = '<h6 class="bold">' + document_link + '</h6>'
                    paragraph_tag = '<li dir="rtl" class = "text-right lh-lg">' + doc_tag + paragraph_text + '</li>'

                    document.getElementById('EdgeModalText').innerHTML = '<ol start="1"> ' + paragraph_tag + '</ol>';

                    $('#EdgeModalBtn').click();

                }

            })

        }

        async function showDocumentInformation(keywords_information_result) {

            SearchResultValue = keywords_information_result;


            document.getElementById("SearchResultLable").innerText = (Object.keys(keywords_information_result).length).toString() + " کلیدواژه یافت شد";
            let index = 1;
            let document_result = []

            for (const [keyword, documents_list] of Object.entries(keywords_information_result)) {
                keyword_documents_list = []

                for (doc_info of documents_list) {
                    const document_id = doc_info["id"]
                    const document_name = doc_info["name"]
                    const document_link = 'http://' + location.host + "/information/?id=" + document_id
                    const doc_name = '<a target="to_blank" href="' + document_link + '">' + document_name + "</a>"
                    keyword_documents_list.push(doc_name)
                }
                let documents_count = keyword_documents_list.length
                let keywords_documents_list_text = keyword_documents_list.join('<br>')

                const detail_function = "DetailFunction('" + keyword + "'," + "'ModalHeader'" + "," + "'DetailText'" + ")"
                const detail = '<button type="button" class="btn modal_btn" data-bs-toggle="modal" ' + ' onclick="' + detail_function + '" data-bs-target="#detailModal">جزئیات</button>'


                const row = { "id": index, "keyword": keyword, "documents_count": documents_count, "documents": keywords_documents_list_text, "detail": detail }
                document_result.push(row)
                index += 1


            }

            $('#SearchTable').empty();
            $('.SearchTable').footable({
                "paging": {
                    "enabled": true,
                     strings: {
                         first: '»',
                         prev:'›',
                         next: '‹',
                         last: '«'
                     }
                },
                "filtering": {
                    "enabled": false
                },
                "sorting": {
                    "enabled": true
                },
                "empty": "کلید واژه ای یافت نشد.",
                "columns": [{
                    "name": "id",
                    "title": "ردیف",
                    "breakpoints": "xs sm",
                    "type": "number",
                    "style": {
                        "width": "5%"
                    }
                }, {
                    "name": "keyword",
                    "title": "کلیدواژه",
                    "style": {
                        "width": "15%"
                    }
                }, {
                    "name": "documents_count",
                    "title": "تعداد اسناد",
                    "sorted": true,
                    "direction": "DESC",
                    "style": {
                        "width": "10%"
                    }
                }, {
                    "name": "documents",
                    "title": "اسناد حاوی کلیدواژه",
                    "style": {
                        "width": "35%"
                    }
                }, {
                    "name": "detail",
                    "title": "جزئیات",
                    "style": {
                        "width": "5%"
                    }
                }
                ],
                "rows": document_result
            });

        }



        async function DetailFunction(word, modal_header_id, modal_body_id) {

            const country_id = document.getElementById("country").value;
            const link = 'http://' + location.host + "/GetKeywordsDefinition/" + country_id + "/" + word + "/";
            response = await fetch(link).then(response => response.json());
            response = response['result']
            modal_paragraphs_tag = ''

            //in modal
            let filtered_result_tag = ""
            document.getElementById(modal_header_id).innerText = 'کلیدواژه: ' + word

            for (const res of response) {
                console.log(res['croped_text'])
                paragraph_text = res['croped_text']
                keyword_tag = "<span class='bg-success text-white px-1 rounded'>" + word + "</span>: "
                paragraph_text = paragraph_text.replaceAll(word + ':', keyword_tag)

                keyword_tag = "<span class='bg-success text-white px-1 rounded'>" + word + "</span>: "
                paragraph_text = paragraph_text.replaceAll(word + ' :', keyword_tag)


                const document_address = 'http://' + location.host + "/information/?id=" + res["doc_id"]
                const document_link = '<a target = "to_blank" href = "' + document_address + '">' + res["doc_name"] + ':</a>'

                doc_tag = '<h6 class="bold">' + document_link + '</h6>'
                paragraph_tag = '<li dir="rtl" class = "text-right lh-lg">' + doc_tag + paragraph_text + '</li>'
                modal_paragraphs_tag += paragraph_tag

            }

            document.getElementById(modal_body_id).innerHTML = '<ol start="1"> ' + modal_paragraphs_tag + '</ol>';

        }

    </script>
</body>


<!-- Export results -->

<script>

    async function downloadFiles(file_name_list, save_file_name) {
        startFullPageBlockUI()
        const country_id = document.getElementById("country").value

        let zip = new JSZip()

        const request_link = 'http://' + location.host + "/GetCountryById/" + country_id + "/";
        let response = await fetch(request_link).then(response => response.json());
        response = response["country_information"][0]
        const country_folder = response["folder"];
        const country_name = response["name"];

        save_file_name += " مجموعه سند {" + country_name + "}"


        let extension = ".txt"
        if (country_name.includes("فاوا")) {
            extension = '.docx';
        }

        console.log(file_name_list)
        for (const [doc_id, doc_info] of Object.entries(file_name_list)) {

            const document_name = doc_info[0]['name'] + extension

            const path = 'http://' + location.host + '/media/data/' + country_folder + '\\' + document_name;

            await fetch(path)
                .then(res => res.arrayBuffer())
                .then(value => {
                    zip.file(document_name, value);
                })
        }
        zip.generateAsync({
            type: "blob"
        })
            .then(function (content) {
                // see FileSaver.js
                saveAs(content, save_file_name + ".zip");
            });
        stopFullPageBlockUI( 'دانلود اسناد');
    }

    async function DownloadSerachResultFunction() {
        let save_file_name = "واژه‌نامه در"
        save_file_name += " مجموعه سند {" + $('#country option:selected').text() + "}"
        downloadFiles(keywords_information_result, save_file_name)
    }

    async function ExportExcelSerachResultFunction() {
        var csv = "";

        sep = ","


        let Csv = "کلیدواژه" + sep + " سند" + sep + "تعریف کلیدواژه" + sep +
            "\n"


        for (const [keyword, documents_list] of Object.entries(keywords_information_result)) {
            keyword_documents_list = []

            for (doc_info of documents_list) {
                const link = 'http://' + location.host + "/GetKeywordsDefinitionByDocumentId/" + doc_info["id"] + "/" + keyword + "/";
                response = await fetch(link).then(response => response.json());
                response = response['keyword_information']
                paragraph_text = response['croped_text']

                Csv += keyword + sep + doc_info['name'] + sep + paragraph_text + "\n"
            }

        }


        let save_file_name = " واژه‌نامه در"
        save_file_name += " مجموعه سند {" + $('#country option:selected').text() + "}"

        let csvContent = "data:text/csv;charset=utf-8,%EF%BB%BF" + encodeURI(Csv);
        var link = document.createElement("a");
        link.setAttribute("href", csvContent);
        link.setAttribute("download", save_file_name + ".csv");
        document.body.appendChild(link);
        link.click()
    }

    function GetMultiSelectSubjectValue() {
        var e = document.getElementById("SubjectSelect");
        var selected = [...e.options]
            .filter(option => option.selected)
            .map(option => option.value)
        return selected.join("_")
    }




</script>

<script src="../../static/js/zipDownload/jszip.min.js"></script>
<script src="../../static/js/zipDownload/FileSaver.min.js"></script>
<!-- BS Tooltips handler -->
<script src="../../static/js/tooltip_handler.js"></script>
<!-- <script src="../../static/js/UserLogSave.js"></script>-->

<!-- Intro Js -->
<script src="../../static/js/definition/definition_tour.js">
</script>
<script src="../../static/js/tour.js"></script>
<script src="../../static/js/signout_function.js"></script>



<!-- Blocking UI -->
<script src="../../static/js/blockUI.js"></script>
<script src="../../static/js/blockUI_handler.js"></script>
<link rel="stylesheet" href="../../static/styles/loader.css">

</html>