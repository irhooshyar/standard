<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-4.5.2.css">
    <script src="../../static/js/jquery_351/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-5.1.2npm.css">
    <script src="../../static/library/bootstrap-5.1.2.bundle.min.js"></script>

    <!--BS Icons -->
    <link rel="stylesheet" href="../../static/library/bootstrap-icons-1.3.0.css">
    <!-- Fontawesome Icons -->

    <link rel="stylesheet" href="../../static/library/fontawesome-5.10.0.all.css"  />
    <link rel="stylesheet" href="../../static/library/font-awesome.min-4.7.0.css">

    <!-- anychart modules -->
    <script src="../../static/library/anychart-8.10.0-core.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-graph.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-pie.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-exports.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-cartesian.min.js"></script>

    <link rel="stylesheet" type="text/css" href="../../static/library/tom-select-2.2.1.css">
    <script src="../../static/library/tom-select.complete-2.2.1.min.js"></script>
    <script type="text/javascript" src="../../static/js/searchable-select.js"></script>

    <!-- Footable  -->
    <script src="../../static/js/footable/demo-rows.js"></script>
    <script src="../../static/js/footable/ie10-viewport-bug-workaround.js"></script>
    <script src="../../static/js/footable/footable.js"></script>
    <link href="../../static/styles/footable/footable.bootstrap.min.css" rel="stylesheet">
    <link href="../../static/styles/footable/docs.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.Glyphicons.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.FontAwesome.css" rel="stylesheet">
    <link rel="stylesheet" href="../../static/styles/search_chart.css">

    <link rel="stylesheet" href="../../static/styles/index2.css">
    <link rel="stylesheet" href="../../static/styles/vote_analysis.css">

    <!-- Intro Js -->
    <script src="../../static/library/intro.min-4.3.0.js"></script>
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs.min-4.3.0.css">
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs-rtl.min-4.3.0.css">
    <link rel="stylesheet" href="../../static/styles/user_guide_tour.css">

    <!-- Notyf  -->
    <link rel="stylesheet" type="text/css" href="../../static/library/notyf.min-npm.css">
    <script src="../../static/library/notyf.min.js"></script>

    <!--<script type="text/javascript" src="http://l2.io/ip.js?var=myip">
    </script>-->
    <script src="../../static/js/chart.js"></script>

    <meta charset="UTF-8">
    <title>تحلیل آراء</title>
    {% include "doc/title_icon.html" %}
</head>

<body>
    <!-- Menu -->
    <nav dir="rtl" class="navbar nav_menu navbar-expand-lg fixed-top p-0 mt-0">
        {% include "doc/header2.html" %}
    </nav>

    <script>
        $(document).ready(function () {

            // Active panel
            $('#SepecificDropdown').addClass('active');
            $('#votes_analysis').addClass('active');

            $('select#language').on('change', function (e) {

                let selected_language = this.value;
                let current_url = window.location.href;
                if (selected_language === 'England') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'en')
                    window.location = requested_url;
                } else if (selected_language === 'Russia') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'ru')
                    window.location = requested_url;
                }

            });
        });
    </script>

    <div class="row flex-row-reverse px-0 py-5 px-md-5 py-md-5 m-0 mt-4">
        <form id="subject_analysis_form" action="" class="custom-control mx-auto needs-validation"
            enctype="multipart/form-data" method="post" novalidate>

            <div class="row flex-row-reverse mx-auto">

                <!-- Country select -->
                <div class="col-md-6 col-12 col-lg-2 bg-light pt-3  mt-1" dir="rtl">
                    <label for="country" class=" text-right bg-light float-right">مجموعه سند:</label>
                    <select dir="rtl" id="country" name="country" class="form-select text-right float-right searchable-select"
                        onchange="CountryChanged()">
                        {% for k,v in countries.items %}
                        <option value="{{ k }}">{{ v }}</option>
                        {% endfor %}
                    </select>

                </div>

                <!-- select document btn -->
                <div class="col-lg-1 px-0 col-md-2 pt-5 col-12 mt-1">
                    <button id="document_select" disabled="false" type="button" class="btn float-right mx-0"
                        data-bs-toggle="modal" data-bs-target="#SelectDocumentModal">
                        انتخاب رأی
                    </button>
                </div>

            </div>
        </form>


        <ul id="original_tabs" class="nav nav-pills  mt-5 mx-auto  pr-3 pr-sm-0  float-right  d-block" id="pills-tab"
            role="tablist">
            <li class="nav-item float-right" role="presentation">
                <button id="keywords_info_tab" class="nav-link active" data-bs-toggle="pill"
                    data-bs-target="#keywords_info_pane" type="button" role="tab" aria-controls="keywords_info_pane"
                    aria-selected="true">اطلاعات کلیدواژه‌ها</button>
            </li>

            <li class="nav-item float-right" role="presentation">
                <button id="statistics_info_tab" class="nav-link" data-bs-toggle="pill"
                    data-bs-target="#statistics_info_pane" type="button" role="tab" aria-controls="statistics_info_pane"
                    aria-selected="true"> داشبورد آماری</button>
            </li>

            <li class="nav-item float-right" role="presentation">
                <button id="keywords_distribution_tab" class="nav-link" data-bs-toggle="pill"
                    data-bs-target="#keywords_distribution_pane" type="button" role="tab"
                    aria-controls="keywords_distribution_pane" aria-selected="false">توزیع کلیدواژه‌ها</button>
            </li>

            <!-- Download Buttons -->
            <button type="button" data-bs-toggle="tooltip" data-bs-placement="top" title="دانلود اسناد"
                class="btn float-left p-0 px-1 mt-2" id="DownloadBtn" onclick="DownloadSerachResultFunction()"
                type="button">
                <i class="far fa-file-archive m-0" style="font-size: 25px;margin: 0px;"></i>

            </button>

            <button class="btn float-left p-0 px-1 mt-2" id="ExportExcel" data-bs-toggle="tooltip"
                data-bs-placement="top" title="خروجی اکسل" onclick="ExportExcelSerachResultFunction()" type="button">
                <i class="far fa-file-excel text-success m-0" style="font-size: 25px;margin: 0px;"></i>
            </button>
            <p id="AraCount" dir="rtl" class="text-left float-left text-secondary  pl-2"></p>
        </ul>

        <div id="original_pane" class="tab-content float-right px-1" style="position: relative;"
            id="pills-tabContent">

            <!-- Keywords Info Pane -->
            <div id="keywords_info_pane" class="tab-pane w-100 fade show active float-right" role="tabpanel"
                aria-labelledby="keywords_info_tab">

                <h6 class="Keywords_Info_header pr-2">
                    <label class="text-right float-right mt-5">
                        کلیدواژه‌های آراء انتخاب شده:
                    </label>
                </h6>
                <div dir="rtl" class="keywords_info_table">
                    <table class="table table-striped KeywordsTable" style="min-height: 200px;" id="KeywordsTable">
                    </table>
                </div>
            </div>


            <!-- Ara Result Pane -->
            <div id="statistics_info_pane" class="tab-pane w-100 fade float-right" role="tabpanel"
                aria-labelledby="statistics_info_tab">
                <div class="row mt-4 w-100 flex-row-reverse justify-content-around mx-0 px-0">
                    <div id="subject_container" class="half" chart-height="450px"></div>
                    <div id="approval_container" class="half" chart-height="450px"></div>
                    <div id="year_container" class="full" chart-height="850px"></div>
                </div>
            </div>

            <!-- Keywords Pane -->
            <div class="tab-pane w-100 fade float-right" id="keywords_distribution_pane" role="tabpanel"
                aria-labelledby="keywords_distribution_tab">
                <!-- Keywords distribution segment -->
                <div class="row mt-4 w-100 flex-row-reverse justify-content-around mx-0 px-0">
                    <div id="keywords_container" class="full" chart-height="450px"></div>
                </div>
            </div>
        </div>

    </div>
    <!-- Modal Container -->
    <div class="modal fade" id="SelectDocumentModal">
        <div style="max-width: 1200px !important;" class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="ModalHeader" class="modal-title">انتخاب رأی</h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>


                <!-- Modal body -->
                <div id="ModalBody" class="modal-body text-justify">
                    <div class="container">
                        <table id="PopUpTable" class="table table-striped PopUpTable">
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="showResult" onclick="ShowResult()" type="button" class="btn"
                        data-bs-toggle="modal">نمایش</button>
                </div>

            </div>
        </div>
    </div>

    <!-- ChartModal Container -->
    <button type="button" id="ChartModalBtn" class="btn d-none modal_btn" data-bs-toggle="modal"
        data-bs-target="#ChartModal"></button>
    <div class="modal fade" id="ChartModal">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="ChartModalHeader" class="modal-title">عنوان</h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div id="ChartModalText" class="modal-body text-justify">
                </div>

                <!-- Modal footer -->


                <!-- Modal footer -->
                <div dir="rtl" class="modal-footer">
                    <button id="DownloadDocuments" class="btn btn-primary"><i class="fa fa-download"></i> دانلود
                        اسناد</button>

                    <button id="ExportExcel2" class="btn btn-primary"><i class="fa fa-download"></i> خروجی اکسل</button>
                </div>

            </div>
        </div>
    </div>
    <!-- Scrollbar -->
    <button id="scroll_btn" class="p-0" title="بالای صفحه" onclick="topFunction()">
        <i class="far fa-caret-square-up"></i>
    </button>

    <script src="../../static/js/logincheck.js"></script>

    <script src="../../static/js/scroll_button_handler.js"></script>


    <!-- Blocking UI -->
    <script src="../../static/js/blockUI.js"></script>
    <script src="../../static/js/blockUI_handler.js"></script>
    <link rel="stylesheet" href="../../static/styles/loader.css">

</body>

<!-- save log user -->
<script>
    async function UserLog(form_data) {
        if (getCookie("username") !== "") {
            const user_name = getCookie("username")
            let page_url = window.location.pathname
            const user_ip = "127.0.0.0"
            page_url = page_url.slice(0, -1);
            if (page_url === "") {
                page_url = "/0";
            }


            let link_request = 'http://' + location.host + "/UserLogSaved/" + user_name + page_url + "/" + user_ip + "/";

            $.ajax({
                url: link_request,
                data: form_data,
                type: 'POST',
                contentType: false,
                processData: false,
                async: true,


            }).done(function (res) {
                console.log("done")

            }).fail(function (res) {
                console.log("fail")
            });

        }
    }
</script>

<script>


    class allChartsData {

        subject_chart_data;
        approval_references_chart_data;
        level_chart_data;
        approval_year_chart_data;
        keywords_chart_data;


        constructor() {
            this.subject_chart_data = [];
            this.approval_references_chart_data = [];
            this.level_chart_data = [];
            this.approval_year_chart_data = [];
            this.keywords_chart_data = [];
        }

        getChartData(chart_name) {
            if (chart_name == 'subject_chart_data') {
                return this.subject_chart_data;

            }
            if (chart_name == 'approval_references_chart_data') {
                return this.approval_references_chart_data;

            }
            if (chart_name == 'level_chart_data') {
                return this.level_chart_data;

            }
            if (chart_name == 'approval_year_chart_data') {
                return this.approval_year_chart_data;

            }
            if (chart_name == 'keywords_chart_data') {
                return this.keywords_chart_data;

            }
        }

        setChartData(chart_name, chart_value) {
            if (chart_name == 'subject_chart_data') {
                this.subject_chart_data = chart_value
            }
            if (chart_name == 'approval_references_chart_data') {
                this.approval_references_chart_data = chart_value
            }
            if (chart_name == 'level_chart_data') {
                this.level_chart_data = chart_value
            }
            if (chart_name == 'approval_year_chart_data') {
                this.approval_year_chart_data = chart_value
            }
            if (chart_name == 'keywords_chart_data') {
                this.keywords_chart_data = chart_value
            }

        }

    }



    let selectedAra = [];
    let searchResultValue = [];
    let jsonTable = []


    all_charts_data = new allChartsData();


    const subject_container = 'subject_container';
    const level_container = 'level_container';
    const year_container = 'year_container';
    const approval_container = 'approval_container';
    const keywords_container = 'keywords_container';

    async function init() {
        initSearchableSelects();
        CountryChanged();

        //user log
        let form_data = new FormData()
        let detail_type = "نمایش پنل"
        form_data.append('detail_type', detail_type);
        UserLog(form_data)
    }



    init();


    function clearPrevResults(container_id_list) {

        for (container_id of container_id_list) {
            document.getElementById(container_id).innerHTML = "";
        }
    }


    async function CountryChanged() {
        const country_id = document.getElementById("country").value;
        const country_name = $('#country option:selected').text();
        /* Clear Previous results */

        selectedAra = []
        container_id_list = ['PopUpTable', 'KeywordsTable', 'AraCount']
        clearPrevResults(container_id_list);
        notyf.dismissAll();

        /* --------------------------------------- */

        updateModal(country_id);
        showAllCharts(country_id,country_name);

        //user log
        let form_data = new FormData()
        let detail_type = "نتایج جست و جو"
        let country_name_select = country_name
        form_data.append('detail_type', detail_type);
        form_data.append('country_name_select', country_name_select);
        UserLog(form_data)

    }

    async function updateModal(country_id) {
        document.getElementById('document_select').disabled = true;

        startBlockUI('PopUpTable');
        startBlockUI('KeywordsTable');


        const request_link = 'http://' + location.host + "/GetAraByCountry_id/" + country_id + "/"

        const response = await fetch(request_link).then(response => response.json());

        let documentsList = response["documents_information_list"]


        jsonTable = documentsList;

        document.getElementById("AraCount").innerText = (documentsList.length).toString() + " رأی یافت شد";
        $('#PopUpTable').empty();

        $('.PopUpTable').footable({
            "paging": {
                "enabled": true,
                strings: {
                         first: '»',
                         prev:'›',
                         next: '‹',
                         last: '«'
                     }
            },
            "filtering": {
                "enabled": true
            },
            "sorting": {
                "enabled": true
            },
            "empty": "سندی یافت نشد.",
            "columns": [{
                "name": "id",
                "title": "ردیف",
                "breakpoints": "xs sm",
                "type": "number",
                "style": {
                    "width": "5%"
                }
            }, {
                "name": "document_tag",
                "title": "عنوان رای",
                "style": {
                    "width": "20%"
                }
            }, {
                "name": "document_subject",
                "title": "موضوع رای",
                "style": {
                    "width": "15%"
                }
            }, {
                "name": "document_approval_date",
                "title": "سال صدور رای",
                "style": {
                    "width": "10%"
                }
            }, {
                "name": "document_approval_reference",
                "title": "مرجع صدور رای",
                "style": {
                    "width": "15%"
                }
            }, {
                "name": "checkbox",
                "title": "انتخاب",
                "style": {
                    "width": "10%"
                }
            },],
            "rows": documentsList
        });

        stopBlockUI('PopUpTable', 'انتخاب رأی');

        document.getElementById('document_select').disabled = false;

        /* Show Keywords Table */
        showKeywordsTable(jsonTable);

        stopBlockUI('KeywordsTable', 'اطلاعات کلیدواژه‌ها');


    }


    async function showKeywordsTable(documents_information_result) {

        searchResultValue = documents_information_result;
        document.getElementById("KeywordsTable").innerHTML = "";

        $('#KeywordsTable').empty();
        $('.KeywordsTable').footable({
            "paging": {
                "enabled": true,
                strings: {
                         first: '»',
                         prev:'›',
                         next: '‹',
                         last: '«'
                     }
            },
            "filtering": {
                "enabled": false
            },
            "sorting": {
                "enabled": true
            },
            "empty": "سندی یافت نشد.",
            "columns": [{
                "name": "id",
                "title": "ردیف",
                "breakpoints": "xs sm",
                "type": "number",
                "style": {
                    "width": "5%"
                }
            }, {
                "name": "document_tag",
                "title": "نام سند",
                "style": {
                    "width": "35%"
                }
            }, {
                "name": "document_subject",
                "title": "موضوع",
                "style": {
                    "width": "15%"
                }
            }, {
                "name": "document_approval_reference",
                "title": "مرجع تصویب",
                "style": {
                    "width": "15%"
                }
            }, {
                "name": "document_approval_date",
                "title": "تاریخ تصویب",
                "style": {
                    "width": "15%"
                }
            }, {
                "name": "document_keywords",
                "title": "کلیدواژه ها",
                "style": {
                    "width": "15%"
                }
            }, {
                "name": "keywords_count",
                "title": "تعداد کلیدواژه ها",
                "style": {
                    "width": "5%"
                },
                "sorted": true,
                "direction": "DESC",
            }
            ],
            "rows": documents_information_result
        });

    }


    async function showAllCharts(country_id,country_name) {
        startBlockUI('statistics_info_pane');


        let request_link = 'http://' + location.host + "/GetAraChartsData_ByCountryId/" + country_id + "/"

        let response = await fetch(request_link).then(response => response.json());

        /* Show Chart  */
        subject_chart_data = response["subject_chart_data"]
        approval_references_chart_data = response["approval_references_chart_data"]
        level_chart_data = response["level_chart_data"]
        approval_year_chart_data = response["approval_year_chart_data"]
        keywords_chart_data = response["keywords_chart_data"]


        showChartData(subject_chart_data, subject_container, false,country_name, 'موضوع', 'توزیع موضوعی آرا')
        showChartData(approval_year_chart_data, year_container, true, country_name, 'سال صدور', 'توزیع آرا بر اساس سال صدور')
        showChartData(approval_references_chart_data, approval_container, false, country_name, 'مرجع صدور', 'توزیع آرا بر اساس مرجع صدور')
        showChartData(keywords_chart_data, keywords_container, false, country_name, 'کلیدواژه', 'توزیع آرا بر اساس کلیدواژه‌ها')

        stopBlockUI('statistics_info_pane', 'داشبورد آماری');

    }


    async function ShowResult() {
        const country_name = $('#country option:selected').text()

        container_id_list = ['KeywordsTable', 'AraCount']

        clearPrevResults(container_id_list);
        notyf.dismissAll();

        startBlockUI('KeywordsTable');
        startBlockUI('statistics_info_pane');
        startBlockUI('keywords_distribution_pane');

        documents_id = selectedAra.toString()
        document.getElementById("AraCount").innerText = (selectedAra.length).toString() + " رأی انتخاب شد";

        /* Show Keywords Table */
        showKeywordsTable(selectedAra);
        stopBlockUI('KeywordsTable', 'اطلاعات کلیدواژه‌ها');


        updateChartData(selectedAra, 'document_subject', subject_container, false,country_name, 'موضوع');
        updateChartData(selectedAra, 'document_approval_reference', approval_container, false,country_name, 'مرجع صدور');
        updateChartData(selectedAra, 'document_approval_date', year_container, true,country_name, 'سال صدور');
        stopBlockUI('statistics_info_pane', 'داشبورد آماری');


        updateChartData(selectedAra, 'document_keywords', keywords_container, false,country_name);
        stopBlockUI('keywords_distribution_pane', 'توزیع کلیدواژه‌ها');

        //user log
        let form_data = new FormData()
        let detail_type = "نتایج جست و جو"
        let country_name_select = country_name
        form_data.append('detail_type', detail_type);
        form_data.append('country_name_select', country_name_select);
        UserLog(form_data)
        

    }


    async function updateChartData(selectedAra, table_col, chart_container, keySort,country_name, xAxisTitle) {

        chart_dict = {}
        chart_data = []

        if (chart_container == year_container) {


            for (let doc of selectedAra) {
                date_field = doc[table_col]
                year_field = 'نامشخص';

                if (date_field != 'نامشخص') {
                    year_field = date_field.split('/')[0]

                }
                if (!Object.keys(chart_dict).includes(year_field)) {
                    chart_dict[year_field] = 1;

                } else {
                    chart_dict[year_field] += 1;
                }
            }

        }

        else if (chart_container == keywords_container) {

            for (let doc of selectedAra) {
                doc_keywords = doc[table_col]
                doc_keywords = doc_keywords.split(' - ');

                for (kw of doc_keywords) {

                    if (!Object.keys(chart_dict).includes(kw)) {
                        chart_dict[kw] = 1;

                    } else {
                        chart_dict[kw] += 1;
                    }

                }

            }

        } else {

            for (let doc of selectedAra) {
                doc_field = doc[table_col]

                if (!Object.keys(chart_dict).includes(doc_field)) {
                    chart_dict[doc_field] = 1;

                } else {
                    chart_dict[doc_field] += 1;
                }
            }


        }

        // standard chart data
        for (const [filed_name, count] of Object.entries(chart_dict)) {
            chart_data.push([filed_name, count]);
        }

        showChart(chart_data, chart_container, keySort,country_name, xAxisTitle);
    }


    async function SelectDocumentFunction(document) {

        doc_id = document.value;


        if (document.checked) {

            selected_doc = jsonTable.filter(function (value, index, jsonTable) {
                return value['document_id'] == doc_id;
            })[0];

            selectedAra.push(selected_doc);

        } else {
            selectedAra = selectedAra.filter(function (value, index, selectedAra) {
                return value['document_id'] != document.value;
            });
        }



    }

    function showChartData(chart_data, container, keySort,country_name, xAxisTitle, title) {

        if (chart_data.length === 0) {
            document.getElementById(container).innerHTML = "<span class='d-block text-center' style='color: dodgerblue'><i class=\"fa fa-ban\" aria-hidden=\"true\"></i> هیچ سندی یافت نشد</span>";
        } else {
            showChart(chart_data, container, keySort,country_name, xAxisTitle, title)
        }
    }

    function showChart(data, container, keySort, country_name, xAxisTitle, title) {
        const options = {
            data,
            keySort,
            title,
            onclick: async function (event, data) {
            const click_tag = event.domTarget.tag;
            const index = click_tag["index"]
            const text = data.row(index)[0];
            let filtered_result = []
            let header = ""
            let save_file_name = 'آراء';

            if (position.includes("subject_container")) {
                filtered_result = searchResultValue.filter(function (row) {
                    if (row["document_subject"] === text)
                        return row
                });
                header = "موضوع: " + text
                save_file_name += " (مجموعه سند {1} و موضوع {2})".replace("1", country_name).replace("2", text)
            } else if (position.includes("approval_container")) {
                filtered_result = searchResultValue.filter(function (row) {
                    if (row["document_approval_reference"] === text)
                        return row
                });
                header = "مرجع تصویب: " + text
                save_file_name += " (مجموعه سند {1} و مرجع تصویب {2})".replace("1", country_name).replace("2", text)
            } else if (position.includes("level_container")) {
                filtered_result = searchResultValue.filter(function (row) {
                    if (row["document_level"] === text)
                        return row
                });
                header = "سطح سند: " + text
                save_file_name += " (مجموعه سند {1} و سطح سند {2})".replace("1", country_name).replace("2", text)
            } else if (position.includes("year_container")) {
                filtered_result = searchResultValue.filter(function (row) {
                    if (row["document_approval_date"].substring(0, 4) === text.toString() || row["document_approval_date"] === text.toString())
                        return row
                });
                header = "سال تصویب: " + text
                save_file_name += " (مجموعه سند {1} و سال تصویب {2})".replace("1", country_name).replace("2", text)
            } else if (position.includes("keywords_container")) {
                filtered_result = searchResultValue.filter(function (row) {
                    if (row["document_keywords"].includes(text))
                        return row
                });
                header = "کلیدواژه: " + text
                save_file_name += " (مجموعه سند {1} و کلیدواژه {2})".replace("1", country_name).replace("2", text)

            }

            document.getElementById("ChartModalHeader").innerText = header
            let filtered_result_tag = ""
            let list_of_docId = ""
            for (const doc of filtered_result) {

                let tag = "<li class='mt-3' id=" + doc["document_id"] + ">" + doc['document_tag'] + "</li>"
                filtered_result_tag += tag

            }
            filtered_result_tag = "<ol start='1'>" + filtered_result_tag + "</ol>"
            document.getElementById("ChartModalText").innerHTML = filtered_result_tag


            /* download file creation*/
            document.getElementById("DownloadDocuments").onclick = function () {
                downloadFiles(filtered_result, save_file_name);
            };
            /* export into excel files */
            document.getElementById("ExportExcel2").onclick = async function ExportExcelFunction() {

                var csv = "";

                sep = ","
                let Csv = "نام سند" + sep + "سطح سند" + sep +
                    "موضوع سند" + sep + "نوع سند" + sep + "مرجع تصویب" + sep + "تاریخ تصویب" + "\n"
                for (let document of filtered_result) {

                    Csv += document["document_name"] + sep + document["document_level"] + sep + document["document_subject"] + sep +
                        document["document_type"] + sep + document["document_approval_reference"] + sep + document["document_approval_date"] + "\n"

                }

                let csvContent = "data:text/csv;charset=utf-8,%EF%BB%BF" + encodeURI(Csv);
                var link = document.createElement("a");
                link.setAttribute("href", csvContent);
                link.setAttribute("download", save_file_name + ".csv");
                document.body.appendChild(link);
                link.click()
            };

            $("#ChartModalBtn").click();


        }
        }
        if (container === "subject_container" || container === "approval_container")
            newDoughnutChart(container, options);
        else
            newBarChart(container, options);
    }


</script>
<script src="../../static/js/zipDownload/jszip.min.js"></script>
<script src="../../static/js/zipDownload/FileSaver.min.js"></script>

<!-- Export results -->
<script>

    async function downloadFiles(file_name_list, save_file_name) {
        startFullPageBlockUI()
        const country_id = document.getElementById("country").value

        let zip = new JSZip()

        const request_link = 'http://' + location.host + "/GetCountryById/" + country_id + "/";
        let response = await fetch(request_link).then(response => response.json());
        response = response["country_information"][0]
        const country_folder = response["folder"];
        const country_name = response["name"];

        save_file_name += " مجموعه سند {" + country_name + "}"


        let extension = ".txt"
        if (country_name.includes("فاوا")) {
            extension = '.docx';
        }


        for (const document of file_name_list) {
            const document_name = document['document_name'] + extension

            const path = 'http://' + location.host + '/media/data/' + country_folder + '\\' + document_name;

            await fetch(path)
                .then(res => res.arrayBuffer())
                .then(value => {
                    zip.file(document_name, value);
                })
        }
        zip.generateAsync({
            type: "blob"
        })
            .then(function (content) {
                // see FileSaver.js
                saveAs(content, save_file_name + ".zip");
            });
        stopFullPageBlockUI('دانلود اسناد');
    }

    async function DownloadSerachResultFunction() {
        const save_file_name = " آرای موجود در"
        downloadFiles(searchResultValue, save_file_name)
    }

    async function ExportExcelSerachResultFunction() {
        var csv = "";

        sep = ","


        let Csv = "نام سند" + sep +
            "موضوع سند" + sep + "مرجع تصویب" + sep + "تاریخ تصویب" + sep + "کلیدواژه ها" + sep + "تعداد کلیدواژه ها" + "\n"
        for (const document of searchResultValue) {
            Csv += document["document_name"] + sep + document["document_subject"] + sep +
                document["document_approval_reference"] + sep + document["document_approval_date"] + sep +
                document["document_keywords"] + sep + document["keywords_count"] + "\n"

        }

        let save_file_name = " آرای موجود در"
        save_file_name += " مجموعه سند {" + $('#country option:selected').text() + "}"

        let csvContent = "data:text/csv;charset=utf-8,%EF%BB%BF" + encodeURI(Csv);
        var link = document.createElement("a");
        link.setAttribute("href", csvContent);
        link.setAttribute("download", save_file_name + ".csv");
        document.body.appendChild(link);
        link.click()
    }

</script>

<!-- BS Tooltips handler -->
<script src="../../static/js/tooltip_handler.js"></script>

<!-- Intro Js -->
<script src="../../static/js/vote_analysis/vote_analysis_tour.js">
</script>
<script src="../../static/js/tour.js"></script>
<!-- <script src="../../static/js/UserLogSave.js"></script>-->
<script src="../../static/js/signout_function.js"></script>




</html>