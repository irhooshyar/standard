<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-4.5.2.css">
    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-5.1.2npm.css">

    <script src="../../static/js/jquery_351/jquery.min.js"></script>
    <script src="../../static/library/bootstrap-5.1.2.bundle.min.js"></script>

    <!--BS Icons -->
    <link rel="stylesheet" href="../../static/library/bootstrap-icons-1.3.0.css">
    <!-- Fontawesome Icons -->

    <link rel="stylesheet" href="../../static/library/fontawesome-5.10.0.all.css"  />
    <link rel="stylesheet" href="../../static/library/font-awesome.min-4.7.0.css">


    <!-- anychart modules -->
    <script src="../../static/library/anychart-8.10.0-core.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-graph.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-pie.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-exports.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-cartesian.min.js"></script>


    <!-- Multi Select  -->
    <link rel="stylesheet" type="text/css" href="../../static/styles/multiselect/multiselect-style.css">
    <script type="text/javascript" src="../../static/js/multiselect/jquery.multi-select.js"></script>

    <!-- Footable  -->
    <script src="../../static/js/footable/demo-rows.js"></script>
    <script src="../../static/js/footable/ie10-viewport-bug-workaround.js"></script>
    <script src="../../static/js/footable/footable.js"></script>
    <link href="../../static/styles/footable/footable.bootstrap.min.css" rel="stylesheet">
    <link href="../../static/styles/footable/docs.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.Glyphicons.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.FontAwesome.css" rel="stylesheet">
    <link rel="stylesheet" href="../../static/styles/search_chart.css">
    <!-- Download Zip Files -->
    <script src="../../static/js/zipDownload/jszip.min.js"></script>
    <script src="../../static/js/zipDownload/FileSaver.min.js"></script>

    <link rel="stylesheet" href="../../static/styles/index2.css">
    <link rel="stylesheet" href="../../static/styles/adaptation.css">

    <link rel="stylesheet" type="text/css" href="../../static/library/jquerysctipttop.css">

    <!-- Intro Js -->
    <script src="../../static/library/intro.min-4.3.0.js"></script>
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs.min-4.3.0.css">
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs-rtl.min-4.3.0.css">
    <link rel="stylesheet" href="../../static/styles/user_guide_tour.css">

    <!-- Notyf  -->
    <link rel="stylesheet" type="text/css" href="../../static/library/notyf.min-npm.css">
    <script src="../../static/library/notyf.min.js"></script>

    <!--<script type="text/javascript" src="http://l2.io/ip.js?var=myip">
    </script>-->

    <script src="../../static/library/g6.min-4.3.11.js"></script>

    <script src="../../static/library/jquery.min-2.2.2.js"></script>
    <script src="../../static/library/jquery-ui.min-1.11.4.js"></script>


    <meta charset="UTF-8">
    <title>تحلیل کلان حوزه‌ها</title>
    {% include "doc/title_icon.html" %}

    <style>
        #modal_dialog {
            max-height: 100vh !important;
        }
    </style>
</head>

<body>


    <!-- Menu -->
    <nav dir="rtl" class="navbar nav_menu navbar-expand-lg fixed-top p-0 mt-0">
        {% include "doc/header2.html" %}
    </nav>
    <script>
        $(document).ready(function () {

            // Active panel
            $('#SepecificDropdown').addClass('active');
            $('#document_subject_area').addClass('active');

            $('select#language').on('change', function (e) {

                let selected_language = this.value;
                let current_url = window.location.href;
                if (selected_language === 'England') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'en')
                    window.location = requested_url;
                } else if (selected_language === 'Russia') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'ru')
                    window.location = requested_url;
                }

            });
        });
    </script>
    <!-- Main Container includes: Form Fields, Tab Pills, Tab Panes -->
    <div class="row flex-row-reverse px-0 py-5 px-md-5 py-md-5 m-0 mt-4">
        <!-- Form Fields -->
        <form action="" class="custom-control mx-auto needs-validation" id="info_form" enctype="multipart/form-data"
            method="post" novalidate>
            <!-- Primary Fields in First Row -->
            <div class="row flex-row-reverse mt-2 mx-auto">
                <!-- Country Input -->
                <div class="col-md-6  pt-3 col-12 col-lg-2 bg-light">
                    <label class=" text-right bg-light float-right" style="direction: rtl;;">مجموعه سند:</label>
                    <select dir="rtl" id="country" name="country" class="form-select text-right float-right"
                        style="direction: rtl;" onchange="CountryChanged()">
                        {% for k,v in countries.items %}
                        <option value="{{ k }}">{{ v }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!--  Buttons -->
                <div class="col-lg-4 col-md-6 pt-5 col-12">
                    <button type="button" id="document_search" onclick="ShowResult()"
                        class="btn d-flex float-right mr-4">
                        <div class="spinner-border text-light" role="status">
                            <span class="sr-only">درحال جستجو ...</span>
                        </div>
                        نمایش
                    </button>
                </div>

                <!-- Advanced Fields in Second Row -->
                <div id="advanced_fields" class="collapse show row flex-row-reverse mx-auto mt-4">                    
                    <!-- Actor Category-->
                    <div class="col-md-6 pt-3 col-12 col-lg-4 bg-light">

                        <label class=" text-right bg-light float-right" style="direction: rtl;;">
                            حوزه موضوعی سند:
                        </label>

                        <select id="SubjectAreaSelect" onchange="AreaChanged()" class="form-select text-right float-right"
                            style="direction: rtl;">
                        </select>

                    </div>

                    <!-- Actor -->
                    <div class="col-md-6 pt-3 col-12 col-lg-4 bg-light ActorSelect" id="multipleSelectDiv">

                        <label class=" text-right bg-light float-right" style="direction: rtl;;">
                            زیرحوزه موضوعی سند:
                        </label>

                        <select id="SubjectSubAreaSelect" class="form-select text-right float-right" style="direction: rtl;"
                            multiple>
                        </select>

                    </div>


                    <!-- Validation input -->
                    <div class="col-md-6 pt-3 col-12 col-lg-4 bg-light">

                        <label class=" text-right bg-light float-right" style="direction: rtl;;">اعتبار سند:</label>
                        <select id="ValidationSelect" class="form-select text-right float-right" style="direction: rtl;" onchange="ChangeValidationSelect()">

                            <option value="0">همه</option>
                            <option value="معتبر">معتبر</option>
                            <option value="منسوخ">منسوخ</option>
                            <option value="ابطال">ابطال</option>
                            <option value="منقضی">منقضی</option>

                        </select>
                    </div>
                </div>
               <!-- Advanced Fields in Third Row -->
               <div id="advanced_fields_2" class="collapse row flex-row-reverse mx-auto mt-4">                    
                    <!-- Revoked Size Select -->
                    <div class="col-md-6 pt-3 col-12 col-lg-4 bg-light">

                        <label class=" text-right bg-light float-right" style="direction: rtl;;">جزئی / کلی:</label>
                        <select id="RevokedSizeSelect" class="form-select text-right float-right" style="direction: rtl;">
                            <option value="0">همه</option>
                            <option value="جزئی">جزئی</option>
                            <option value="کلی">کلی</option>
                        </select>

                    </div>

                    <!-- Sub Type Select -->
                    <div class="col-md-6 pt-3 col-12 col-lg-4 bg-light">

                        <label class=" text-right bg-light float-right" style="direction: rtl;;">صریح / ضمنی:</label>

                        <select id="SubTypeSelect" class="form-select text-right float-right" style="direction: rtl;">
                            <option value="0">همه</option>
                            <option value="صریح">صریح</option>
                            <option value="ضمنی">ضمنی</option>
                        </select>

                    </div>
                </div>
            </div>

        </form>

        <div dir="rtl" class="row w-100 p-0">
            <!--Original Tabs -->
            <ul id="original_tabs" class="nav nav-pills mt-5 mx-auto  pr-3 pr-sm-0  float-right  d-block" id="pills-tab"
                role="tablist">

                <li class="nav-item float-right" role="presentation">
                    <button id="search_result_tab" class="nav-link active" data-bs-toggle="pill"
                        data-bs-target="#search_result_pane" type="button" role="tab" aria-controls="search_result_pane"
                        aria-selected="true">نتایج جست‌وجو</button>
                </li>

                <li class="nav-item float-right" role="presentation">
                    <button id="bar_chart_info_tab" class="nav-link" data-bs-toggle="pill"
                        data-bs-target="#bar_chart_info_pane" type="button" role="tab"
                        aria-controls="bar_chart_info_pane" aria-selected="false">داشبورد آماری</button>
                </li>

                <li class="nav-item float-right" role="presentation">
                    <button id="graph_tab" class="nav-link" data-bs-toggle="pill" data-bs-target="#graph_pane"
                        type="button" role="tab" aria-controls="graph_pane" aria-selected="false">گراف ارجاعات</button>
                </li>

                <!-- Download Buttons -->
                <button disabled type="button" data-bs-toggle="tooltip" data-bs-placement="top" title="دانلود اسناد"
                    class="btn float-left p-0 px-1 mt-2" id="DownloadBtn" onclick="DownloadSerachResultFunction()"
                    type="button">
                    <i class="far fa-file-archive m-0" style="font-size: 25px;margin: 0px;"></i>

                </button>

                <button disabled class="btn float-left p-0 px-1 mt-2" id="ExportExcel" data-bs-toggle="tooltip"
                    data-bs-placement="top" title="خروجی اکسل" onclick="ExportExcelSerachResultFunction()"
                    type="button">
                    <i class="far fa-file-excel text-success m-0" style="font-size: 25px;margin: 0px;"></i>
                </button>
                <!-- Result Count -->
                <p id="DocumentCount" dir="rtl" class="text-left float-left text-secondary  pl-2"></p>

            </ul>

            <!-- Original Panes -->
            <div id="original_pane" class="tab-content float-right px-1 bg-white" id="pills-tabContent">

                <!-- Search Result Pane -->
                <div id="search_result_pane" class="tab-pane w-100 fade show active float-right" role="tabpanel"
                    aria-labelledby="search_result_tab">

                    <!-- Search Result table -->
                    <div class="table-responsive search_result_table mt-4">
                        <table class="table table-striped SearchTable" style="min-height: 200px;" id="SearchTable">
                        </table>
                    </div>

                </div>

                <!-- Bar chart Info Pane -->
                <div dir="rtl" style="min-height: 200px;" class="tab-pane fade float-right w-100"
                    id="bar_chart_info_pane" role="tabpanel" aria-labelledby="bar_chart_info_tab">

                    <div class="row mt-4 w-100 flex-row-reverse mx-0 px-0">
                        <div class="col-md-4 px-4 col-12 col-lg-12 p-3 border">
                            <!-- Document Subject  segment -->
                            <h5 class="document_subject w-100 mt-4 text-center float-right pt-3 pb-3">
                                زیرحوزه اسناد
                            </h5>
                            <br>
                            <div style="margin-left: 1px !important;" id="subject_container"
                                class="bg-white w-100 mx-auto py-4 px-1 border border-2 pb-2 vertical">
                            </div>
                        </div>
                        <div class="col-md-4 px-4 col-12 col-lg-12 p-3 border">
                            <!-- Document Level segment -->
                            <h5 class="document_level w-100 mt-4 text-center float-right pt-3 pb-3">
                                سطح اسناد
                            </h5>
                            <br>
                            <div id="level_container"
                                class="bg-white w-100 mx-auto py-4 px-1 border border-2 pb-2 vertical">
                            </div>
                        </div>
                        <div class="col-md-4 px-4 col-12 col-lg-12 p-3 border">
                            <!-- Document Level segment -->
                            <h5 class="document_level w-100 mt-4 text-center float-right pt-3 pb-3">
                                سال تصویب اسناد
                            </h5>
                            <br>
                            <div id="year_container"
                                class="bg-white w-100 mx-auto py-4 px-1 border border-2 pb-2 vertical">
                            </div>
                        </div>
                        <div class="col-md-4 px-4 col-12 col-lg-12 p-3 border">
                            <!-- Extracted References segment -->
                            <h5 class="extractected_references w-100 mt-4 text-center float-right pt-3 pb-3">
                                مراجع تصویب اسناد
                            </h5>
                            <br>
                            <div id="approval_container"
                                class="bg-white w-100 mx-auto py-4 px-1 border border-2 pb-2 vertical">
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Graph Pane -->

                <div dir="rtl" style="min-height: 200px;" class="tab-pane fade float-right w-100" id="graph_pane"
                    role="tabpanel" aria-labelledby="graph_tab">
                    <div class="row mt-4 w-100 flex-row-reverse mx-auto pb-5 px-4">
                        <!-- doc colors -->
                        <div dir="rtl" id="ColorBox" class="w-100 text-right" style="display: inline-flex">
                        </div>

                        <div id="constraints_container"
                            class="collapse show constraints_container row flex-row-reverse pt-0 mb-0 mt-0 mx-auto">

                            <div id="DegreeDiv" class="col-md-3 p-1 col-12 col-lg-6 mt-1">
                                <div class="source_header bg-white row mx-auto p-1">
                                    <label class="text-center my-0" style="direction: rtl;">فیلتر درجه</label>
                                </div>
                                <div class="source_container pb-2 row mx-auto">
                                    <div dir="rtl" class="wrapper mt-5 mb-1" id="RangeSlider"
                                        style="visibility: hidden;">
                                        <div class="container" style="display: flex; justify-content: center;">
                                            <div class="slider-wrapper">
                                                <div dir="ltr" id="slider-range"></div>
                                                <div dir="rtl"
                                                    style="display:flex; width: 300px; justify-content: center"
                                                    class="range-wrapper">
                                                    <div dir="ltr" class="range mt-1"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="WeightDiv" class="col-md-3 p-1 col-12 col-lg-6 mt-1">
                                <div class="source_header bg-white row mx-auto p-1">
                                    <label class="text-center my-0" style="direction: rtl;">فیلتر وزن</label>
                                </div>
                                <div class="source_container pb-2 row mx-auto">
                                    <div dir="rtl" class="wrapper mt-5 mb-1" id="WeightSlider"
                                        style="visibility: hidden;">
                                        <div class="container" style="display: flex; justify-content: center;">
                                            <div class="slider-wrapper">
                                                <div dir="ltr" id="slider-range"></div>
                                                <div dir="rtl"
                                                    style="display:flex; width: 300px; justify-content: center"
                                                    class="range-wrapper">
                                                    <div dir="ltr" class="range mt-1"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div dir="ltr">
                            <img style="width: 4%; cursor: pointer" src="../../static/image/neighbourhood.png"
                                onclick="SelectNeighbourhood()">
                            <img style="width: 3%; cursor: pointer" id="ShowHideImg"
                                src="../../static/image/hide_nodes.png" onclick="ShowHideNode()">
                        </div>

                        <select id="ChangeLayout" name="ChangeLayout" onchange="ChangeLayout()"
                            class="form-select text-right float-right" style="direction: rtl;">
                            <option value="grid">مربعی</option>
                            <option value="circular"> دایره ای </option>
                            <option value="force">ساده</option>
                            <option value="dagre">بالا به پایین</option>
                            <option value="radial">شعاعی</option>
                            <option value="concentric">متحدالمرکز</option>
                            <option value="comboForce">خوشه ای</option>
                        </select>

                        <script src="../../static/js/graph/color_picker_handler.js">
                        </script>

                        <div id="advanced_graph_container" class="border mt-1" style="height:500px; overflow: hidden">
                        </div>

                        <div dir="rtl" style="display: flex; margin-bottom: 50px;">
                            <div class="col-md-6 px-0 col-12 col-lg-5 pt-1">
                                <h6 class="table_header text-center  p-2  mb-0">
                                    گره های انتخاب شده
                                </h6>
                                <table id="selected_node_table" class="table table-striped PopUpTable"
                                    style="width: 95%;margin: auto;">

                                </table>
                            </div>

                            <div class="col-md-6 px-0 col-12 col-lg-7 pt-1">
                                <h6 class="table_header text-center  p-2  mb-0">
                                    یال های انتخاب شده
                                </h6>
                                <table id="selected_edge_table" class="table table-striped PopUpTable"
                                    style="width: 95%;margin: auto;">

                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Modal Container -->
    <div class="modal fade" id="detailModal">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="ModalHeader" class="modal-title">عنوان</h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div id="DetailText" class="modal-body text-justify">
                </div>

                <!-- Modal footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
                </div>

            </div>
        </div>
    </div>
    <!-- Modal Container -->
    <div class="modal fade" id="myGraph">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="ShowGraphHeader" class="modal-title">عنوان</h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div id="ShowGraph" class="modal-body bg-light text-justify">
                </div>

                <div id="ShowParagraph" class="modal-body bg-light text-justify">
                </div>

                <!-- Modal footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
                </div>

            </div>
        </div>
    </div>



    <!-- Scrollbar -->
    <button id="scroll_btn" class="p-0" title="بالای صفحه" onclick="topFunction()">
        <i class="far fa-caret-square-up"></i>
    </button>

    <script src="../../static/js/logincheck.js"></script>

    <script src="../../static/js/scroll_button_handler.js">
    </script>

</body>



<script>

    let graph_object;
    let data_graph;
    let min_selected_degree;
    let max_selected_degree;
    let min_selected_weight;
    let max_selected_weight;
    let show_hide_state = "show"

    container_id_list = ['SearchTable', 'DocumentCount']
    collective_pattern_keywords = ['متشکل از', 'مرکب از', 'متشکل‌از', 'مرکب‌از']

    function clearPrevResults(container_id_list) {

        for (container_id of container_id_list) {
            document.getElementById(container_id).innerHTML = "";
        }
    }

    let SearchResultValue = []
    let ActorsList = []
    let ActorsDict = []
    let subject_area_dict = {}

    async function init() {
        const country_id = document.getElementById("country").value


        let request_link = 'http://' + location.host + "/GetSearchParameters/" + country_id + "/";
        let response = await fetch(request_link).then(response => response.json());
        subject_area_dict = response["subject_area"]

        /****************** Subject Area List ****************************/
        let subject_areas = Object.keys(subject_area_dict);
        let options = "";
        for (let sub_area of subject_areas) {
            let sub_area_splinted = sub_area.split('#')
            options += "<option value=" + sub_area_splinted[0] + " >" + sub_area_splinted[1] + "</option>";
        }
        document.getElementById("SubjectAreaSelect").innerHTML = options;
        /****************** Subject Sub Area List ****************************/
        
        AreaChanged()

        $('#SubjectSubAreaSelect').multiSelect();



    }

    init()




    async function GetDocumentsInformation(country_id, level_id, subject_area_text, subject_sub_area_text, type_id, approval_reference_id,
        from_year, to_year, revoked_type_id, revoke_type_detail, place, text, search_type) {

        let request_link = '';
        notyf.dismissAll();

        startBlockUI('SearchTable');


        const from_advisory_opinion_count = 0
        const from_interpretation_rules_count = 0
        request_link = 'http://' + location.host + "/approvalsList_ES_2/" + country_id + "/" + 0 + "/" + subject_area_text + "/" + subject_sub_area_text + "/" + 0 + "/" +
            0 + "/" + 0 + "/" + 0 + "/" + from_advisory_opinion_count + "/" + from_interpretation_rules_count + "/"
            + 0 + "/" + 0 + "/" + place + "/" + text + "/" + search_type + "/"


        let response = await fetch(request_link).then(response => response.json());

        /*  Show Table Result */
        total_hits = response["total_hits"]
        ES_SearchResult = response["result"]


        showDocumentInformation(ES_SearchResult, 'exact', place, total_hits, text)
        stopBlockUI('SearchTable', 'نتایج جست‌وجو');


        // GetChartData_Es(country_id, text, ES_Aggregations, ES_SearchResult);

    }
    async function ChangeValidationSelect() {
        ValidationSelect = document.getElementById("ValidationSelect").value
        revoked = ['منسوخ', 'ابطال', 'منقضی']
        if (revoked.includes(ValidationSelect)) {
            document.getElementById("advanced_fields_2").classList.add("show");
        }
        else {
            document.getElementById("RevokedSizeSelect").innerHTML = `<option value="0">همه</option>
                                                            <option value="جزئی">جزئی</option>
                                                            <option value="کلی">کلی</option>`
            document.getElementById("SubTypeSelect").innerHTML = `<option value="0">همه</option>
                                                            <option value="صریح">صریح</option>
                                                            <option value="ضمنی">ضمنی</option>`
            document.getElementById("advanced_fields_2").classList.remove("show");
        }
    }


    async function GetChartData_Es(country_id, ES_Aggregations, documents_information_result) {

        let request_link = '';
        startBlockUI('bar_chart_info_pane');

        subject_data = ES_Aggregations['subject-agg']['buckets']
        approval_references_data = ES_Aggregations['approval-ref-agg']['buckets']
        level_data = ES_Aggregations['level-agg']['buckets']
        approval_year_data = ES_Aggregations['approval-year-agg']['buckets']
        type_data = ES_Aggregations['type-agg']['buckets']
        subject_sub_area_data = ES_Aggregations['subject-sub-area-year-agg']['buckets']
        
        doc_ids = []


        for (doc of documents_information_result) {
            doc_ids.push(doc['_id'])
        }


        /* Show Chart  */


        showChartData(subject_sub_area_data, "subject_container", documents_information_result, false)
        showChartData(level_data, "level_container", documents_information_result, false)
        showChartData(approval_year_data, "year_container", documents_information_result, true)
        showChartData(approval_references_data, "approval_container", documents_information_result, false)

        

        stopBlockUI('bar_chart_info_pane', 'داشبورد آماری');

    }





    function showChartData(data, container, documents_information_result, keySort) {
        let chart_data = []
        for (column of data) {

            key = column["key"]
            // key = column["key"] != 0 ? column["key"] : 'نامشخص'
            value = column["doc_count"]

            chart_data.push([key, value])
        }
        showChart(chart_data, container, documents_information_result, keySort)
    }





    function showChart(data, position, documents_information_result, keySort) {


        if (keySort === true) {
            data.sort(function (element_a, element_b) {
                return element_a[0] - element_b[0];
            });
        }
        else {
            data.sort(function (element_a, element_b) {
                return element_a[1] - element_b[1];
            });
        }

        data.sort(function (x, y) { return x[0] === 'نامشخص' ? -1 : y[0] === 'نامشخص' ? 1 : 0; });

        // if (position == 'year_container' && data[0][0] == 0) {
        //     data[0][0] = 'نامشخص'
        // }
        // Sorts the data by descending.
        data = anychart.data.set(data)

        document.getElementById(position).innerHTML = ""

        chart = anychart.column();
        chart.container(position);
        // create a column series and set the data
        var series = chart.column(data);
        chart
            .animation(true)
            .padding([10, 40, 5, 20])


        chart.background().fill('#ffffff');
        series.normal().fill("#488fb8", 1);
        series.normal().stroke("#488fb8", 0);

        // var state = series.normal();
        // state.fill('#1481c0')

        // x axix labels font setting
        var xAxisLabels = chart.xAxis().labels();
        xAxisLabels.fontFamily("vazir");

        var yAxisLabels = chart.yAxis().labels();
        yAxisLabels.fontFamily("vazir");

        // Not allow labels overlapping
        var xAxis = chart.xAxis();
        xAxis.overlapMode("noOverlap");

        var yAxis = chart.yAxis();
        yAxis.title("تعداد سند");
        yAxis.title().fontFamily('vazir');
yAxis.title().fontWeight("bold");
        yAxis.title().height(40);

        // tooltip content font setting
        var tooltip = chart.tooltip();
        tooltip.fontFamily("vazir");

        // tooltip title font setting
        var title = chart.tooltip().title();
        title.fontFamily("vazir");

        chart.tooltip().hAlign('center').format("{%value}");

        chart.xAxis().labels().height(60);

        chart.yAxis().labels().format("{%value}");

        chart.yScale().minimum(0);
        chart.yScale().ticks().allowFractional(false);

        //xAxisLabels.rotation(-90)
        // initiate drawing the chart
        chart.draw();

        chart.listen('Click', async function (event) {
            const click_tag = event.domTarget.tag;
            const index = click_tag["index"]
            const text = data.row(index)[0];
            const best_result_count = documents_information_result.length

            let filtered_result = []
            let header = ""
            let save_file_name = document.getElementById("SearchBox").value;

            if (position === "subject_container") {
                filtered_result = documents_information_result.filter(function (row) {
                    if (row['_source']["subject_name"] === text)
                        return row
                });
                header = "موضوع: " + text
                save_file_name += " (مجموعه سند {1} و موضوع {2})".replace("1", filtered_result[0]["country"]).replace("2", text)
            }

            else if (position === "approval_container") {
                filtered_result = documents_information_result.filter(function (row) {
                    if (row['_source']["approval_reference_name"] === text)
                        return row
                });
                header = "مرجع تصویب: " + text
                save_file_name += " (مجموعه سند {1} و مرجع تصویب {2})".replace("1", filtered_result[0]["country"]).replace("2", text)
            }

            else if (position === "level_container") {
                filtered_result = documents_information_result.filter(function (row) {
                    if (row['_source']["level_name"] === text)
                        return row
                });
                header = "سطح سند: " + text
                save_file_name += " (مجموعه سند {1} و سطح سند {2})".replace("1", filtered_result[0]["country"]).replace("2", text)
            }

            else if (position === "year_container") {
                filtered_result = documents_information_result.filter(function (row) {
                    doc_approval_year = row["_source"]["approval_year"] != 0 ? row["_source"]["approval_year"] : 'نامشخص'

                    if (doc_approval_year == text)
                        return row
                });
                header = "سال تصویب: " + (text != 0 ? text : 'نامشخص')
                save_file_name += " (مجموعه سند {1} و سال تصویب {2})".replace("1", "داتیک").replace("2", (text != 0 ? text : 'نامشخص'))
            }

            document.getElementById("ChartModalHeader").innerText = header
            let filtered_result_tag = ""
            let list_of_docId = ""
            for (const doc of filtered_result) {
                const link = 'http://' + location.host + "/information/?id=" + doc["_source"]["document_id"]
                let tag = "<li class='mt-3' id=" + doc["_source"]["document_id"] + "><a href='" + link + "'>" + doc["_source"]["name"] + "</a></li>"
                filtered_result_tag += tag
                list_of_docId += doc["document_id"] + "_"
            }

            const filtered_result_count = filtered_result.length
            document.getElementById("ChartModalText").innerHTML = "<h6 class='text-secondary' >" + filtered_result_count + " سند از " + best_result_count + " سند برتر:" + "</h6>"

            filtered_result_tag = "<ol start='1'>" + filtered_result_tag + "</ol>"
            document.getElementById("ChartModalText").innerHTML += filtered_result_tag


            /* download file creation */
            document.getElementById("DownloadDocuments").onclick = function () {
                downloadFiles(filtered_result, save_file_name);
            };

            /* export into excel files */
            document.getElementById("ExportExcel2").onclick = function ExportExcelFunction() {

                var csv = "";

                sep = ","
                let Csv = "نام سند" + sep + "سطح سند" + sep +
                    "موضوع سند" + sep + "نوع سند" + sep + "مرجع تصویب" + sep + "تاریخ تصویب" + "\n"
                for (const document of filtered_result) {
                    Csv += document['_source']["name"] + sep + document['_source']["level_name"] + sep + document['_source']["subject_name"] + sep +
                        document['_source']["type_name"] + sep + document['_source']["approval_reference_name"] + sep + document['_source']["approval_date"] + "\n"

                }

                let csvContent = "data:text/csv;charset=utf-8,%EF%BB%BF" + encodeURI(Csv);
                var link = document.createElement("a");
                link.setAttribute("href", csvContent);
                link.setAttribute("download", save_file_name + ".csv");
                document.body.appendChild(link);
                link.click()
            };

            $("#ChartModalBtn").click();


        })

    }


    async function AreaChanged() {
        document.getElementById("document_search").disabled = true;
        document.getElementById('multipleSelectDiv').innerHTML = '' +
            '<label class=" text-right bg-light float-right" style="direction: rtl;">زیرحوزه موضوعی سند:</label>' +
            '<select id="SubjectSubAreaSelect" class="form-select text-right float-right" style="direction: rtl;" multiple>' +
            '<option selected value=' + 0 + " >" + "همه" + "</option>" +
            '</select>'

        let selected_category_id = document.getElementById('SubjectAreaSelect').value

        if (selected_category_id != 0) {
            let key = selected_category_id + "#" + $('#SubjectAreaSelect option:selected').text();
            console.log("here")
            console.log(key)
            for (let sub of subject_area_dict[key]) {
                $('#SubjectSubAreaSelect').append("<option value=" + sub[0] + " >" + sub[1] + "</option>")
            }
        }

        $('#SubjectSubAreaSelect').multiSelect();
        document.getElementById("document_search").disabled = false;


        /****************** Get ColorBox **************************************/
        await ShowColorBox()
    }

    async function ShowColorBox() {
        let selected_category_id = document.getElementById('SubjectAreaSelect').value

        let selected_type = await GetMultiSelectValue('SubjectSubAreaSelect');
        selected_type = selected_type.split("__")

        const request_link = 'http://' + location.host + "/GetSubjectSubAreaList/" + selected_category_id + "/";
        let response = await fetch(request_link).then(response => response.json());
        response = response["sub_area_list"]
        document.getElementById("ColorBox").innerHTML = "";
        for (var i = 0; i < response.length; i++) {
            const type_id = response[i]["id"]
            const type_name = response[i]["name"]
            const type_color = response[i]["color"]

            let is_checked = ""
            if (selected_type.includes(type_id.toString()) || selected_type.includes("0"))
                is_checked = "checked"

            tag = '<div class="form-check"><input onclick="showReferencesGraph(0)" type="checkbox" id="' + type_id + '" '+is_checked+' disabled>'
            tag += '<label class="form-check-label" style="padding-right: 20px; color: ' + type_color + '" for="flexCheckChecked">' + type_name + '</label></div>'

            document.getElementById("ColorBox").innerHTML += tag
        }
    }


    async function CountryChanged() {
        clearPrevResults(container_id_list);
    }


    async function ShowResult() {

        clearPrevResults(container_id_list);


        const country_id = document.getElementById("country").value;
        const SubjectAreaSelect_id = document.getElementById('SubjectAreaSelect').value
        const multiselect_SubjectSubArea_value = await GetMultiSelectValue('SubjectSubAreaSelect');
        const ValidationSelect = document.getElementById('ValidationSelect').value
        const RevokedSizeSelect = document.getElementById('RevokedSizeSelect').value
        const SubTypeSelect = document.getElementById('SubTypeSelect').value


        await SpinnerModeFunction("Active");

        /****************** Get Documents Information Data ****************************/
        notyf.dismissAll();

        startBlockUI('SearchTable');

        let request_link4 = 'http://' + location.host + "/Get_SubjectArea_Documents/"
            + country_id + "/" + SubjectAreaSelect_id + "/" + multiselect_SubjectSubArea_value + "/" + ValidationSelect + "/" + RevokedSizeSelect + "/" + SubTypeSelect + "/";
        console.log(request_link4)


        var response4 = await fetch(request_link4).then(response4 => response4.json());
        let document_result = response4["documentsList"]
        document.getElementById("DocumentCount").innerText = response4["document_count"] + " سند مرتبط با موضوع یافت شد.";

        SearchResultValue = document_result
        document.getElementById("SearchTable").innerHTML = "";
        $('.SearchTable').footable({
            "paging": {
                "enabled": true,
                strings: {
                    first: '»',
                    prev: '›',
                    next: '‹',
                    last: '«'
                }
            },
            "filtering": {
                "enabled": false
            },
            "sorting": {
                "enabled": true
            },
            "empty": "سندی یافت نشد.",
            "columns": [{
                "name": "id",
                "title": "ردیف",
                "breakpoints": "xs sm",
                "type": "number",
                "style": {
                    "width": "5%"
                }
            }, {
                "name": "document_tag",
                "title": "نام سند",
                "style": {
                    "width": "35%"
                }
            }, {
                "name": "document_approval_date",
                "title": "تاریخ تصویب",
                "style": {
                    "width": "15%"
                }
            }, {
                "name": "doc_subject_sub_area_name",
                "title": "زیرحوزه",
                "style": {
                    "width": "10%"
                }
            }, {
                "name": "revoked_msg",
                "title": "اعتبار",
                "style": {
                    "width": "10%"
                },
            }, {
                "name": "doc_subject_sub_area_weight",
                "title": "وزن",
                {% comment %} "sorted": true,
                "direction": "DESC", {% endcomment %}
                "style": {
                    "width": "5%"
                },
            }, {
                "name": "detail",
                "title": "جزئیات",
                "style": {
                    "width": "10%"
                },
            }
            ],
            "rows": document_result
        });


        stopBlockUI('SearchTable', 'نتایج جست‌وجو');

        /****************** Get Actors Chart Data ****************************/

        request_link = 'http://' + location.host + "/documentSubjecArea_ES/" +
            + country_id + "/" + SubjectAreaSelect_id + "/" + multiselect_SubjectSubArea_value + "/"

        let response = await fetch(request_link).then(response => response.json());

        /*  Show Table Result */
        total_hits = response["total_hits"]
        ES_SearchResult = response["result"]
        ES_Aggregations = response["aggregations"]

        console.log(ES_Aggregations)
        // showDocumentInformation(ES_SearchResult, 'exact', place, total_hits, text)
        // stopBlockUI('SearchTable', 'نتایج جست‌وجو');


        GetChartData_Es(country_id, ES_Aggregations, ES_SearchResult);

        /********************* Show Graph *************************/
        // /* Show References Graph */
        startBlockUI('advanced_graph_container');
        console.log("A")
        await showReferencesGraph(1)

        stopBlockUI('advanced_graph_container', 'گراف ارجاعات');
        await SpinnerModeFunction("Disable");

    }



    async function GetMultiSelectCollectiveActorsValue() {
        var e = document.getElementById("CollectiveActorSelect");
        var selected = [...e.options]
            .filter(option => option.selected)
            .map(option => option.value)
        return selected.join("__")
    }


    async function showDocumentInformation(documents_information_dict, category_id, actors_id, collectives_id, membership_type, keywords_text) {

        SearchResultValue = documents_information_dict;

        document.getElementById("DocumentCount").innerText = (Object.keys(documents_information_dict).length).toString() + " سند یافت شد.";
        let index = 1;
        let document_result = []


        for (const [doc_id, doc_info] of Object.entries(documents_information_dict)) {


            const document_id = doc_id
            const document_name = doc_info["name"]

            const document_subject = doc_info['subject']
            const document_approval_reference = doc_info['approval_reference']
            const document_approval_date = doc_info['approval_date']

            const role_name = doc_info["role_name"]
            let collective_counts = doc_info["collective_counts"]
            collective_counts = collective_counts.toString().replaceAll(',', '<br>');

            const document_link = 'http://' + location.host + "/information/?id=" + document_id
            const doc_name = '<a target="blank" href="' + document_link + '">' + document_name + "</a>"

            const detail_function = "DetailFunction(" + document_id + ",'" + collectives_id + "'," + category_id + ",'" + actors_id + "', '" + membership_type + "', '" + preprocessed_keywords_text + "')"
            const detail = '<button type="button" class="btn modal_btn" data-bs-toggle="modal" ' + ' onclick="' + detail_function + '" data-bs-target="#detailModal">جزئیات</button>'

            const row = {
                "id": index, "name": doc_name,
                'document_subject': document_subject,
                'document_approval_reference': document_approval_reference,
                'document_approval_date': document_approval_date,
                "collective_counts": collective_counts,
                "detail": detail
            }
            document_result.push(row)
            index += 1
        }
        $('#SearchTable').empty();
        $('.SearchTable').footable({
            "paging": {
                "enabled": true,
                strings: {
                    first: '»',
                    prev: '›',
                    next: '‹',
                    last: '«'
                }
            },
            "filtering": {
                "enabled": false
            },
            "sorting": {
                "enabled": true
            },
            "empty": "سندی یافت نشد.",
            "columns": [{
                "name": "id",
                "title": "ردیف",
                "breakpoints": "xs sm",
                "type": "number",
                "style": {
                    "width": "5%"
                }
            }, {
                "name": "name",
                "title": "نام سند",
                "style": {
                    "width": "35%"
                }
            }, {
                "name": "document_subject",
                "title": "موضوع سند",
                "style": {
                    "width": "15%"
                }
            }, {
                "name": "collective_counts",
                "title": "کنشگران جمعی (تعداد اعضاء)",
                "style": {
                    "width": "25%"
                }
            }, {
                "name": "detail",
                "title": "جزئیات",
                "style": {
                    "width": "5%"
                }
            }
            ],
            "rows": document_result
        });

    }



    async function DetailFunction(document_id) {
        startFullPageBlockUI();

        console.log('hello')
        document.getElementById("ModalHeader").innerHTML = "";
        document.getElementById("DetailText").innerHTML = ""

        let request_link = 'http://' + location.host + "/GetDocumentWithAreaKeywords/" + document_id + "/";

        let response = await fetch(request_link).then(response => response.json());

        /*  Show detail Result */
        let document_paragraphs_result = response["result_paragraph"];
        let document_name = response["doc_name"];
        console.log(document_name)
        await showDetailsModal(document_id, document_name, document_paragraphs_result);
        stopFullPageBlockUI("جزئیات سند");
    }


    async function showDetailsModal(document_id, document_name, paragraphs_list) {
        /* Title Text */
        const link = 'http://' + location.host + "/information/?id=" + document_id;
        document.getElementById("ModalHeader").innerHTML = "<a target='to_blank' href='" + link + "'>" + document_name + "</a>";

        /* Body Text */
        document.getElementById("DetailText").innerHTML = ""
        result_tag = ''

        for (para of paragraphs_list){
            result_tag += '<li class="lh-lg">' + para + '</li>'
        }

        document.getElementById("DetailText").innerHTML = "<ul>" + result_tag + "</ul>"

    }


    async function createMemberGraphData(paragraphs_dict, chart_container) {
        nodes = []
        edges = []
        chart_data = []
        for (const [para_id, para_info] of Object.entries(paragraphs_dict)) {
            para_collective_name = para_info['collective_name'];
            para_collective_members = para_info['collective_members'];

            collective_node = {
                id: para_id,
                name: para_collective_name,
                group: 'collectives',
                fill: {
                    'src': "../../static/icons/actors_icons/collective1.png"
                }
            }
            nodes.push(collective_node);

            for (const [member_id, member_info] of Object.entries(para_collective_members)) {
                member_name = member_info['name']
                member_selected = member_info['selected']
                member_group = 'members'
                if (member_selected) {
                    member_group = 'selected_members'
                }

                member_node = {
                    id: member_name,
                    name: member_name,
                    group: member_group,
                    fill: {
                        'src': "../../static/icons/actors_icons/actor_icon3.png"
                    }
                }
                nodes.push(member_node)
                edge = {
                    from: para_id,
                    from_name: para_collective_name,
                    to: member_name,
                    to_name: member_name
                }

                edges.push(edge);
            }

        }

        chart_data['nodes'] = nodes
        chart_data['edges'] = edges
        showCollectiveMemberGraph(chart_container, chart_data)

    }


    async function showCollectiveMemberGraph(chart_container, chart_data) {


        document.getElementById(chart_container).innerHTML = ''
        // create a chart and set the data
        var chart = anychart.graph(chart_data);
        // set the container id
        chart.container(chart_container);

        let collectives = chart.group("collectives");
        let members = chart.group("members");
        let selected_members = chart.group("selected_members");


        if (collectives != undefined) {
            collectives.normal().height(55);
            collectives.hovered().height(60);
            collectives.selected().height(60);
            collectives.normal().stroke(null);

            collectives.labels().enabled(true);
            collectives.labels().format("{%name}").fontFamily('vazir');
            collectives.labels().fontSize(14);
            collectives.labels().fontWeight(600);
        }
        if (members != undefined) {
            members.normal().height(35);
            members.hovered().height(40);
            members.selected().height(40);
            members.normal().stroke(null);

            members.labels().enabled(true);
            members.labels().format("{%name}").fontFamily('vazir');
            members.labels().fontSize(14);
            members.labels().fontWeight(600);
        }
        if (selected_members != undefined) {
            selected_members.normal().height(40);
            selected_members.hovered().height(45);
            selected_members.selected().height(45);
            selected_members.normal().stroke("#1481c0", 3);

            selected_members.labels().enabled(true);
            selected_members.labels().format("{%name}").fontFamily('vazir');
            selected_members.labels().fontSize(14);
            selected_members.labels().fontWeight(600);
        }
        let nodes = chart.nodes();
        nodes.hovered().fill("#ffa000");
        chart.nodes().tooltip().format("{%name}");
        chart.edges().tooltip().format(" از: {%from_name} \n به: {%to_name}");
        chart.edges().tooltip().fontFamily('vazir');
        chart.nodes().tooltip().fontFamily('vazir');
        chart.background("transparent");

        chart.edges().arrows({
            enabled: true,
            size: 10,
            position: '50%'
        });


        // initiate drawing the chart
        chart.draw();


    }


    function highlightFunction(para_text, has_next_paragraph_members, para_collective_name, para_collective_members, preprocessed_keywords_text) {
        paragraph_pattern_kw = ''
        for (pattern_kw of collective_pattern_keywords) {

            if (para_text.includes(pattern_kw)) {
                paragraph_pattern_kw = pattern_kw
            }
        }


        start_index = para_text.indexOf(paragraph_pattern_kw);
        cropped_text = para_text.substring(start_index)

        end_index = cropped_text.indexOf('.')

        if (end_index == -1) {
            end_index = cropped_text.length
        }

        cropped_text = cropped_text.substring(0, end_index);

        highlighted_cropped_text = cropped_text;
        if (!has_next_paragraph_members) {

            for (const [member_id, member_info] of Object.entries(para_collective_members)) {
                member_form = member_info['form']
                memeber_selected = member_info['selected']

                if (memeber_selected)
                    member_form_tag = "<span class='bg-primary text-white rounded px-1'>" + member_form + "</span>"
                else {
                    member_form_tag = "<span class='bold text-primary rounded px-1'>" + member_form + "</span>"
                }

                highlighted_cropped_text = highlighted_cropped_text.replaceAll(member_form, member_form_tag);
            }

            para_text = para_text.replaceAll(cropped_text, highlighted_cropped_text);

        }


        // highlight collective name
        collective_tag = "<span class='bg-secondary text-white px-1 rounded'>" + para_collective_name + 'ی' + "</span> "
        para_text = para_text.replaceAll(para_collective_name + 'ی', collective_tag)


        collective_tag = "<span class='bg-secondary text-white px-1 rounded'>" + para_collective_name + '‌ای' + "</span> "
        para_text = para_text.replaceAll(para_collective_name + '‌ای', collective_tag)


        collective_tag = "<span class='bg-secondary text-white px-1 rounded'>" + para_collective_name + ' ای' + "</span> "
        para_text = para_text.replaceAll(para_collective_name + ' ای', collective_tag)


        collective_tag = "<span class='bg-secondary text-white px-1 rounded'>" + para_collective_name + '­ای' + "</span> "
        para_text = para_text.replaceAll(para_collective_name + '­ای', collective_tag)

        pattern_kw_tag = "<span class='gray_dotted_border px-1 rounded'>" + paragraph_pattern_kw + "</span> "


        if (paragraph_pattern_kw != '') {
            para_text = para_text.replaceAll(paragraph_pattern_kw, pattern_kw_tag);

        }

        if (preprocessed_keywords_text != 'empty') {
            keywords_list = preprocessed_keywords_text.split(',');

            for (kw of keywords_list) {
                kw_tag = "<span class='bg-success text-white px-1 rounded'>" + kw + "</span> "
                para_text = para_text.replaceAll(' ' + kw, ' ' + kw_tag);
            }
        }

        return para_text;
    }


    async function showReferencesGraph(firstLoad) {
        document.getElementById("advanced_graph_container").innerHTML = ""

        if (firstLoad === 1)
            await ShowColorBox()

        const subject_area_id = document.getElementById("SubjectAreaSelect").value
        const country_id = document.getElementById("country").value

        let request_link = 'http://' + location.host + "/GetSubjectAreaGraphNodesEdges/" + country_id + "/" + subject_area_id + "/";
        let response = await fetch(request_link).then(response => response.json());

        let Nodes_data = response["Nodes_data"]
        let Edges_data = response["Edges_data"]

        data_graph = {
            nodes: Nodes_data,
            edges: Edges_data
        };

        await FilterGraphSubArea()

        const container = document.getElementById('advanced_graph_container');
        const width = 1300;
        const height = 500;

        const tooltip = new G6.Tooltip({
            offsetX: 10,
            offsetY: 10,
            itemTypes: ['node', 'edge'],
            getContent: (e) => {
                const outDiv = document.createElement('div');
                outDiv.style.width = 'fit-content';
                let a = e.item.getType()
                if (a === "node") {
                    outDiv.innerHTML = `<div>
                                            <p>${e.item.getModel().name}</p>
                                        </div>`;
                }
                else if (a === "edge") {
                    outDiv.innerHTML = `<div style="direction: rtl">
                        <p>از: ${e.item.getModel().source_name}</p>
                        <p>به: ${e.item.getModel().target_name}</p>
                        <p style="font-weight: bold">تعداد ارجاع: ${e.item.getModel().weight}</p>
                    </div>`;
                }
                return outDiv;
            }
        });

        graph_object = new G6.Graph({
            container: 'advanced_graph_container',
            width,
            height,
            modes: {
                default: ['zoom-canvas',
                    'drag-node',
                    'drag-canvas',
                    { type: "brush-select", trigger: 'ctrl' },
                ], //"activate-relations"
            },
            plugins: [tooltip],
            layout: "grid",
            animate: true,
            defaultEdge: {
                style: {
                    stroke: '#404040',
                    endArrow: {
                        path: 'M 0,0 L 8,4 L 8,-4 Z',
                        fill: '#404040',
                    },
                    cursor: "pointer"
                },
            },
            nodeStateStyles: {
                selected: {
                    stroke: 'Yellow',
                    fill: 'Yellow'
                },
                cursor: "pointer"
            },
        });


        graph_object.data(data_graph);
        graph_object.render();

        graph_object.on('nodeselectchange', e => {
            const selected_nodes = e.selectedItems.nodes
            const selected_edges = e.selectedItems.edges

            let nodes_data = []
            let id = 1
            for (const node of selected_nodes) {
                const node_object = node._cfg.model
                const node_id = node_object.id
                const node_name = node_object.name
                const type_name = node_object.type_name

                const degree = graph_object.getNodeDegree(node_object.id, 'total');

                const nodeSelection = "NodeSelection('" + node_id + "')"
                const detail = '<button type="button" class="btn modal_btn" data-bs-toggle="modal" onclick="' + nodeSelection + '" data-bs-target="#detailModal">انتخاب</button>'

                nodes_data.push({ id: id, name: node_name, type_name: type_name, degree: degree, node_selection: detail })
                id = id + 1
            }
            $('#selected_node_table').empty();
            $('#selected_node_table').footable({
                "paging": {
                    "enabled": true,
                    strings: {
                        first: '»',
                        prev: '›',
                        next: '‹',
                        last: '«'
                    }
                },
                "filtering": {
                    "enabled": false
                },
                "sorting": {
                    "enabled": true
                },
                "empty": "گره ای انتخاب نشده است",
                "columns": [{
                    "name": "id",
                    "title": "ردیف",
                    "breakpoints": "xs sm",
                    "type": "number",
                    "style": {
                        "width": "5%"
                    }
                }, {
                    "name": "name",
                    "title": "نام گره",
                    "style": {
                        "width": "60%"
                    }
                }, {
                    "name": "degree",
                    "title": "درجه",
                    "style": {
                        "width": "10%"
                    }
                }, {
                    "name": "type_name",
                    "title": "نوع گره",
                    "style": {
                        "width": "15%"
                    }
                }, {
                    "name": "node_selection",
                    "title": "انتخاب",
                    "style": {
                        "width": "10%"
                    }
                }
                ],
                "rows": nodes_data
            });

            let edges_data = []
            id = 1
            for (const edge of selected_edges) {
                const edge_object = edge._cfg.model

                const src_node_id = edge_object.source
                const src_node_name = edge_object.source_name
                const source_doc_link = 'http://' + location.host + '/standard_information/?id=' + src_node_id.toString()
                const source_doc_tag = '<a class="document_link" target="blank" href="' + source_doc_link + '">' + src_node_name + "</a>"

                const target_node_id = edge_object.target
                const target_node_name = edge_object.target_name
                const target_doc_link = 'http://' + location.host + '/standard_information/?id=' + target_node_id.toString()
                const target_doc_tag = '<a class="document_link" target="blank" href="' + target_doc_link + '">' + target_node_name + "</a>"

                const weight = edge_object.weight

                edges_data.push({ id: id, src_name: src_node_name, target_name: target_node_name, weight: weight })
                id = id + 1
            }
            $('#selected_edge_table').empty();
            $('#selected_edge_table').footable({
                "paging": {
                    "enabled": true,
                    strings: {
                        first: '»',
                        prev: '›',
                        next: '‹',
                        last: '«'
                    }
                },
                "filtering": {
                    "enabled": false
                },
                "sorting": {
                    "enabled": true
                },
                "empty": "یالی انتخاب نشده است",
                "columns": [{
                    "name": "id",
                    "title": "ردیف",
                    "breakpoints": "xs sm",
                    "type": "number",
                    "style": {
                        "width": "5%"
                    }
                }, {
                    "name": "src_name",
                    "title": "مبدا",
                    "style": {
                        "width": "40%"
                    }
                }, {
                    "name": "target_name",
                    "title": "مقصد",
                    "style": {
                        "width": "40%"
                    }
                }, {
                    "name": "weight",
                    "title": "وزن",
                    "style": {
                        "width": "15%"
                    }
                },
                ],
                "rows": edges_data
            });

        })

        function handleNodeClick(event) {
            const item = event.item._cfg.model;
            window.open('http://' + location.host + "/information?id=" + item["id"]);
        }
        graph_object.on('node:dblclick', handleNodeClick);

        function handleEdgeClick(event) {
            const item = event.item._cfg.model;
            const edge_id = item["source"] + "__" + item["target"]
            window.open('http://' + location.host + "/comparison?id=" + edge_id);
        }
        graph_object.on('edge:dblclick', handleEdgeClick);

        if (typeof window !== 'undefined')
            window.onresize = () => {
                if (!graph_object || graph_object.get('destroyed')) return;
                if (!container || !container.scrollWidth || !container.scrollHeight) return;
                graph_object.changeSize(container.scrollWidth, 500);
            };

        var select = $("#ChangeLayout");
        select.val(select.children(":first").val());

        let min_degree = 1.797693134862315E+308
        let max_degree = 0
        data_graph.nodes.forEach((node) => {
            const degree = graph_object.getNodeDegree(node["id"], 'total');
            if (degree < min_degree) {
                min_degree = degree
            }
            if (degree > max_degree) {
                max_degree = degree
            }
        })

        if (min_degree === 1.797693134862315E+308)
            min_degree = 0

        let min_weight = 1.797693134862315E+308
        let max_weight = 0
        data_graph.edges.forEach((edge) => {
            const weight = edge["weight"];
            if (weight < min_weight) {
                min_weight = weight
            }
            if (weight > max_weight) {
                max_weight = weight
            }
        })

        if (min_weight === 1.797693134862315E+308)
            min_weight = 0

        await ShowRangeSlider(min_degree, max_degree)
        await ShowWeightSlider(min_weight, max_weight)

        var element = document.getElementById('advanced_graph_container');
        element.style.position = null;

    }

    function NodeSelection(node_id) {
        data_graph.nodes.forEach((node) => {
            let item = graph_object.findById(node["id"])
            if (node["id"] === node_id) {
                graph_object.setItemState(item, 'selected', true);
            }
            else {
                graph_object.setItemState(item, 'selected', false);
            }
        })

        graph_object.getEdges().forEach((edge) => {
            graph_object.setItemState(edge, 'selected', false);

        });

        let item = graph_object.findById(node_id)._cfg.model
        const degree = graph_object.getNodeDegree(node_id, 'total');
        const nodeSelection = "NodeSelection('" + node_id + "')"
        const detail = '<button type="button" class="btn modal_btn" data-bs-toggle="modal" onclick="' + nodeSelection + '" data-bs-target="#detailModal">انتخاب</button>'

        nodes_data = [{ id: 1, name: item["name"], degree: degree, type_name: item.type_name, node_selection: detail }]
        $('#selected_node_table').empty();
        $('#selected_node_table').footable({
            "paging": {
                "enabled": true,
                strings: {
                    first: '»',
                    prev: '›',
                    next: '‹',
                    last: '«'
                }
            },
            "filtering": {
                "enabled": false
            },
            "sorting": {
                "enabled": true
            },
            "empty": "گره ای انتخاب نشده است",
            "columns": [{
                "name": "id",
                "title": "ردیف",
                "breakpoints": "xs sm",
                "type": "number",
                "style": {
                    "width": "5%"
                }
            }, {
                "name": "name",
                "title": "نام گره",
                "style": {
                    "width": "60%"
                }
            }, {
                "name": "degree",
                "title": "درجه",
                "style": {
                    "width": "10%"
                }
            }, {
                "name": "type_name",
                "title": "نوع گره",
                "style": {
                    "width": "15%"
                }
            }, {
                "name": "node_selection",
                "title": "انتخاب",
                "style": {
                    "width": "10%"
                }
            }
            ],
            "rows": nodes_data
        });

        $('#selected_edge_table').empty();
        $('#selected_edge_table').footable({
            "paging": {
                "enabled": true,
                strings: {
                    first: '»',
                    prev: '›',
                    next: '‹',
                    last: '«'
                }
            },
            "filtering": {
                "enabled": false
            },
            "sorting": {
                "enabled": true
            },
            "empty": "یالی انتخاب نشده است",
            "columns": [{
                "name": "id",
                "title": "ردیف",
                "breakpoints": "xs sm",
                "type": "number",
                "style": {
                    "width": "5%"
                }
            }, {
                "name": "src_name",
                "title": "مبدا",
                "style": {
                    "width": "40%"
                }
            }, {
                "name": "target_name",
                "title": "مقصد",
                "style": {
                    "width": "40%"
                }
            }, {
                "name": "weight",
                "title": "وزن",
                "style": {
                    "width": "15%"
                }
            },
            ],
            "rows": []
        });

    }

    function ShowRangeSlider(min, max) {
        document.getElementById("RangeSlider").style.visibility = "visible"

        $('#RangeSlider #slider-range').slider({
            range: true,
            min: min,
            max: max,
            step: 1,
            values: [min, max]
        });

        // Move the range wrapper into the generated divs
        $('#RangeSlider .ui-slider-range').append($('#RangeSlider .range-wrapper'));

        console.log($('#RangeSlider #slider-range'))
        // Apply initial values to the range container
        $('#RangeSlider .range').html(
            '<span class="range-value"><sup></sup>' +
            $('#RangeSlider #slider-range').slider("values", 0).toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "1,") +
            '</span><span class="range-divider"></span><span class="range-value"><sup></sup>' +
            $("#RangeSlider #slider-range").slider("values", 1).toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "1,") + '</span>');

        // Show the gears on press of the handles
        $('#RangeSlider .ui-slider-handle, #RangeSlider .ui-slider-range').on('mousedown', function () {
            $('.gear-large').addClass('active');
        });


        $('#RangeSlider #slider-range').slider({
            slide: function (event, ui) {
                $('#RangeSlider .range').html(
                    '<span class="range-value"><sup></sup>' +
                    ui.values[0].toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "1,") +
                    '</span><span class="range-divider"></span><span class="range-value"><sup></sup>' +
                    ui.values[1].toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "1,") + '</span>');

                // Get old value
                var previousVal = parseInt($(this).data('value'));

                min_selected_degree = ui.values[0]
                max_selected_degree = ui.values[1]

                FilterGraphDegreeWeight()

                // Save new value
                $(this).data({
                    'value': parseInt(ui.value)
                });
            }
        });

        $("#RangeSlider .ui-slider-handle").parent().css('z-index', 0);

    }

    function ShowWeightSlider(min, max) {

        document.getElementById("WeightSlider").style.visibility = "visible"

        $('#WeightSlider #slider-range').slider({
            range: true,
            min: min,
            max: max,
            step: 1,
            values: [min, max]
        });

        // Move the range wrapper into the generated divs
        $('#WeightSlider .ui-slider-range').append($('#WeightSlider .range-wrapper'));

        // Apply initial values to the range container
        $('#WeightSlider .range').html(
            '<span class="range-value"><sup></sup>' +
            $('#WeightSlider #slider-range').slider("values", 0).toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "1,") +
            '</span><span class="range-divider"></span><span class="range-value"><sup></sup>' +
            $("#WeightSlider #slider-range").slider("values", 1).toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "1,") + '</span>');

        // Show the gears on press of the handles
        $('#WeightSlider .ui-slider-handle, #WeightSlider .ui-slider-range').on('mousedown', function () {
            $('.gear-large').addClass('active');
        });

        $('#WeightSlider #slider-range').slider({
            slide: function (event, ui) {
                $('#WeightSlider .range').html(
                    '<span class="range-value"><sup></sup>' +
                    ui.values[0].toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "1,") +
                    '</span><span class="range-divider"></span><span class="range-value"><sup></sup>' +
                    ui.values[1].toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "1,") + '</span>');

                // Get old value
                var previousVal = parseInt($(this).data('value'));

                min_selected_weight = ui.values[0]
                max_selected_weight = ui.values[1]

                FilterGraphDegreeWeight()

                // Save new value
                $(this).data({
                    'value': parseInt(ui.value)
                });
            }
        });

        $("#WeightSlider .ui-slider-handle").parent().css('z-index', 0);

    }

    function FilterGraphDegreeWeight() {
        graph_object.getEdges().forEach((edge) => { edge.show() })
        graph_object.getNodes().forEach((node) => { node.show() })

        const min_degree = min_selected_degree
        const max_degree = max_selected_degree

        const min_weight = min_selected_weight
        const max_weight = max_selected_weight

        graph_object.getEdges().forEach((edge) => {
            const edge_item = edge._cfg.model
            const edge_weight = edge_item.weight
            if (edge_weight < min_weight || edge_weight > max_weight) {
                edge.hide()
            }
            else {
                const source_node_degree = graph_object.getNodeDegree(edge_item.source, 'total');
                const target_node_degree = graph_object.getNodeDegree(edge_item.target, 'total');

                if (source_node_degree < min_degree || source_node_degree > max_degree) {
                    graph_object.findById(edge_item.source).hide();
                    graph_object.getEdges().forEach((edge_temp) => {
                        if (edge_temp._cfg.model.source === edge_item.source || edge_temp._cfg.model.target === edge_item.source) {
                            edge_temp.hide()
                        }
                    })
                }
                if (target_node_degree < min_degree || target_node_degree > max_degree) {
                    graph_object.findById(edge_item.target).hide();
                    graph_object.getEdges().forEach((edge_temp) => {
                        if (edge_temp._cfg.model.source === edge_item.target || edge_temp._cfg.model.target === edge_item.target) {
                            edge_temp.hide()
                        }
                    })
                }
            }
        })

        graph_object.getNodes().forEach((node) => {
            const node_degree = graph_object.getNodeDegree(node._cfg.model.id, 'total');
            if (node_degree < min_degree || node_degree > max_degree) {
                graph_object.findById(node._cfg.model.id).hide();
            }
        });

    }

    const { louvain } = G6.Algorithm;
    function ChangeLayout() {
        layout = document.getElementById("ChangeLayout").value
        la = { type: layout }
        graph_object.updateLayout(la);
    }

    function onlyUnique(value, index, self) {
        return self.indexOf(value) === index;
    }

    function SelectNeighbourhood() {
        const selected_node_list = []
        let selected_nodes = []
        let selected_edges = []

        graph_object.cfg.states.selected.forEach((item) => {
            const item_cfg = item._cfg
            if (item_cfg.type === "node") {
                selected_node_list.push(item_cfg.model.id)
                selected_nodes.push(item)
            }
            else {
                selected_edges.push(item)
            }

        })

        graph_object.getEdges().forEach((edge) => {

            if (edge.get('visible') === true) {
                const source_id = edge._cfg.model.source
                const target_id = edge._cfg.model.target

                if (selected_node_list.includes(source_id)) {
                    graph_object.setItemState(edge, 'selected', true);
                    graph_object.setItemState(graph_object.findById(target_id), 'selected', true);
                    selected_nodes.push(graph_object.findById(target_id))
                    selected_edges.push(edge)
                }
                else if (selected_node_list.includes(target_id)) {
                    graph_object.setItemState(edge, 'selected', true);
                    graph_object.setItemState(graph_object.findById(source_id), 'selected', true);
                    selected_nodes.push(graph_object.findById(source_id))
                    selected_edges.push(edge)
                }
            }
        });

        let nodes_data = []
        let id = 1
        for (const node of selected_nodes.filter(onlyUnique)) {
            const node_object = node._cfg.model
            const node_id = node_object.id
            const node_name = node_object.name

            const degree = graph_object.getNodeDegree(node_object.id, 'total');

            const doc_link = 'http://' + location.host + '/standard_information/?id=' + node_id.toString()
            const doc_tag = '<a class="document_link" target="blank" href="' + doc_link + '">' + node_name + "</a>"

            const nodeSelection = "NodeSelection('" + node_id + "')"
            const detail = '<button type="button" class="btn modal_btn" data-bs-toggle="modal" onclick="' + nodeSelection + '" data-bs-target="#detailModal">انتخاب</button>'


            nodes_data.push({ id: id, name: doc_tag, degree: degree, type_name: node_object.type_name, node_selection: detail })
            id = id + 1
        }
        $('#selected_node_table').empty();
        $('#selected_node_table').footable({
            "paging": {
                "enabled": true,
                strings: {
                    first: '»',
                    prev: '›',
                    next: '‹',
                    last: '«'
                }
            },
            "filtering": {
                "enabled": false
            },
            "sorting": {
                "enabled": true
            },
            "empty": "گره ای انتخاب نشده است",
            "columns": [{
                "name": "id",
                "title": "ردیف",
                "breakpoints": "xs sm",
                "type": "number",
                "style": {
                    "width": "5%"
                }
            }, {
                "name": "name",
                "title": "نام گره",
                "style": {
                    "width": "60%"
                }
            }, {
                "name": "degree",
                "title": "درجه",
                "style": {
                    "width": "10%"
                }
            }, {
                "name": "type_name",
                "title": "نوع گره",
                "style": {
                    "width": "15%"
                }
            }, {
                "name": "node_selection",
                "title": "انتخاب",
                "style": {
                    "width": "10%"
                }
            }
            ],
            "rows": nodes_data
        });


        let edges_data = []
        id = 1
        for (const edge of selected_edges.filter(onlyUnique)) {
            const edge_object = edge._cfg.model

            const src_node_id = edge_object.source
            const src_node_name = edge_object.source_name
            const source_doc_link = 'http://' + location.host + '/standard_information/?id=' + src_node_id.toString()
            const source_doc_tag = '<a class="document_link" target="blank" href="' + source_doc_link + '">' + src_node_name + "</a>"

            const target_node_id = edge_object.target
            const target_node_name = edge_object.target_name
            const target_doc_link = 'http://' + location.host + '/standard_information/?id=' + target_node_id.toString()
            const target_doc_tag = '<a class="document_link" target="blank" href="' + target_doc_link + '">' + target_node_name + "</a>"

            const weight = edge_object.weight

            edges_data.push({ id: id, src_name: source_doc_tag, target_name: target_doc_tag, weight: weight })
            id = id + 1
        }
        $('#selected_edge_table').empty();
        $('#selected_edge_table').footable({
            "paging": {
                "enabled": true,
                strings: {
                    first: '»',
                    prev: '›',
                    next: '‹',
                    last: '«'
                }
            },
            "filtering": {
                "enabled": false
            },
            "sorting": {
                "enabled": true
            },
            "empty": "یالی انتخاب نشده است",
            "columns": [{
                "name": "id",
                "title": "ردیف",
                "breakpoints": "xs sm",
                "type": "number",
                "style": {
                    "width": "5%"
                }
            }, {
                "name": "src_name",
                "title": "مبدا",
                "style": {
                    "width": "40%"
                }
            }, {
                "name": "target_name",
                "title": "مقصد",
                "style": {
                    "width": "40%"
                }
            }, {
                "name": "weight",
                "title": "وزن",
                "style": {
                    "width": "15%"
                }
            },
            ],
            "rows": edges_data
        });

    }

    function ShowHideNode() {
        const img_tag_id = "ShowHideImg"

        if (show_hide_state === "show") {
            document.getElementById(img_tag_id).src = "../../static/image/show_nodes.png"
            show_hide_state = "hide"

            graph_object.getEdges().forEach((edge) => {
                const edge_object = edge._cfg.model
                const source_object = graph_object.findById(edge_object.source)
                const target_object = graph_object.findById(edge_object.target)
                if (source_object._cfg.states.includes('selected') === false) {
                    source_object.hide()
                }
                if (target_object._cfg.states.includes('selected') === false) {
                    target_object.hide()
                }
                if (edge._cfg.states.includes('selected') === false) {
                    console.log(2)
                    edge.hide()
                }
            });
        }
        else if (show_hide_state === "hide") {
            document.getElementById(img_tag_id).src = "../../static/image/hide_nodes.png"
            show_hide_state = "show"

            FilterGraphDegreeWeight()

        }

    }

    async function FilterGraphSubArea() {

        let selected_type = await GetMultiSelectValue('SubjectSubAreaSelect');

        selected_type = selected_type.split("__")

        data_graph.nodes.forEach((node) => {
            node_id = node["id"].toString()
            node_type_id = node["sub_area"]

            let all_type_condition = selected_type.includes(node_type_id.toString()) || selected_type.includes("0")

            if (all_type_condition === false) {

                data_graph.nodes = $.grep(data_graph.nodes, function (n, i) {
                    return n["id"] !== node_id;
                });

                data_graph.edges = $.grep(data_graph.edges, function (n, i) {
                    return n["source"] !== node_id || n["target"] !== node_id;
                });
            }
        })

        data_graph.nodes.forEach((node) => {
            function getNodeData(node_id) {
                return data_graph.edges.filter(
                    function (data) { return data.source === node_id || data.target === node_id }
                );
            }

            // console.log(getNodeData(node["id"]).length, node["id"])

            if (getNodeData(node["id"]).length === 0) {
                data_graph.nodes = $.grep(data_graph.nodes, function (n, i) {
                    if (n["id"] === node["id"])
                        // console.log(n["id"], node["id"])
                    return n["id"] !== node["id"];
                });
            }
        })


    }


    async function GetMultiSelectValue(container_id) {
        let e = document.getElementById(container_id);
        let selected = [...e.options]
            .filter(option => option.selected)
            .map(option => option.value)
        return selected.join("__")
    }

    async function SpinnerModeFunction(mode) {
        if (mode === "Active") {
            $(".spinner-border").addClass("active");
        } else if (mode === "Disable") {
            $(".spinner-border").removeClass("active");
        }
    }




</script>

<!-- Export results -->

<script>

    async function downloadFiles(file_name_list, save_file_name) {
        startFullPageBlockUI()
        const country_id = document.getElementById("country").value

        let zip = new JSZip()

        const request_link = 'http://' + location.host + "/GetCountryById/" + country_id + "/";
        let response = await fetch(request_link).then(response => response.json());
        response = response["country_information"][0]
        const country_folder = response["folder"];
        const country_name = response["name"];

        save_file_name += " مجموعه سند {" + country_name + "}"


        let extension = ".txt"
        if (country_name.includes("فاوا")) {
            extension = '.docx';
        }


        for (const [doc_id, doc_info] of Object.entries(SearchResultValue)) {
            const document_name = doc_info['doc_name'] + extension

            const path = 'http://' + location.host + '/media/data/' + country_folder + '\\' + document_name;

            await fetch(path)
                .then(res => res.arrayBuffer())
                .then(value => {
                    zip.file(document_name, value);
                })
        }
        zip.generateAsync({
            type: "blob"
        })
            .then(function (content) {
                // see FileSaver.js
                saveAs(content, save_file_name + ".zip");
            });
        stopFullPageBlockUI('دانلود اسناد');
    }

    async function DownloadSerachResultFunction() {
        const save_file_name = " کنشگران جمعی در"
        downloadFiles(SearchResultValue, save_file_name)
    }

    async function ExportExcelSerachResultFunction() {
        var csv = "";

        sep = ","


        let Csv = "نام سند" + sep + "موضوع سند" + sep +
            "مرجع تصویب" + sep + "تاریخ تصویب" + sep + "تعداد کنشگران جمعی" + sep + "کنشکران جمعی" + "\n"

        for (const [doc_id, doc_info] of Object.entries(SearchResultValue)) {
            const document_id = doc_id
            const document_name = doc_info['doc_name']
            const subject_name = doc_info['doc_subject']
            const approval_references_name = doc_info['doc_approval_reference']
            const doc_approval_date = doc_info['doc_approval_date']
            const document_collective_actors = doc_info['collective_actor'].join(' / ')
            const collective_actors_count = doc_info['collective_actor'].length

            Csv += document_name + sep + subject_name + sep
                + approval_references_name + sep
                + doc_approval_date + sep
                + collective_actors_count + sep
                + document_collective_actors
                + "\n"

        }



        let save_file_name = " کنشگران جمعی در"
        save_file_name += " مجموعه سند {" + $('#country option:selected').text() + "}"

        let csvContent = "data:text/csv;charset=utf-8,%EF%BB%BF" + encodeURI(Csv);
        var link = document.createElement("a");
        link.setAttribute("href", csvContent);
        link.setAttribute("download", save_file_name + ".csv");
        document.body.appendChild(link);
        link.click()
    }



    /* Search after press Enter */
    $("#info_form").submit(function () { return false; });
    $("#KeywordsBox").keyup(function (event) {
        if (event.keyCode === 13) {
            ShowResult()
        }
    });

</script>


<script src="../../static/js/tooltip_handler.js"></script>
<!-- Intro Js -->
<!-- <script src="../../static/js/collective_actors/collective_actors_tour.js"> -->
</script>
<script src="../../static/js/UserLogSave.js"></script>
<script src="../../static/js/signout_function.js"></script>
<script src="../../static/js/tour.js"></script>


<!-- Blocking UI -->
<script src="../../static/js/blockUI.js"></script>
<script src="../../static/js/blockUI_handler.js"></script>
<link rel="stylesheet" href="../../static/styles/loader.css">


</html>