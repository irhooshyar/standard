<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-4.5.2.css">
    <script src="../../static/js/jquery_351/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-5.1.2npm.css">
    <script src="../../static/library/bootstrap-5.1.2.bundle.min.js"></script>

    <!--BS Icons -->
    <link rel="stylesheet" href="../../static/library/bootstrap-icons-1.3.0.css">
    <!-- Fontawesome Icons -->

    <link rel="stylesheet" href="../../static/library/fontawesome-5.10.0.all.css"  />
    <link rel="stylesheet" href="../../static/library/font-awesome.min-4.7.0.css">

    <!-- anychart modules -->
    <script src="../../static/library/anychart-8.10.0-core.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-graph.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-pie.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-exports.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-cartesian.min.js"></script>


    <!-- Footable  -->
    <script src="../../static/js/footable/demo-rows.js"></script>
    <script src="../../static/js/footable/ie10-viewport-bug-workaround.js"></script>
    <script src="../../static/js/footable/footable.js"></script>
    <link href="../../static/styles/footable/footable.bootstrap.min.css" rel="stylesheet">
    <link href="../../static/styles/footable/docs.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.Glyphicons.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.FontAwesome.css" rel="stylesheet">

    <script src="https://d3js.org/d3.v3.js"></script>
    <script src="../../static/js/jsnetworkx.js"></script>

    <link rel="stylesheet" href="../../static/styles/index2.css">
    <link rel="stylesheet" href="../../static/styles/graph.css">
    <meta charset="UTF-8">

    <!-- simple graph  -->
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="../../static/library/d3.tip.v0.6.3.js"></script>
    <link rel="stylesheet" href="../../static/styles/sim_graph.css">

    <!-- Intro Js -->
    <script src="../../static/library/intro.min-4.3.0.js"></script>
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs.min-4.3.0.css">
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs-rtl.min-4.3.0.css">
    <link rel="stylesheet" href="../../static/styles/user_guide_tour.css">

    <!-- Notyf  -->
    <link rel="stylesheet" type="text/css" href="../../static/library/notyf.min-npm.css">
    <script src="../../static/library/notyf.min.js"></script>

    <!--<script type="text/javascript" src="http://l2.io/ip.js?var=myip">
    </script>-->

    <title> شباهت میان اسناد</title>
    {% include "doc/title_icon.html" %}
</head>

<body>


    <!-- Menu -->
    <nav dir="rtl" class="navbar nav_menu navbar-expand-lg fixed-top p-0 mt-0">
        {% include "doc/header2.html" %}
    </nav>

    <script>
        $(document).ready(function () {


            // Active panel
            $('#AIDropdown').addClass('active');
            $('#AI_graph_similarity_panel').addClass('active');


            $('select#language').on('change', function (e) {

                let selected_language = this.value;
                let current_url = window.location.href;
                if (selected_language === 'England') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'en')
                    window.location = requested_url;
                } else if (selected_language === 'Russia') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'ru')
                    window.location = requested_url;
                }

            });
        });
    </script>



    <div class="row p-5 pb-0 flex-row-reverse mx-auto bg-light mt-5">
        <form action="" class="custom-control mx-auto needs-validation" id="graph_form" enctype="multipart/form-data"
            method="post" novalidate>

            <div class="row mb-0 flex-row-reverse mx-auto">

                <div class="col-md-6 pt-3 col-12 col-lg-2 bg-light">

                    <label class=" text-right bg-light float-right" style="direction: rtl;;">مجموعه سند:</label>

                    <select id="country" name="country" class="form-select text-right float-right"
                        onchange="CountryChanged()" style="direction: rtl;">
                        {% for k,v in countries.items %}
                        <option value="{{ k }}">{{ v }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-6 pt-3 col-12 col-lg-2 bg-light">
                    <label class=" text-right bg-light float-right" style="direction: rtl;;"> نوع گراف:</label>
                    <select id="GraphType" name="GraphType" class="form-select text-right float-right"
                        style="direction: rtl;">
                    </select>
                </div>

                <div class="col-md-3 pt-3 col-12 col-lg-2 bg-light">
                    <label class=" text-right bg-light float-right" style="direction: rtl;;"> حداقل شباهت (درصد):</label>
                    <select id="MinimumSimilarity" name="MinimumSimilarity" class="form-select text-right float-right"
                        style="direction: rtl;">
                    </select>
                </div>

                <div class="col-lg-3 mr-0 col-md-6 pt-5 col-12">
                    <!-- Advanced Setting btn-->
                    <button id="constraints_setting" type="button" class="btn bg-white float-right ml-4"
                        data-bs-toggle="collapse" data-bs-target="#constraints_container" aria-expanded="false"
                        aria-controls="constraints_container">تنظیمات پیشرفته</button>

                    <!-- Show result btn -->
                    <button type="button" id="graph_show" class="btn float-right" onclick="ShowGraph()"> نمایش
                        گراف</button>
                </div>


                <div class="col-md-6 pt-3 col-12 col-lg-3 mx-0 p-0  bg-light">
                    <div id="similarity_chart_container" style="height: 180px" class="bg-white w-100 p-0">
                    </div>
                </div>

            </div>

            <!-- Constraints -->
            <div id="constraints_container"
                class="collapse show constraints_container row flex-row-reverse pt-0 mb-0 mt-0 mx-auto">
                <div id="SourceMainDiv" class="col-md-3 p-1 col-12 col-lg-6 mt-1">
                    <div class="source_header bg-white row mx-auto p-1">
                        <label class="text-center my-0" style="direction: rtl;;">محدودیت‌های گره مبدأ</label>
                    </div>
                    <div class="source_container pb-2 row mx-auto">

                        <div class="col-md-3 pt-3 col-12 col-lg-6 bg-light">
                            <label class=" text-right bg-light float-right " style="direction: rtl;"> نوع:</label>
                            <select id="SourceType" name="SourceType" class="form-select text-right float-right"
                                style="direction: rtl;" onchange="ChangeOptions('Source')">
                            </select>
                        </div>

                        <div class="col-md-6 pt-3 col-12 col-lg-6 bg-light ">
                            <label class=" text-right bg-light float-right" style="direction: rtl;;"> موضوع:</label>
                            <select id="SourceSubject" name="SourceSubject" class="form-select text-right float-right"
                                onchange="ChangeOptions('Source')" style="direction: rtl;">
                            </select>
                        </div>

                        <!-- select document -->
                        <div style="font-size: 25px; text-align: center; cursor: pointer"
                            class="col-lg-1 px-0 col-md-2 pt-5 mt-1 col-12" onclick="RefreshSelectDocument('Source')">
                            <span class="fa fa-refresh"></span>
                        </div>

                        <div class="col-lg-1 px-0 col-md-2 pt-5 col-12">
                            <button id="Source_document_select" type="button" class="btn float-right mx-0"
                                data-bs-toggle="modal" data-bs-target="#SelectDocumentModal_Source">
                                انتخاب
                            </button>
                        </div>

                        <div class="col-md-3 pt-3 col-12 col-lg-10 bg-light">
                            <label class=" text-right bg-light float-right " style="direction: rtl;;"> سند:</label>
                            <select id="SourceDocuments" name="SourceDocument"
                                class="form-select text-right float-right" style="direction: rtl;" disabled>
                            </select>
                        </div>

                    </div>
                </div>

                <div id="DestinationMainDiv" class="col-md-3 p-1 col-12  col-lg-6  mt-1">
                    <div class="destination_header bg-white row mx-auto p-1">
                        <label class=" text-center bg-white my-0" style="direction: rtl;;">محدودیت‌های گره مقصد</label>
                    </div>
                    <div class="destination_container pb-2 row mx-auto">

                        <div class="col-md-3 pt-3 col-12 col-lg-6 bg-light">
                            <label class=" text-right bg-light float-right " style="direction: rtl;;"> نوع:</label>
                            <select id="DestinationType" name="DestinationType"
                                class="form-select text-right float-right" style="direction: rtl;"
                                onchange="ChangeOptions('Destination')">
                            </select>
                        </div>

                        <div class="col-md-6 pt-3 col-12 col-lg-6 bg-light">
                            <label class=" text-right bg-light float-right " style="direction: rtl;;"> موضوع:</label>
                            <select id="DestinationSubject" name="DestinationSubject"
                                class="form-select text-right float-right" onchange="ChangeOptions('Destination')"
                                style="direction: rtl;">
                            </select>
                        </div>

                        <!-- select document -->
                        <div style="font-size: 25px; text-align: center; cursor: pointer"
                            class="col-lg-1 px-0 col-md-2 pt-5 mt-1 col-12"
                            onclick="RefreshSelectDocument('Destination')">
                            <span class="fa fa-refresh"></span>
                        </div>

                        <div class="col-lg-1 px-0 col-md-2 pt-5 col-12">
                            <button id="Destination_document_select" type="button" class="btn float-right mx-0"
                                data-bs-toggle="modal" data-bs-target="#SelectDocumentModal_Destination">
                                انتخاب
                            </button>
                        </div>

                        <div class="col-md-3 pt-3 col-12 col-lg-10 bg-light">
                            <label class=" text-right bg-light float-right " style="direction: rtl;;"> سند:</label>
                            <select id="DestinationDocuments" name="DestinationDocument"
                                class="form-select text-right float-right" style="direction: rtl;" disabled>
                            </select>
                        </div>

                    </div>
                </div>

            </div>

        </form>

        <!--Original Tabs -->
        <ul id="original_tabs" class="nav nav-pills mt-5 mx-auto  pr-3 pr-sm-0  float-right  d-block" id="pills-tab"
            role="tablist">

            <li class="nav-item float-right" role="presentation" id="advanced_view_tab">
                <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#advanced_view_pane" type="button"
                    role="tab" aria-controls="advanced_view_pane" aria-selected="true">نمای پیشرفته</button>
            </li>
            <li class="nav-item float-right" role="presentation">
                <button id="simple_view_tab" class="nav-link" data-bs-toggle="pill" data-bs-target="#simple_view_pane"
                    type="button" role="tab" aria-controls="simple_view_pane" aria-selected="false">نمای ساده</button>
            </li>
            <li class="nav-item float-right" role="presentation">
                    <button id="search_result_tab" class="nav-link" data-bs-toggle="pill"
                        data-bs-target="#search_result_pane" type="button" role="tab" aria-controls="search_result_pane"
                        aria-selected="true">نمایش جدولی</button>
            </li>
        </ul>

        <!-- Original Panes -->
        <div id="original_pane" class="tab-content float-right px-1 bg-white" id="pills-tabContent">

            <!--  Document Graph Pane -->
            <div class="tab-pane fade show active float-right w-100" id="advanced_view_pane" role="tabpanel"
                aria-labelledby="advanced_view_tab">
                <div class="row mt-4 w-100 flex-row-reverse  mx-auto pb-5 px-4">
                    <!-- doc colors -->
                    <ul id="ColorBox"
                        class="list-group flex-row-reverse list-unstyled w-100 list-group-horizontal text-right">
                    </ul>
                    {# <button id="update_chart_btn" class="btn" title="هم اکنون غیر فعال است">بروزرسانی</button>#}
                    <script src="../../static/js/AI_similarity_graph/color_picker_handler.js">
                    </script>
                    <div id="advanced_graph_container" class="w-100 border mt-1" style="height:500px;">
                    </div>
                </div>
            </div>

            <!-- Bar chart Info Pane -->
            <div class=" tab-pane fade float-right w-100 " id="simple_view_pane" role="tabpanel"
                aria-labelledby="simple_view_tab ">

                <div class="row mt-4 w-100 flex-row-reverse mx-0 px-4 pb-5">
                    <div id="simple_graph_container" class="w-100 border" style=" height: 700px;">
                    </div>

                </div>

            </div>

            <!-- Search Result Pane -->
            <div id="search_result_pane" class="tab-pane w-100 fade float-right" role="tabpanel"
                aria-labelledby="search_result_tab">

                <!-- Search Result table -->
                <div class="table-responsive search_result_table mt-4">
                    <table class="table table-striped SearchTable" style="min-height: 200px;direction: rtl" id="SearchTable">
                    </table>
                </div>

            </div>
        </div>

    </div>

    <!-- Modal Container -->
    <div class="modal fade" id="SelectDocumentModal_Source">
        <div style="max-width: 1200px !important;" class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="ModalHeader_Source" class="modal-title">انتخاب سند 1</h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div id="ModalBody_Source" class="modal-body text-justify">
                    <div class="container_modal">
                        <table id="PopUpTable_Source" class="table table-striped PopUpTable_Source">
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div class="modal fade" id="SelectDocumentModal_Destination">
        <div style="max-width: 1200px !important;" class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="ModalHeader_Destination" class="modal-title">انتخاب سند 2</h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>


                <!-- Modal body -->
                <div id="ModalBody_Destination" class="modal-body text-justify">
                    <div class="container_modal">
                        <table id="PopUpTable_Destination" class="table table-striped PopUpTable_Destination">
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>



    </div>

    <!-- Scrollbar -->
    <button id="scroll_btn" class="p-0" title="بالای صفحه" onclick="topFunction()">
        <i class="far fa-caret-square-up"></i>
    </button>

    <script src="../../static/js/logincheck.js"></script>

    <script src="../../static/js/scroll_button_handler.js"></script>
    <!-- Intro Js -->
    <script src="../../static/js/AI_similarity_graph/AI_similarity_graph_tour.js"></script>
    <script src="../../static/js/tour.js"></script>

    <script>
        init()

        container_id_list = ['advanced_graph_container', 'simple_graph_container']

        function clearPrevResults(container_id_list) {

            for (container_id of container_id_list) {
                document.getElementById(container_id).innerHTML = "";
            }
        }

        async function init() {
            const country_id = document.getElementById("country").value
            /****************** Get Similarity Measure ****************************/

            let request_link = 'http://' + location.host + "/AIGetGraphSimilarityMeasure/";
            let response = await fetch(request_link).then(response => response.json());
            response = response["measure_list"]

            document.getElementById("GraphType").innerHTML = ""
            for (var i = 0; i < response.length; i++) {
                const measure_id = response[i]["id"]
                const measure_name = response[i]["name"]

                const tag = "<option value=" + measure_id + " >" + measure_name + "</option>";

                document.getElementById("GraphType").innerHTML += tag
            }

            /****************** Get Graph Distribution ****************************/
            const measure_id = document.getElementById("GraphType").value
            request_link = 'http://' + location.host + "/AIGetDocSimilarity/" + country_id + "/" + measure_id + "/";
            response = await fetch(request_link).then(response => response.json());
            response = response["graph_distribution"]

            document.getElementById("MinimumSimilarity").innerHTML = ""

            var distribution_chart_value_list = []

            for (var i = 0; i < response.length; i++) {
                const similarity = response[i]["similarity"]
                const count = response[i]["count"]
                if (similarity > 0) {
                    const tag = "<option value=" + similarity + " >" + similarity + "</option>";

                    document.getElementById("MinimumSimilarity").innerHTML += tag

                    distribution_chart_value_list.push([similarity, count]);
                }

            }

            showChart(distribution_chart_value_list, "similarity_chart_container")


            /****************** Subject List ****************************/
            request_link = 'http://' + location.host + "/GetSubjectsByCountryId/" + country_id + "/";
            response = await fetch(request_link).then(response => response.json());
            response = response["documents_subject_list"]

            document.getElementById("SourceSubject").innerHTML = "<option value=" + 0 + " >" + "همه" + "</option>";
            document.getElementById("DestinationSubject").innerHTML = "<option value=" + 0 + " >" + "همه" + "</option>";

            for (var i = 0; i < response.length; i++) {
                const subject_id = response[i]["id"]
                const subject_name = response[i]["subject"]

                const tag = "<option value=" + subject_id + " >" + subject_name + "</option>";

                document.getElementById("SourceSubject").innerHTML += tag
                document.getElementById("DestinationSubject").innerHTML += tag
            }

            /****************** Type List ****************************/
            request_link = 'http://' + location.host + "/GetTypeByCountryId/" + country_id + "/";
            response = await fetch(request_link).then(response => response.json());
            response = response["documents_type_list"]

            document.getElementById("SourceType").innerHTML = "<option value=" + 0 + " >" + "همه" + "</option>";
            document.getElementById("DestinationType").innerHTML = "<option value=" + 0 + " >" + "همه" + "</option>";

            for (var i = 0; i < response.length; i++) {
                const type_id = response[i]["id"]
                const type_name = response[i]["type"]

                const tag = "<option value=" + type_id + " >" + type_name + "</option>";

                document.getElementById("SourceType").innerHTML += tag
                document.getElementById("DestinationType").innerHTML += tag
            }

            /******************************** Get Type Color *****************************************/

            request_link = 'http://' + location.host + "/GetTypeByCountryId/" + country_id + "/";
            response = await fetch(request_link).then(response => response.json());
            response = response["documents_type_list"]
            document.getElementById("ColorBox").innerHTML = "";
            for (var i = 0; i < response.length; i++) {
                const type_id = response[i]["id"]
                const type_name = response[i]["type"]
                const type_color = response[i]["color"]

                tag = '<li style="color: ' + type_color + ';" dir="rtl" class="list-group-item text-right">'
                tag += '<input type="color" class="color_picker form-control form-control-color float-right p-0" id="" value=' + type_color + ' title="انتخاب رنگ">'
                tag += '<span class="float-left mt-0 mr-2">' + type_name + '</span></li>'


                document.getElementById("ColorBox").innerHTML += tag
            }

            /**************** Change Option  **********************/
            ChangeOptions("Source");
            ChangeOptions("Destination");
        }


        async function ChangeOptions(tag) {

            const tag_all = "<option value=" + 0 + " >" + "همه" + "</option>";
            document.getElementById(tag + "Documents").innerHTML = tag_all;

            const country_id = document.getElementById("country").value
            const subject_id = document.getElementById(tag + "Subject").value
            const type_id = document.getElementById(tag + "Type").value

            let request_link = 'http://' + location.host + "/GetDocumentByCountryTypeSubject_Modal/" + country_id + "/" + type_id + "/" + subject_id + "/" + tag + "/";
            let response = await fetch(request_link).then(response => response.json());
            let documentList = response["documents_type_subject_list"]

            var c_name = ".PopUpTable_" + tag;
            let table_selector = '#PopUpTable_' + tag;
            $(table_selector).empty();

            $(c_name).footable({
                "paging": {
                    "enabled": true,
                    strings: {
                         first: '»',
                         prev:'›',
                         next: '‹',
                         last: '«'
                     }
                },
                "filtering": {
                    "enabled": true
                },
                "sorting": {
                    "enabled": true
                },
                "empty": "سندی یافت نشد.",
                "columns": [{
                    "name": "id",
                    "title": "ردیف",
                    "breakpoints": "xs sm",
                    "type": "number",
                    "style": {
                        "width": 80,
                        "maxWidth": 80
                    }
                }, {
                    "name": "document_name",
                    "title": "نام سند"
                }, {
                    "name": "subject",
                    "title": "موضوع سند"
                }, {
                    "name": "approval_reference",
                    "title": "مرجع تصویب"
                }, {
                    "name": "approval_date",
                    "title": "تاریخ تصویب"
                }, {
                    "name": "tag",
                    "title": "انتخاب"
                }],
                "rows": documentList
            });


        }


        async function SelectDocFunction(document_id, tag) {
            const request_link = 'http://' + location.host + "/GetDocumentById/" + document_id + "/";
            let response = await fetch(request_link).then(response => response.json());
            response = response["document_information"][0]
            document.getElementById(tag + "Documents").innerHTML = "<option value=" + response["id"] + " >" + response["name"] + "</option>";
        }

        function RefreshSelectDocument(tag) {
            const tag_all = "<option value=" + 0 + " >" + "همه" + "</option>";
            document.getElementById(tag + "Documents").innerHTML = tag_all;
        }

        function CountryChanged() {
            clearPrevResults(container_id_list);
            init()
        }

        async function ShowGraph() {

            clearPrevResults(container_id_list);
            notyf.dismissAll();
            startBlockUI('advanced_graph_container');
            startBlockUI('simple_graph_container');

            const country_id = document.getElementById("country").value

            /*********************** Filter Source Documents ****************************/
            const source_document_id = document.getElementById("SourceDocuments").value
            const source_subject_id = document.getElementById("SourceSubject").value
            const source_type_id = document.getElementById("SourceType").value


            /*********************** Filter Destination Documents ****************************/
            const destination_document_id = document.getElementById("DestinationDocuments").value
            const destination_subject_id = document.getElementById("DestinationSubject").value
            const destination_type_id = document.getElementById("DestinationType").value


            /*********************** Create Graph ****************************/
            const measure_id = document.getElementById("GraphType").value
            const minimum_weight = (document.getElementById("MinimumSimilarity").value).toString()
            let request_link = 'http://' + location.host + "/AIGetGraphEdgesByDocumentIdMeasure/" + country_id + "/" + source_document_id + "/" + source_type_id + "/" + source_subject_id + "/" +
                +destination_document_id + "/" + destination_type_id + "/" + destination_subject_id + "/" + measure_id + "/" + minimum_weight + "/";
            let response = await fetch(request_link).then(response => response.json());

            let graphEdgeList = response["graph_edge_list"]
            let graphType = response["graph_type"]

            //show table
            await showDocumentInformation(graphEdgeList);


            let nodeList = []
            let edgeList = []

            let sim_edgeList = []
            let sim_nodeList = []

            console.log(graphEdgeList)

            for (let i = 0; i < graphEdgeList.length; i++) {

                const edge = graphEdgeList[i]
                const src_id = edge["src_id"]
                const src_name = edge["src_name"]
                const src_color = edge["src_color"]
                const dest_id = edge["dest_id"]
                const dest_name = edge["dest_name"]
                const dest_color = edge["dest_color"]
                const weight = edge["weight"]

                let source_node = {
                    id: src_id,
                    name: src_name,
                    normal: {
                        fill: src_color,
                        stroke: null
                    },
                    hovered: {
                        fill: src_color,
                        stroke: null
                    },
                    selected: {
                        fill: src_color,
                        stroke: null
                    }
                }

                let destination_node = {
                    id: dest_id,
                    name: dest_name,
                    normal: {
                        fill: dest_color,
                        stroke: null
                    },
                    hovered: {
                        fill: dest_color,
                        stroke: null
                    },
                    selected: {
                        fill: dest_color,
                        stroke: null
                    }
                }

                let edge_data = {
                    id: src_id + "__" + dest_id,
                    from: src_id,
                    to: dest_id,
                    from_name: src_name,
                    to_name: dest_name,
                    weight: weight
                };

                nodeList.push(source_node)
                nodeList.push(destination_node)
                edgeList.push(edge_data)

                /*********************** Simple graph ****************************/
                let sim_link = {
                    source: src_id,
                    target: dest_id,
                    weight: weight,
                    id: src_id + "__" + dest_id,
                    from: src_name,
                    to: dest_name
                }

                let sim_src_node = {
                    id: src_id,
                    name: src_name,
                    color: src_color
                }

                let sim_des_node = {
                    id: dest_id,
                    name: dest_name,
                    color: dest_color
                }

                sim_edgeList.push(sim_link)

                if (!sim_nodeList.filter(e => e.id === sim_src_node.id).length > 0) {
                    sim_nodeList.push(sim_src_node);
                }
                if (!sim_nodeList.filter(e => e.id === sim_des_node.id).length > 0) {
                    sim_nodeList.push(sim_des_node);
                }
            }

            console.log("hello" + sim_nodeList.length)


            /*********************** Show Graph ****************************/

            document.getElementById("advanced_graph_container").innerHTML = ""

            let graphData = {
                nodes: nodeList,
                edges: edgeList
            };


            var chart = anychart.graph(graphData);
            chart.height(650);
            let nodes = chart.nodes();
            nodes.normal().height(12);
            nodes.hovered().height(16);
            nodes.selected().height(16);
            nodes.hovered().fill("#ffa000");
            chart.nodes().tooltip().format("{%name}");
            chart.edges().tooltip().format(" from: {%from_name} \n to: {%to_name} \n weight: {%weight}");
            chart.edges().tooltip().fontFamily('vazir');
            chart.nodes().tooltip().fontFamily('vazir');
            chart.background("transparent");

            if (graphType === "Directed") {
                chart.edges().arrows({
                    enabled: true,
                    size: 10,
                    position: '50%'
                });
            }

            chart.container("advanced_graph_container")
            chart.draw();

            chart.listen('dblClick', async function (event) {
                const click_tag = event.domTarget.tag;
                console.log(click_tag)
                if (click_tag["type"] === "node") {
                    window.open('http://' + location.host + "/information?id=" + click_tag["id"]);
                } else if (click_tag["type"] === "edge") {
                    window.open('http://' + location.host + "/comparison?id=" + click_tag["id"]);
                }

            })


            stopBlockUI('advanced_graph_container', 'نمای پیشرفته');

            /*********************** Show Simple Graph ****************************/
            document.getElementById("simple_graph_container").innerHTML = ""

            //find nodes of each link
            sim_edgeList.forEach(function (link, index) {

                sim_edgeList[index].source = sim_nodeList.filter(function (n) {
                    return n.id == link.source;
                })[0],
                    sim_edgeList[index].target = sim_nodeList.filter(function (n) {
                        return n.id == link.target;
                    })[0];
            });

            var width = 2000,
                height = 700;

            var force = d3.layout.force()
                .nodes(d3.values(sim_nodeList))
                .links(sim_edgeList)
                .size([width, height])
                .linkDistance(100)
                .charge(-400)
                .on("tick", tick)
                .start();

            var svg = d3.select("#simple_graph_container").append("svg")
                .attr("width", width)
                .attr("height", height);

            // Tooltips
            var tip = d3.tip().attr('class', 'd3-tip')
                .html(function (d) {
                    return "<span>" + d.name;
                });

            var tip_link = d3.tip().attr('class', 'd3-tip')
                .html(function (d) {
                    return "<span>" + " from:" + d.source.name + "<br> to: " + d.target.name + "<br> weight: " + d.weight;
                });

            svg.call(tip);
            svg.call(tip_link);

            // Per-type markers, as they don't inherit styles.
            svg.append('defs')
                .append('marker')
                .attr('id', 'arrow')
                .attr('viewBox', [0, 0, 20, 20])
                .attr('refX', 25)
                .attr('refY', 10)
                .attr('markerWidth', 20)
                .attr('markerHeight', 10)
                .attr('orient', 'auto-start-reverse')
                .append('path')
                .attr('d', "M 0,0 L 0 ,20 L 20,10")
                .attr('stroke', 'black');

            var path = svg.append("g").selectAll(".line")
                .data(force.links())
                .enter().append("path")
                .attr("class", function (d) { return "link "; })
                .attr('marker-start', 'url(#arrow)')
                .on("dblclick", function (d) {
                    window.open('http://' + location.host + "/comparison?id=" + d.id);
                })

            var sim_nodes = svg.append("g").selectAll(".node")
                .data(force.nodes())
                .enter().append("g").attr("class", "node");


            var circle = sim_nodes.append("circle")
                .attr("r", 8)
                .style("fill", function (d) { return d.color; })
                .on("dblclick", function (d) {
                    window.open('http://' + location.host + "/information?id=" + d.id);
                })
                ;

            sim_nodes.on("mouseover", tip.show).on("mouseout", tip.hide);
            path.on("mouseover", tip_link.show).on("mouseout", tip_link.hide);

            sim_nodes.call(force.drag);

            // Use elliptical arc path segments to doubly-encode directionality.
            function tick() {
                path.attr("d", linkArc);
                sim_nodes.attr("transform", transform);
            }

            function linkArc(d) {
                const deltaX = d.target.x - d.source.x;
                const deltaY = d.target.y - d.source.y;
                const dist = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                const normX = deltaX / dist;
                const normY = deltaY / dist;
                const sourcePadding = d.left ? 17 : 12;
                const targetPadding = d.right ? 17 : 12;
                const sourceX = d.source.x + (sourcePadding * normX);
                const sourceY = d.source.y + (sourcePadding * normY);
                const targetX = d.target.x - (targetPadding * normX);
                const targetY = d.target.y - (targetPadding * normY);

                return `M${sourceX},${sourceY}L${targetX},${targetY}`;
            }

            function transform(d) {
                return "translate(" + d.x + "," + d.y + ")";
            }

            stopBlockUI('simple_graph_container', 'نمای ساده');

        }

        function showChart(data, position) {

            data.sort(function(x,y){ return x[0] === 'نامشخص' ? -1 : y[0] === 'نامشخص' ? 1 : 0; });


            document.getElementById(position).innerHTML = ""

            chart_container = position;
            chart = anychart.column();
            chart.container(chart_container);

            // create a column series and set the data
            var series = chart.column(data);

            chart.background().fill('white');

            // var state = series.normal();
            // state.fill('#1481c0')

            // x axix labels font setting
            var xAxisLabels = chart.xAxis().labels();
            xAxisLabels.fontFamily("vazir");
            xAxisLabels.fontSize(10);

            var yAxisLabels = chart.yAxis().labels();
            yAxisLabels.fontFamily("vazir");

            // Not allow labels overlapping
            var xAxis = chart.xAxis();
            xAxis.overlapMode("noOverlap");


            // tooltip content font setting
            var tooltip = chart.tooltip();
            tooltip.fontFamily("vazir");
            tooltip.titleFormat("تعداد یال‌ها: {%y}")

            // tooltip title font setting
            var title = chart.tooltip().title();
            title.fontFamily("vazir");

            chart.tooltip().hAlign('center').format("حداقل شباهت: (درصد){%x}");


            // set all axis title
            var xAxis = chart.xAxis();
            xAxis.title("آستانه شباهت (درصد)");
            xAxis.title().fontFamily('vazir');
xAxis.title().fontWeight("bold");

            var yAxis = chart.yAxis();
            yAxis.title("تعداد یال‌ها");
            yAxis.title().fontFamily('vazir');
yAxis.title().fontWeight("bold");
            chart.yAxis().labels().format("{%value}");

            chart.xAxis().labels().height(30);
            chart.yScale(anychart.scales.log());

            // initiate drawing the chart
            chart.draw();


            chart.listen('dblClick', async function (event) {
                const click_tag = event.domTarget.tag;
                document.getElementById("MinimumSimilarity").selectedIndex = click_tag["index"];

                ShowGraph();


                $("html, body").animate({
                    scrollTop: $(document).height()
                }, 1000);
            })
            chart.listen('Click', async function (event) {
                const click_tag = event.domTarget.tag;
                document.getElementById("MinimumSimilarity").selectedIndex = click_tag["index"];
            })
        }


    async function showDocumentInformation(graphEdgeList) {
        let document_result = [];

        for (let edge of graphEdgeList) {
            const id1 = edge["src_id"];
            const id2 = edge['dest_id'];
            const name1 = edge["src_name"];
            const name2 = edge["dest_name"];
            const similarity = edge["weight"];

            const document_link1 = 'http://' + location.host + "/information/?id=" + id1;
            const doc_name1 = '<a ' +
                'target="to_blank" href="' + document_link1 + '">' + name1 +
                "</a>";

            const document_link2 = 'http://' + location.host + "/information/?id=" + id2;
            const doc_name2 = '<a ' +
                'target="to_blank" href="' + document_link2 + '">' + name2 +
                "</a>";

            const detail_function = "DetailFunction(" + id1 + ',' + id2 + ")";
            const detail = '<button type="button" class="btn modal_btn" data-bs-toggle="modal" '
                + ' onclick="' + detail_function + '" data-bs-target="#myModal">جزئیات</button>';

            const row = { "id": 0, "name1": doc_name1, "name2": doc_name2, "similarity": similarity, "detail": detail }

            document_result.push(row);
        }
        document_result.sort((a, b) => (a.similarity > b.similarity) ? -1 : 1)
        let index = 1;
        for (let doc of document_result) {
            doc['id'] = index;
            index +=1;
        }
        $('#SearchTable').empty();
        $('.SearchTable').footable({
            "paging": {
                "enabled": true,
                 strings: {
                         first: '»',
                         prev:'›',
                         next: '‹',
                         last: '«'
                     }
            },
            "filtering": {
                "enabled": false
            },
            "sorting": {
                "enabled": true
            },
            "empty": "سندی یافت نشد.",
            "columns": [{
                "name": "id",
                "title": "ردیف",
                "breakpoints": "xs sm",
                "type": "number",
                "style": {
                    "width": "5%"
                }
            }, {
                "name": "name1",
                "title": "نام سند 1",
                "style": {
                    "width": "35%"
                }
            }, {
                "name": "name2",
                "title": "نام سند 2",
                "style": {
                    "width": "35%"
                }
            }, {
                "name": "similarity",
                "title": "میزان شباهت (درصد)",
                "style": {
                    "width": "15%"
                }
            }, {
                "name": "detail",
                "title": "جزئیات",
                "style": {
                    "width": "5%"
                }
            }
            ],
            "rows": document_result
        });

    }

    async function DetailFunction(id1, id2) {
        window.open('http://' + location.host + "/comparison?id=" + id1 + '__' + id2);
    }

    </script>


</body>
<!-- Intro Js -->
<script src="../../static/js/AI_similarity_graph/AI_similarity_graph_tour.js">
</script>
<script src="../../static/js/tour.js"></script>

<script src="../../static/js/UserLogSave.js"></script>
<script src="../../static/js/signout_function.js"></script>

<!-- BS Tooltips handler -->
<script src="../../static/js/tooltip_handler.js"></script>


<!-- Blocking UI -->
<script src="../../static/js/blockUI.js"></script>
<script src="../../static/js/blockUI_handler.js"></script>
<link rel="stylesheet" href="../../static/styles/loader.css">

</html>