<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-4.5.2.css">
    <link rel="stylesheet" type="text/css" href="../../static/library/bootstrap.min-5.1.2npm.css">

    <script src="../../static/js/jquery_351/jquery.min.js"></script>
    <script src="../../static/library/bootstrap-5.1.2.bundle.min.js"></script>

    <!--BS Icons -->
    <link rel="stylesheet" href="../../static/library/bootstrap-icons-1.3.0.css">
    <!-- Fontawesome Icons -->

    <link rel="stylesheet" href="../../static/library/fontawesome-5.10.0.all.css"  />
    <link rel="stylesheet" href="../../static/library/font-awesome.min-4.7.0.css">


    <!-- anychart modules -->
    <script src="../../static/library/anychart-8.10.0-core.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-graph.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-pie.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-exports.min.js"></script>
    <script src="../../static/library/anychart-8.10.0-cartesian.min.js"></script>

    <!-- Multi Select  -->
    <link rel="stylesheet" type="text/css" href="../../static/styles/multiselect/multiselect-style.css">
    <script type="text/javascript" src="../../static/js/multiselect/jquery-2.2.4.min.js"></script>
    <script type="text/javascript" src="../../static/js/multiselect/jquery.multi-select.js"></script>


    <!-- jsnetworkx -->
    <script src="https://d3js.org/d3.v3.js"></script>
    <script src="../../static/js/jsnetworkx.js"></script>


    <!-- Footable  -->
    <script src="../../static/js/footable/demo-rows.js"></script>
    <script src="../../static/js/footable/ie10-viewport-bug-workaround.js"></script>
    <script src="../../static/js/footable/footable.js"></script>
    <link href="../../static/styles/footable/footable.bootstrap.min.css" rel="stylesheet">
    <link href="../../static/styles/footable/docs.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.Glyphicons.css" rel="stylesheet">
    <link href="../../static/styles/footable/FooTable.FontAwesome.css" rel="stylesheet">

    <!-- Download Zip Files -->
    <script src="../../static/js/zipDownload/jszip.min.js"></script>
    <script src="../../static/js/zipDownload/FileSaver.min.js"></script>

    <link rel="stylesheet" type="text/css" href="../../static/library/tom-select-2.2.1.css">
    <script src="../../static/library/tom-select.complete-2.2.1.min.js"></script>
    <script type="text/javascript" src="../../static/js/searchable-select.js"></script>

    <link rel="stylesheet" href="../../static/styles/index2.css">
    <link rel="stylesheet" href="../../static/styles/adaptation.css">

    <link rel="stylesheet" type="text/css" href="../../static/library/jquerysctipttop.css">

    <!-- Intro Js -->
    <script src="../../static/library/intro.min-4.3.0.js"></script>
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs.min-4.3.0.css">
    <link rel="stylesheet" type="text/css" href="../../static/library/introjs-rtl.min-4.3.0.css">
    <link rel="stylesheet" href="../../static/styles/user_guide_tour.css">



    <!-- Notyf  -->
    <link rel="stylesheet" type="text/css" href="../../static/library/notyf.min-npm.css">
    <script src="../../static/library/notyf.min.js"></script>


    <!--<script type="text/javascript" src="http://l2.io/ip.js?var=myip">
    </script>-->

    <meta charset="UTF-8">
    <title>ابزار تنظیم‌گری</title>
    {% include "doc/title_icon.html" %}

    <script>
        $(document).ready(function () {

            // Active panel
            $('#RegularityDropdown').addClass('active');
            $('#regularity_panel').addClass('active');

            // chart controller
            $('#pie_chart_btn').on('click', function (e) {
                $('#tools_dist_chart_container').fadeOut();
                $('#tools_pie_chart_container').fadeIn();
            });

            $('#bar_chart_btn').on('click', function (e) {
                $('#tools_pie_chart_container').fadeOut();
                $('#tools_dist_chart_container').fadeIn();
            });


            $('#regularity').addClass('active');
            $('select#language').on('change', function (e) {

                let selected_language = this.value;
                let current_url = window.location.href;
                if (selected_language === 'England') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'en')
                    window.location = requested_url;
                } else if (selected_language === 'Russia') {
                    let page_name = current_url.split('/')[3]
                    let requested_url = current_url.replace(page_name, 'ru')
                    window.location = requested_url;
                }

            });


        });
    </script>

</head>

<body>

    <!-- Menu -->

    <nav dir="rtl" class="navbar nav_menu navbar-expand-lg fixed-top p-0 mt-0">
        {% include "doc/header2.html" %}
    </nav>

    <!-- Main Container includes: Form Fields, Tab Pills, Tab Panes -->
    <div class="row flex-row-reverse px-0 py-5 px-md-5 py-md-5 m-0 mt-4">

        <!-- Form Fields -->
        <form action="" class="custom-control mx-auto needs-validation" id="info_form" enctype="multipart/form-data"
            method="post" novalidate>

            <!-- Primary Fields in First Row -->
            <div class="row flex-row-reverse mt-2 mx-auto">

                <!-- Country Input -->
                <div class="col-md-6  pt-3 col-12 col-lg-2 bg-light" dir="rtl">

                    <label class=" text-right bg-light float-right" style="direction: rtl;;">مجموعه سند:</label>
                    <select dir="rtl" id="country" name="country" class="form-select text-right float-right searchable-select"
                        style="direction: rtl;" onchange="CountryChanged()">
                        {% for k,v in countries.items %}
                        <option value="{{ k }}">{{ v }}</option>
                        {% endfor %}
                    </select>

                </div>


                <!--  Buttons -->
                <div class="col-lg-4 col-md-6 pt-5 col-12">
                    <button id="advanced_search" type="button" class="btn float-right" data-bs-toggle="collapse"
                        data-bs-target="#advanced_fields" aria-expanded="true" aria-controls="advanced_fields">تنظیمات
                        پیشرفته</button>
                    <button type="button" id="document_search" onclick="ShowResult()"
                        class="btn d-flex float-right mr-4">
                        <div class="spinner-border text-light" role="status">
                            <span class="sr-only">درحال جستجو ...</span>
                        </div>
                        نمایش
                    </button>
                </div>

            </div>

            <!-- Advanced Fields in Second Row -->
            <div id="advanced_fields" class="collapse show row flex-row-reverse mx-auto mt-4">

                <!-- Search Box input -->
                <div class="col-md-6 pt-3 col-12 col-lg-3 mt-1">
                    <label class="float-right" style="direction: rtl;"> کلیدواژه‌های کسب‌وکار<span
                            style="color: red">(*)</span>:</label>
                    <input style="direction: rtl;" class="float-left form-control text-right"
                        placeholder="کلیدواژه اول/ کلیدواژه دوم/ ..." type="text" required="" name="KeywordsBox"
                        id="KeywordsBox" value="" name="KeywordsBox">
                </div>

                <!-- Regularity Area -->
                <div class="col-md-6  pt-3 col-12 col-lg-3 mt-1 bg-light" dir="rtl">

                    <label class=" text-right bg-light float-right" style="direction: rtl;;"> حوزه تنظیم‌گری:</label>

                    <select onchange="AreaChanged()" id="RegularityAreaSelect"
                        class="form-select text-right float-right searchable-select" style="direction: rtl;">
                    </select>

                </div>

                <!-- Regulator input -->
                <div class="col-md-6 pt-3 col-12 col-lg-3 mt-1 bg-light" dir="rtl">

                    <label class=" text-right bg-light float-right" style="direction: rtl;;">تنظیم‌گر:</label>

                    <select id="RegulatorSelect" class="form-select text-right float-right searchable-select" style="direction: rtl;">
                    </select>

                </div>

                <!-- Regularity Tools input -->
                <div class="col-md-6 pt-3 col-12 col-lg-3 mt-1 bg-light" dir="rtl">

                    <label class="text-right bg-light float-right" style="direction: rtl;;">ابزار تنظیم<span
                            style="color: red">(*)</span>:</label>

                    <select id="RegularityToolsSelect" class="form-select text-right float-right searchable-multi-select"
                        style="direction: rtl;">
                    </select>

                </div>



            </div>

        </form>

        <div dir="rtl" class="row w-100 p-0">
            <!--Original Tabs -->
            <ul id="original_tabs" class="nav nav-pills mt-5 mx-auto  pr-3 pr-sm-0  float-right  d-block" id="pills-tab"
                role="tablist">

                <li class="nav-item float-right" role="presentation">
                    <button id="search_result_tab" class="nav-link active" data-bs-toggle="pill"
                        data-bs-target="#search_result_pane" type="button" role="tab" aria-controls="search_result_pane"
                        aria-selected="true">نتایج جست‌وجو</button>
                </li>

                <li class="nav-item float-right" role="presentation">
                    <button id="regulators_graph_tab" class="nav-link" data-bs-toggle="pill"
                        data-bs-target="#regulators_graph_pane" type="button" role="tab"
                        aria-controls="regulators_graph_pane" aria-selected="false">گراف تنظیم‌گران</button>
                </li>


                <li class="nav-item float-right" role="presentation">
                    <button id="information_chart_tab" class="nav-link" data-bs-toggle="pill"
                        data-bs-target="#information_chart_pane" type="button" role="tab"
                        aria-controls="information_chart_pane" aria-selected="false">داشبورد آماری</button>
                </li>

                <!-- Download Buttons -->
                <button type="button" data-bs-toggle="tooltip" data-bs-placement="top" title="دانلود اسناد"
                    class="btn float-left p-0 px-1 mt-2" id="DownloadBtn" onclick="DownloadSerachResultFunction()"
                    type="button">
                    <i class="far fa-file-archive m-0" style="font-size: 25px;margin: 0px;"></i>

                </button>

                <button class="btn float-left p-0 px-1 mt-2" id="ExportExcel" data-bs-toggle="tooltip"
                    data-bs-placement="top" title="خروجی اکسل" onclick="ExportExcelSerachResultFunction()"
                    type="button">
                    <i class="far fa-file-excel text-success m-0" style="font-size: 25px;margin: 0px;"></i>
                </button>

                <!-- Result Count -->
                <p id="DocumentCount" dir="rtl" class="text-left float-left text-secondary  pl-2"></p>

            </ul>

            <!-- Original Panes -->
            <div id="original_pane" class="tab-content float-right px-1 bg-white" id="pills-tabContent">

                <!-- Search Result Pane -->
                <div id="search_result_pane" class="tab-pane w-100 fade show active float-right" role="tabpanel"
                    aria-labelledby="search_result_tab">

                    <!-- Search Result table -->
                    <div class="table-responsive search_result_table mt-4">
                        <table class="table table-striped SearchTable" style="min-height: 200px;" id="SearchTable">
                        </table>
                    </div>

                </div>


                <!-- Regulators Graph Pane -->
                <div id="regulators_graph_pane" class="tab-pane w-100 fade float-right" role="tabpanel"
                    aria-labelledby="regulators_graph_tab">
                    <!-- Search Result table -->
                    <div class="row mt-4 w-100 flex-row mx-0 px-4 pb-5">

                        <div id="regulators_graph_container" class="w-100 border" style="height: 500px;">
                        </div>
                    </div>

                </div>


                <!-- Information Chart Pane -->
                <div id="information_chart_pane" class="tab-pane w-100 fade float-right" role="tabpanel"
                    aria-labelledby="information_chart_tab">
                    <!-- Tools distribution segment -->

                    <button id="bar_chart_btn" data-bs-toggle="tooltip" data-bs-placement="left" title="نمودار ستونی"
                        class="btn px-1 py-0 mr-2 mt-1"><i style="font-size: 25px;"
                            class="bi bi-bar-chart-fill text-primary"></i></button>
                    <br>

                    <button id="pie_chart_btn" data-bs-toggle="tooltip" data-bs-placement="left" title="نمودار دایره‌ای"
                        class="btn px-1 py-0 mr-2 mb-1">
                        <i style="font-size: 25px;" class="bi bi-pie-chart-fill text-primary"></i>
                    </button>

                    <div id="tools_pie_chart_container" style="height: 500px" class="bg-white w-100 border border-2 p-4 mt-4">
                    </div>

                    <div id="tools_dist_chart_container" style="height: 500px" class="bg-white w-100 p-4  border border-2 p-3 mt-4">
                    </div>
                </div>

            </div>

        </div>


    </div>


    <!-- Details Modal Container -->
    <div class="modal fade" id="detailModal">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="ModalHeader" class="modal-title">عنوان</h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div id="DetailText" class="modal-body bg-light text-justify">
                </div>

                <!-- Modal footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
                </div>

            </div>
        </div>
    </div>


    <!-- Edges Modal Container -->
    <button type="button" id="edge_modal_btn" class="btn d-none modal_btn" data-bs-toggle="modal"
        data-bs-target="#edge_modal"></button>

    <div class="modal fade" id="edge_modal">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <div id="edge_modal_header" class="modal-title">
                        <span id="source_node_label" class="text-secondary">مبدأ: </span>
                        <h5 id="source_node_modal_header" class="d-inline-block text-right"></h5>
                        <br>
                        <span id="destination_node_label" class="text-secondary">مقصد: </span>
                        <h6 id="destination_node_modal_header" class="d-inline-block text-right"></h6>
                    </div>

                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div id="regulators_paragraphs" class="modal-body bg-light text-justify">
                    <div id="edge_modal_body">

                    </div>
                </div>


                <!-- Modal footer -->
                <div id="modal_footer" class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن
                    </button>
                </div>

            </div>
        </div>
    </div>




    <!-- Tools Modal Container -->

    <button type="button" id="tool_modal_btn" class="btn d-none modal_btn" data-bs-toggle="modal"
        data-bs-target="#tool_modal"></button>

    <div class="modal fade" id="tool_modal">
        <div class="modal-dialog modal-dialog-scrollable modal-xl">
            <div class="modal-content">

                <!-- Modal Header -->
                <div style="direction: rtl !important;" class="modal-header">
                    <h5 id="ToolModalHeader" class="modal-title">عنوان</h5>
                    <button type="button" class="btn-close m-0" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div id="ToolParagraphsModalBody" class="modal-body bg-light text-justify">
                </div>

                <!-- Modal footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
                </div>

            </div>
        </div>
    </div>



    <!-- Scrollbar -->
    <button id="scroll_btn" class="p-0" title="بالای صفحه" onclick="topFunction()">
        <i class="far fa-caret-square-up"></i>
    </button>

    <script src="../../static/js/logincheck.js"></script>

    <script src="../../static/js/scroll_button_handler.js">
    </script>

    <script src="../../static/js/adaption/adaption_tour.js">
    </script>
    <script src="../../static/js/tour.js"></script>


    <!-- Toast -->
    <div class="position-absolute top-0 start-50 translate-middle p-3" style="z-index: 11;margin-top:95px;">
        <div dir="rtl" id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div dir="rtl" class="toast-header">
                <img width="25px;" src="../../static/icons/logo/logo1.png" class="rounded mx-0" alt="...">
                <strong dir="rtl" class="w-100 mr-2 mt-1">هوش‌یار</strong>
                <button type="button" class="btn-close float-left ml-0" data-bs-dismiss="toast"
                    aria-label="Close"></button>
            </div>
            <div class="toast-body">
                <i style="position: relative; top: -7px; font-size: 18px;"
                    class="bi bi-exclamation-triangle-fill  text-warning"></i>
                <span id="toast_message">
                    موضوعی انتخاب نشده‌است.
                </span>
            </div>
        </div>
    </div>

</body>
<!-- save log user -->
<script>
    async function UserLog(form_data) {
        if (getCookie("username") !== "") {
            const user_name = getCookie("username")
            let page_url = window.location.pathname
            const user_ip = "127.0.0.0"
            page_url = page_url.slice(0, -1);
            if (page_url === "") {
                page_url = "/0";
            }


            let link_request = 'http://' + location.host + "/UserLogSaved/" + user_name + page_url + "/" + user_ip + "/";

            $.ajax({
                url: link_request,
                data: form_data,
                type: 'POST',
                contentType: false,
                processData: false,
                async: true,


            }).done(function (res) {
                console.log("done")

            }).fail(function (res) {
                console.log("fail")
            });

        }
    }
</script>

<script>
    initSearchableSelects();
    let preprocessed_keywords_text = 'empty';
    let SearchResultValue = {}
    let multiselect_tool_value = '';

    init()


    container_id_list = ['SearchTable', 'DocumentCount',
        'regulators_graph_container',
        'tools_pie_chart_container', 'tools_dist_chart_container']

    function clearPrevResults(container_id_list) {

        for (container_id of container_id_list) {
            document.getElementById(container_id).innerHTML = "";
        }
    }


    async function init() {
        $('#bar_chart_btn').click();

        document.getElementById("document_search").disabled = true;

        const country_id = document.getElementById("country").value

        /****************** Regularity Area List ****************************/
        let request_link = 'http://' + location.host + "/GetRegularityAreaList/";
        let response = await fetch(request_link).then(response => response.json());
        response = response["RegularityAreaList"]

        let options = [{ value:'0', text: 'همه' }];
        for (var i = 0; i < response.length; i++) {
            const area_id = response[i]["id"]
            const area_name = response[i]["area_name"]

            options.push( {value: area_id, text: area_name});
        }
        syncSelectOptions("RegularityAreaSelect", options);

        /****************** Regulators List ****************************/
        await AreaChanged()
        /****************** Regularity Tools List ****************************/

        request_link = 'http://' + location.host + "/GetRegularityToolsList/";
        response = await fetch(request_link).then(response => response.json());
        response = response["RegularityToolsList"]

        options = [{ value: "0", text: "همه"}];

        for (var i = 0; i < response.length; i++) {
            const tool_id = response[i]["id"]
            const tool_name = response[i]["tool_name"]

            options.push({value:tool_id, text: tool_name});
        }

        syncSelectOptions('RegularityToolsSelect', options)
        document.getElementById("document_search").disabled = false;

        //user log
        let form_data = new FormData()
        let detail_type = "نمایش پنل"
        form_data.append('detail_type', detail_type);
        UserLog(form_data)
    }

    async function AreaChanged() {
        let selectd_area_id = document.getElementById('RegularityAreaSelect').value

        let request_link = 'http://' + location.host + "/GetRegulatorsByAreaId/" + selectd_area_id + "/";
        let response = await fetch(request_link).then(response => response.json());
        response = response["RegulatorsList"]

        let options = [{ value:'0', text: 'همه' }];
        for (var i = 0; i < response.length; i++) {
            const regulator_id = response[i]["id"]
            const regulator_name = response[i]["regulator_name"]

            options.push( {value: regulator_id, text: regulator_name});

        }
        syncSelectOptions("RegulatorSelect", options);

    }


    function CountryChanged() {
        clearPrevResults(container_id_list);
        init()
    }

    async function ShowResult() {
        clearPrevResults(container_id_list);

        multiselect_tool_value = await GetMultiSelectToolsValue();



        const country_id = document.getElementById("country").value;
        const area_id = document.getElementById("RegularityAreaSelect").value;
        const regulator_id = document.getElementById("RegulatorSelect").value;


        const keywords_text = document.getElementById("KeywordsBox").value;

        //user log
        let form_data = new FormData()
        let detail_type = "نتایج جست و جو"
        let country_name_select = $("#country option:selected").text();
        var multiselect_tool_value_search = "";
        $("#RegularityToolsSelect option:selected").each(function () {
            multiselect_tool_value_search += $(this).text() + "، ";
        });
        let keywords_text_search = keywords_text
        let RegularityArea_Select = $("#RegularityAreaSelect option:selected").text();
        let Regulator_Select = $("#RegulatorSelect option:selected").text();
        form_data.append('detail_type', detail_type);
        form_data.append('country_name_select', country_name_select);
        form_data.append('keywords_text_search', keywords_text_search);
        form_data.append('RegularityArea_Select', RegularityArea_Select);
        form_data.append('Regulator_Select', Regulator_Select);
        form_data.append('Regularity_tool', multiselect_tool_value_search);
        UserLog(form_data)
        let keywords_list = []

        keywords_list = keywords_text.split('/');
        keywords_list = keywords_list.map(function (keyword) {
            return keyword.trim();
        })

        keywords_list = keywords_list.filter(keyword => (keyword != '' && keyword != ' '));

        preprocessed_keywords_text = keywords_list.toString()

        if (preprocessed_keywords_text == '') {
            preprocessed_keywords_text = 'empty'
        }

        if (multiselect_tool_value == "") {
            showToastMessage(' ابزار تنظیم انتخاب نشده‌است.');
        }
        else if (false && preprocessed_keywords_text == 'empty') {
            showToastMessage('کلیدواژه‌ای وارد نشده‌است.')
            $('#KeywordsBox').focus();

        }
        else {
            notyf.dismissAll();
            startBlockUI('SearchTable');
            startBlockUI('information_chart_pane');

            await SpinnerModeFunction("Active");


            request_link = 'http://' + location.host + "/SearchDocumentsByRegulatorsKeywords/"
                + country_id + "/" + multiselect_tool_value + "/" + area_id + "/" + regulator_id + "/" + preprocessed_keywords_text + "/";
            response = await fetch(request_link).then(response => response.json());

            documents_information_dict = response["documents_information_dict"];
            tools_distribution_data_dict = response["tools_distribution_data_dict"];


            showDocumentInformation(documents_information_dict, area_id, regulator_id, multiselect_tool_value, keywords_text);
            stopBlockUI('SearchTable', 'نتایج جست‌وجو');

            showToolsPieChart('tools_pie_chart_container', tools_distribution_data_dict)
            showToolsDistChart('tools_dist_chart_container', tools_distribution_data_dict)

            stopBlockUI('information_chart_pane', 'داشبورد آماری');

            /****************** Get Regulators Graph Data ****************************/
            startBlockUI('regulators_graph_pane');

            request_link = 'http://' + location.host + "/GetRegulatorsGraphData/"
                + country_id + "/" + multiselect_tool_value + "/" + area_id + "/" + regulator_id + "/" + preprocessed_keywords_text + "/";
            response = await fetch(request_link).then(response => response.json());

            regulators_graph_data = response["regulators_graph_data"];

            showRegulatorsGraph('regulators_graph_container', regulators_graph_data, 'Directed', country_id);

            stopBlockUI('regulators_graph_pane', 'گراف تنظیم‌گران');

            await SpinnerModeFunction("Disable");


        }

        

    }


    async function GetMultiSelectToolsValue() {
        var e = document.getElementById("RegularityToolsSelect");
        var selected = [...e.options]
            .filter(option => option.selected)
            .map(option => option.value)
        return selected.join("__")
    }

    async function showToolsPieChart(chart_container, chart_data_dict) {
        pie_chart_data = []
        document.getElementById(chart_container).innerHTML = "";

        // create pie chart data
        for (const [tool_id, tool_info] of Object.entries(chart_data_dict)) {

            pie_data = { x: tool_info['tool_name'], value: tool_info['tool_count'] }

            pie_chart_data.push(pie_data)
        }

        // create a chart and set the data
        chart = anychart.pie(pie_chart_data);
        chart.animation(true);
        // set the chart title
        chart.title("فراوانی نسبی ابزارهای تنظیم‌گری");
        chart.title().fontFamily('vazir');
        // set the container id
        chart.container(chart_container);


        chart.labels().enabled(true);
        chart.labels().fontSize(14);
        chart.labels().fontFamily('vazir');
        chart.labels().fontWeight(600);

        // set the position of labels
        chart.labels().position("outside");

        // configure connectors
        chart.connectorStroke({ color: "#595959", thickness: 2, dash: "2 2" });


        chart.tooltip().title().fontFamily('vazir');
        chart.tooltip().fontFamily('vazir');
        chart.tooltip().format("تعداد پاراگراف:  {%value}\n درصد فراوانی: {%percentValue}{numDecimals:1,trailingZeros:true}");



        // set the explosion range in different states
        chart.normal().explode("0.2%");
        chart.hovered().explode("0.2%");
        chart.selected().explode("3%");


        // enable the legend
        chart.legend(true);


        var legend = chart.legend();

        // Enable drag and drop
        legend.drag(true);


        // Set maximum width.
        legend.maxWidth("50%");
        legend.maxHeight("10%");

        legend.fontFamily('vazir')

        // set position mode
        legend.positionMode("outside");
        // set position and alignement
        legend.position("bottom");
        legend.align("center");
        legend.itemsLayout("horizontalExpandable");


        // legend settings
        var paginator = chart.legend().paginator();
        // set paginator layout
        paginator.layout("horizontal");
        // place paginator on the right
        paginator.orientation("bottom");

        // initiate drawing the chart
        chart.draw();

        chart.listen("mouseOver", function (e) {
            document.body.style.cursor = "pointer";
        });
        chart.listen("mouseOut", function (e) {
            document.body.style.cursor = "auto";
        });

        chart.listen('Click', async function (event) {

            const click_tag = event.domTarget.tag;
            const column_index = click_tag["index"]
            const pie_segment = pie_chart_data[column_index];
            const tool_name = pie_segment['x']

            showToolModal(tool_name);


        });

    }

    async function showToolsDistChart(chart_container, chart_data_dict) {

        dist_chart_data = []
        document.getElementById(chart_container).innerHTML = "";


        // sort chart data
        var sorted_items = Object.keys(chart_data_dict).map(function (key) {
            return [chart_data_dict[key]['tool_name'], chart_data_dict[key]['tool_count']];
        });

        sorted_chart_data = sorted_items.sort(function (first, second) {
            return second[1] - first[1];
        })

        //

        chart = anychart.column();
        chart.container(chart_container);

        // create a column series and set the data
        var series = chart.column(sorted_chart_data);


        // set the chart title
        chart.title("فراوانی مطلق ابزارهای تنظیم‌گری");
        chart.title().fontFamily('vazir');

        chart.animation(true);
        chart.background().fill('#f8f9fa');

        chart.background().fill('white');

        series.normal().fill("#488fb8", 1);
        series.normal().stroke("#488fb8", 0);

        // x axix labels font setting
        var xAxisLabels = chart.xAxis().labels();
        xAxisLabels.fontFamily("vazir");
        xAxisLabels.rotation(315);

        var yAxisLabels = chart.yAxis().labels();
        yAxisLabels.fontFamily("vazir");

        // Not allow labels overlapping
        var xAxis = chart.xAxis();
        xAxis.overlapMode("noOverlap");

        // tooltip content font setting
        var tooltip = chart.tooltip();
        tooltip.fontFamily("vazir");
        tooltip.textDirection('rtl');

        tooltip.hAlign('center').format("{%value} پاراگراف");


        // tooltip title font setting
        var title = chart.tooltip().title();
        title.fontFamily("vazir");

        // Set text direction.
        title.textDirection('rtl');

        title.hAlign('center')

        // set all axis title
        var xAxis = chart.xAxis();
        xAxis.title("ابزار تنظیم‌گری");
        xAxis.title().fontFamily('vazir');
        xAxis.title().fontWeight("bold");

        var yAxis = chart.yAxis();
        yAxis.title("تعداد پاراگراف");
        yAxis.title().fontFamily('vazir');
        yAxis.title().fontWeight("bold");
        chart.yAxis().labels().format("{%value}");

        chart.xAxis().labels().height(40);

        chart.draw();

        chart.listen("mouseOver", function (e) {
            document.body.style.cursor = "pointer";
        });
        chart.listen("mouseOut", function (e) {
            document.body.style.cursor = "auto";
        });

        // Interactivity
        chart.listen('Click', async function (event) {

            const click_tag = event.domTarget.tag;
            const column_index = click_tag["index"]
            const tool_name = sorted_chart_data[column_index][0];
            showToolModal(tool_name);
        });

    }


    async function showToolModal(tool_name) {

        startFullPageBlockUI();
        const modal_header = 'ابزار تنظیم‌گری: ' + tool_name
        const country_id = document.getElementById("country").value;
        const area_id = document.getElementById("RegularityAreaSelect").value;
        const regulator_id = document.getElementById("RegulatorSelect").value;
        const keywords = preprocessed_keywords_text.split(",")
        // set modal header
        $('#ToolModalHeader').text(modal_header)


        // set modal body
        $('#ToolParagraphsModalBody').empty();

        request_link = 'http://' + location.host + "/GetRegularityParagraphsByToolName_Modal/"
            + country_id + "/" + tool_name + "/" + area_id + "/" + regulator_id + "/" + preprocessed_keywords_text + "/";
        response = await fetch(request_link).then(response => response.json());

        tool_paragraphs_result = response["tool_paragraphs_result"];

        modal_paragraphs_tag = '';

        for (paragraph of tool_paragraphs_result) {
            console.log(paragraph)
            document_name = paragraph['document_name'];
            document_id = paragraph['document_id'];
            document_address = 'http://' + location.host + "/information/?id=" + document_id
            document_link = '<a target="blank" href = "' + document_address + '">' + document_name + ':</a>'

            doc_tag = '<h6 class="bold">' + document_link + '</h6>'

            // highlight paragraphs
            paragraph_text = await highlightParagraphs(paragraph, keywords);


            paragraph_tag = '<li dir="rtl" class = "text-right lh-lg">' + doc_tag + paragraph_text + '</li>'
            modal_paragraphs_tag += paragraph_tag

        }

        document.getElementById('ToolParagraphsModalBody').innerHTML = '<ol start="1"> ' + modal_paragraphs_tag + '</ol>';

        stopFullPageBlockUI('انتخاب ابزار تنظیم');
        $("#tool_modal_btn").click();

    }

    async function showDocumentInformation(documents_information_dict, area_id, regulator_id, tools_id, keywords_text) {

        SearchResultValue = documents_information_dict;

        document.getElementById("DocumentCount").innerText = (Object.keys(documents_information_dict).length).toString() + " سند یافت شد.";
        let index = 1;
        let document_result = []


        for (const [doc_id, doc_info] of Object.entries(documents_information_dict)) {


            const document_id = doc_id
            const document_name = doc_info["name"]

            const document_subject = doc_info['subject']
            const document_approval_reference = doc_info['approval_reference']
            const document_approval_date = doc_info['approval_date']

            const tool_name = doc_info["tool_name"]
            let document_regulators = doc_info["regulators"]
            document_regulators = document_regulators.toString().replaceAll(',', '<br>');

            const document_link = 'http://' + location.host + "/information/?id=" + document_id
            const doc_name = '<a target="blank" href="' + document_link + '">' + document_name + "</a>"

            const detail_function = "DetailFunction(" + document_id + "," + area_id + "," + regulator_id + ")"
            const detail = '<button type="button" class="btn modal_btn" data-bs-toggle="modal" ' + ' onclick="' + detail_function + '" data-bs-target="#detailModal">جزئیات</button>'

            const row = {
                "id": index, "name": doc_name,
                'document_subject': document_subject,
                'document_approval_reference': document_approval_reference,
                'document_approval_date': document_approval_date,
                "regulators (tool)": document_regulators,
                "detail": detail
            }
            document_result.push(row)
            index += 1
        }
        $('#SearchTable').empty();
        $('.SearchTable').footable({
            "paging": {
                "enabled": true,
                strings: {
                         first: '»',
                         prev:'›',
                         next: '‹',
                         last: '«'
                     }
            },
            "filtering": {
                "enabled": false
            },
            "sorting": {
                "enabled": true
            },
            "empty": "سندی یافت نشد.",
            "columns": [{
                "name": "id",
                "title": "ردیف",
                "breakpoints": "xs sm",
                "type": "number",
                "style": {
                    "width": "5%"
                }
            }, {
                "name": "name",
                "title": "نام سند",
                "style": {
                    "width": "35%"
                }
            }, {
                "name": "document_subject",
                "title": "موضوع سند",
                "style": {
                    "width": "15%"
                }
            }, {
                "name": "document_approval_reference",
                "title": "مرجع تصویب",
                "style": {
                    "width": "10%"
                }
            }, {
                "name": "document_approval_date",
                "title": "تاریخ تصویب",
                "style": {
                    "width": "10%"
                }
            }, {
                "name": "regulators (tool)",
                "title": "تنظیم‌گر (ابزار تنظیم)",
                "style": {
                    "width": "25%"
                }
            }, {
                "name": "detail",
                "title": "جزئیات",
                "style": {
                    "width": "5%"
                }
            }
            ],
            "rows": document_result
        });

    }



    async function DetailFunction(document_id, area_id, regulator_id) {

        let tools_id = multiselect_tool_value;
        let request_link = 'http://' + location.host + "/GetRegularityParagraphsDetails_Modal/" + document_id + "/" + tools_id + "/" + area_id + "/" + regulator_id + "/" + preprocessed_keywords_text + "/"

        let response = await fetch(request_link).then(response => response.json());

        /*  Show detail Result */
        let document_paragraphs_result = response["document_paragraphs_result"]
        let document_name = response["document_name"]

        await showDetailsModal(document_id, document_name, document_paragraphs_result)

    }

    async function showDetailsModal(document_id, document_name, paragraphs_list) {
        /* Title Text */
        const link = 'http://' + location.host + "/information/?id=" + document_id
        let title_tag = "<a target='blank' href='" + link + "'>" + document_name + "</a>"
        document.getElementById("ModalHeader").innerHTML = title_tag

        /* Body Text */
        const keywords = preprocessed_keywords_text.split(",")

        document.getElementById("DetailText").innerHTML = ""

        for (let paragraph of paragraphs_list) {

            highlighted_paragraph = await highlightParagraphs(paragraph, keywords)
            tag = "<li class='mb-3 lh-lg'>" + highlighted_paragraph + "</li>"
            document.getElementById("DetailText").innerHTML += tag;
        }
        document.getElementById("DetailText").innerHTML = "<ul>" + document.getElementById("DetailText").innerHTML + "</ul>"

    }

    async function highlightParagraphs(paragraph, keywords) {

        mojavez_pattern_keyword_1 = 'مجوز از'
        mojavez_pattern_keyword_2 = 'با مجوز'
        mojavez_pattern_keyword_3 = 'مجوز رسمی'
        mojavez_pattern_keyword_4 = 'مجوز رسمی از'
        mojavez_pattern_keywords_list = [mojavez_pattern_keyword_1, mojavez_pattern_keyword_2, mojavez_pattern_keyword_3, mojavez_pattern_keyword_4]


        ejaze_puntuations = ['،', ' ـ ', '.']

        paragraph_regulator = paragraph['regulator']
        paragraph_text = paragraph['text']
        paragraph_tool = paragraph['tool']

        if (paragraph_tool == 'مجوز') {

            for (tool_pattern of mojavez_pattern_keywords_list) {
                if (paragraph_text.includes(tool_pattern)) {
                    tool_tag = "<span class='bg-warning text-white px-1 rounded'>" + tool_pattern + "</span> "
                    regulator_tag = "<span class='bg-success text-white px-1 ml-1 rounded'>" + paragraph_regulator + "</span> "
                    paragraph_text = paragraph_text.replaceAll(tool_pattern + ' ' + paragraph_regulator, tool_tag + regulator_tag);
                    paragraph_text = paragraph_text.replaceAll(tool_pattern + paragraph_regulator, tool_tag + regulator_tag);
                }

            }

            let operator_tag = ""
            console.log(paragraph['operators'])
            for (operator of paragraph['operators']) {
                operator_tag = "<span class='bg-info text-white px-1 ml-1 rounded'>" + operator + "</span> "
                paragraph_text = paragraph_text.replaceAll(operator, operator_tag)
            }

        }
        else if (paragraph_tool == 'اذن') {
            tool_tag = "<span class='bg-warning text-white px-1 rounded'>" + paragraph_tool + "</span> "
            regulator_tag = "<span class='bg-success text-white px-1 ml-1 rounded'>" + paragraph_regulator + "</span> "
            paragraph_text = paragraph_text.replaceAll(paragraph_tool + ' ' + paragraph_regulator, tool_tag + regulator_tag);

        }
        else if (paragraph_tool == 'اجازه') {


            pattern_1 = 'اجازه داده می‌شود';
            pattern_2 = 'اجازه داده می شود';
            pattern_3 = 'اجازه داده  میشود';

            patterns = [pattern_1, pattern_2, pattern_3];

            for (pattern of patterns) {
                let index = paragraph_text.indexOf(pattern);
                if (index != -1) {
                    start_index = index;

                    for (let i = start_index; i >= 0; i--) {
                        if (ejaze_puntuations.includes(paragraph_text[i]) || i == 0) {
                            cropped_text = paragraph_text.substring(i, start_index)
                            if (cropped_text.indexOf('به ') != - 1) {

                                let new_index = cropped_text.indexOf('به ') + 3;
                                actor = cropped_text.substring(new_index, start_index - 1);

                                patter_tag = "<span class='bg-secondary text-white px-1 rounded'>" + pattern + "</span> "
                                actor_tag = "<span class='border rounded border-success border-2 px-1 ml-1 rounded'>" + actor + "</span> "
                                paragraph_text = paragraph_text.replaceAll(actor + ' ' + pattern, actor_tag + ' ' + patter_tag);

                            }

                            break;
                        }
                    }
                }
            }

            // only tool name
            tool_tag = "<span class='bg-secondary text-white px-1 rounded'>" + paragraph_tool + "</span> "
            paragraph_text = paragraph_text.replaceAll(paragraph_tool, tool_tag);

        }

        else {
            tool_tag = "<span class='bg-secondary text-white px-1 rounded'>" + paragraph_tool + "</span> "
            paragraph_text = paragraph_text.replaceAll(paragraph_tool, tool_tag);

        }

        // vefgh_tag = "<span class='bg-secondary text-white px-1 rounded'>" + 'وفق' + "</span> "
        // paragraph_text = paragraph_text.replaceAll('وفق', vefgh_tag);

        for (word of keywords) {

            let tag = "<span class='bg-primary text-white px-1 rounded'>" + word + "</span> "

            if (paragraph_text.startsWith(word))
                paragraph_text = paragraph_text.replaceAll(word + ' ', tag + ' ');

            // paragraph_text = paragraph_text.replaceAll(word + ' ', tag + ' ');
            paragraph_text = paragraph_text.replaceAll(word , tag );
            paragraph_text = paragraph_text.replaceAll(' ' + word + ' ', ' ' + tag + ' ');
            paragraph_text = paragraph_text.replaceAll('(' + word + ')', '(' + tag + ')');
            paragraph_text = paragraph_text.replaceAll(' ' + word + '،', ' ' + tag + '،');
            paragraph_text = paragraph_text.replaceAll('(' + word + '،', '(' + tag + '،');
        }

        return paragraph_text;

    }


    async function showRegulatorsGraph(chart_container, chart_data, graph_type, country_id) {

        document.getElementById(chart_container).innerHTML = ''
        // create a chart and set the data
        var chart = anychart.graph(chart_data);

        console.log(chart_data)
        // set the container id
        chart.container(chart_container);

        // configure labels of keywords
        let keywords = chart.group("keywords");
        let regulators = chart.group("regulators");
        let areas = chart.group("areas");
        let operators = chart.group("operators");



        if (keywords != undefined) {

            keywords.normal().shape("diamond");
            keywords.hovered().shape("diamond");
            keywords.selected().shape("diamond");

            keywords.normal().height(45);
            keywords.hovered().height(60);
            keywords.selected().height(35);
            // set the fill of nodes in groups
            keywords.normal().fill("#16b2f5");
            keywords.hovered().fill("white");
            keywords.selected().fill("#16b2f5")

            // set the stroke of nodes in groups
            keywords.normal().stroke(null);
            keywords.hovered().stroke("#16b2f5", 3);
            keywords.selected().stroke("#333333", 3);

            keywords.labels().enabled(true);
            keywords.labels().format("{%id}").fontFamily('vazir');
            keywords.labels().fontSize(14);
            keywords.labels().fontWeight(600);
        }

        if (regulators != undefined) {
            regulators.normal().height(45);
            regulators.hovered().height(50);
            regulators.selected().height(40);
            regulators.normal().stroke(null);

            regulators.labels().enabled(true);
            regulators.labels().format("{%id}").fontFamily('vazir');
            regulators.labels().fontSize(14);
            regulators.labels().fontWeight(600);
        }


        if (operators != undefined) {
            operators.normal().height(35);
            operators.hovered().height(40);
            operators.selected().height(40);
            operators.normal().stroke(null);

            operators.labels().enabled(true);
            operators.labels().format("{%id}").fontFamily('vazir');
            operators.labels().fontSize(14);
            operators.labels().fontWeight(600);


        }

        if (areas != undefined) {
            areas.normal().height(35);
            areas.hovered().height(40);
            areas.selected().height(40);
            areas.normal().stroke(null);

            areas.labels().enabled(true);
            areas.labels().format("{%id}").fontFamily('vazir');
            areas.labels().fontSize(14);
            areas.labels().fontWeight(600);

            chart.edges().tooltip().format(" تنظیم‌گر:  {%from} \n حوزه:  {%to}\n ابزار تنظیم:  {%regulator_tool_name}");
        }

        chart.nodes().tooltip().format("{%id}");
        chart.nodes().tooltip().fontFamily('vazir');

        chart.edges().tooltip().fontFamily('vazir');

        chart.edges().tooltip().format(" {%source_node_type}:  {%from} \n {%destination_node_type}:  {%to} \n ابزار تنظیم:  {%regulator_tool_name}");

        if (graph_type === "Directed") {
            chart.edges().arrows({
                enabled: true,
                size: 10,
                position: '50%'
            });
        }
        // chart.edges().arrows({
        //     enabled: true,
        //     size: 10,
        //     position: '50%'
        // });


        // var edges = chart.edges();

        // var normalConfig = { stroke: '#FFDE05' };
        // var hoveredConfig = { stroke: '#AC9603' };
        // var selectedConfig = { stroke: '#887603', labels: { enabled: true } };

        // edges.normal(normalConfig);
        // edges.hovered(hoveredConfig);
        // edges.selected(selectedConfig);

        // initiate drawing the chart
        chart.draw();


        chart.listen('Click', async function (event) {
            const click_tag = event.domTarget.tag;

            // edge clicked
            if (click_tag["type"] === "edge") {

                edges = chart_data['edges']
                edge_id = parseInt(click_tag['id'].split('_')[1])

                selected_edge = edges[edge_id]
                source_node_type = selected_edge['source_node_type']
                destination_node_type = selected_edge['destination_node_type']

                source_node = selected_edge['from']
                destination_node = selected_edge['to']


                tool_id = selected_edge['tool_id']
                tool_name = selected_edge['regulator_tool_name']

                area_id = selected_edge['area_id']
                regulator_id = selected_edge['regulator_id']


                if (source_node_type == 'تنظیم‌گر') {
                    operator_id = selected_edge['operator_id']

                    let request_link = 'http://' + location.host + "/GetRegulatorEdgeParagraphsByOperator_Modal/" + country_id + "/" + tool_id + "/" + regulator_id + "/" + operator_id + "/"
                    let response = await fetch(request_link).then(response => response.json());
                    let paragraphs_list = response['result_paragraphs'];

                    showEdgeModal(paragraphs_list,source_node_type,source_node, destination_node_type, destination_node);


                } else if (source_node_type == 'کلیدواژه') {
                    keyword = source_node
                    let request_link = 'http://' + location.host + "/GetRegulatorEdgeParagraphsByKeyword_Modal/" + country_id + "/" + tool_id + "/" + area_id + "/" + regulator_id + "/" + source_node + "/"
                    let response = await fetch(request_link).then(response => response.json());
                    let paragraphs_list = response['result_paragraphs'];

                    console.log(paragraphs_list)

                    showEdgeModal(paragraphs_list, source_node_type ,source_node, destination_node_type, destination_node);

                }

                $('#edge_modal_btn').click();


            }

        })



    }


    function showEdgeModal(paragraphs_list, source_node_type, source_node, destination_node_type, destination_node) {


        mojavez_pattern_keyword_1 = 'مجوز از'
        mojavez_pattern_keyword_2 = 'با مجوز'
        mojavez_pattern_keyword_3 = 'مجوز رسمی'
        mojavez_pattern_keyword_4 = 'مجوز رسمی از'
        mojavez_pattern_keywords_list = [mojavez_pattern_keyword_1, mojavez_pattern_keyword_2, mojavez_pattern_keyword_3, mojavez_pattern_keyword_4]

        ejaze_puntuations = [' ـ ', '.']

        console.log(source_node_type)
        console.log(destination_node_type)
        // source node title
        $('#source_node_label').text(source_node_type + ': ')
        $('#source_node_modal_header').text(source_node)

        // Destination node title
        $('#destination_node_label').text(destination_node_type + ': ')
        $('#destination_node_modal_header').text(destination_node)

        $('#edge_modal_body').empty();
        for (paragraph of paragraphs_list) {

            document_name = paragraph['document_name'];
            document_id = paragraph['document_id'];
            document_address = 'http://' + location.host + "/information/?id=" + document_id
            document_link = '<a target = "blank" href = "' + document_address + '">' + document_name + ':</a>'

            doc_tag = '<h6 class="bold">' + document_link + '</h6>'
            document.getElementById('edge_modal_body').innerHTML += doc_tag;


            // highlight paragraphs
            paragraph_text = paragraph['text']


            if (source_node_type == 'تنظیم‌گر') {

                paragraph_regulator = source_node
                $('#source_node_modal_header').removeClass('text-primary').addClass('text-success')
                $('#destination_node_modal_header').removeClass('text-success').addClass('text-primary')


                operator_form = paragraph['operator_form']
                operator_form_tag = "<span class='bg-primary text-white px-1 ml-1 rounded'>" + operator_form + "</span> "
                paragraph_text = paragraph_text.replaceAll(operator_form, operator_form_tag);
            }


            else if (source_node_type == 'کلیدواژه') {
                paragraph_regulator = destination_node

                $('#source_node_modal_header').removeClass('text-success').addClass('text-primary')
                $('#destination_node_modal_header').removeClass('text-primary').addClass('text-success')

                // highlight keywords
                keyword = source_node
                keyword_tag = "<span class='bg-primary text-white px-1 ml-1 rounded'>" + keyword + "</span> "
                paragraph_text = paragraph_text.replaceAll(keyword, keyword_tag);
            }


            paragraph_tool = paragraph['tool']


            if (paragraph_tool == 'مجوز') {
                for (tool_pattern of mojavez_pattern_keywords_list) {
                    if (paragraph_text.includes(tool_pattern)) {

                        tool_tag = "<span class='bg-warning text-white px-1 rounded'>" + tool_pattern + "</span> "
                        regulator_tag = "<span class='bg-success text-white px-1 ml-1 rounded'>" + paragraph_regulator + "</span> "
                        paragraph_text = paragraph_text.replaceAll(tool_pattern + ' ' + paragraph_regulator, tool_tag + regulator_tag);
                        paragraph_text = paragraph_text.replaceAll(tool_pattern + paragraph_regulator, tool_tag + regulator_tag);

                    }
                }
            }
            else if (paragraph_tool == 'اذن') {
                tool_tag = "<span class='bg-warning text-white px-1 rounded'>" + paragraph_tool + "</span> "
                regulator_tag = "<span class='bg-success text-white px-1 ml-1 rounded'>" + paragraph_regulator + "</span> "
                paragraph_text = paragraph_text.replaceAll(paragraph_tool + ' ' + paragraph_regulator, tool_tag + regulator_tag);

            }



            paragraph_tag = '<ul> <li dir="rtl" class = "text-right lh-lg">' + paragraph_text + '</li> </ul>'

            document.getElementById('edge_modal_body').innerHTML += paragraph_tag;


            $('#edge_modal_btn').click();

        }


    }


    async function SpinnerModeFunction(mode) {
        if (mode === "Active") {
            $(".spinner-border").addClass("active");
        } else if (mode === "Disable") {
            $(".spinner-border").removeClass("active");
        }
    }



</script>


<!-- Export results -->

<script>

    async function downloadFiles(file_name_list, save_file_name) {
        startFullPageBlockUI()
        const country_id = document.getElementById("country").value

        let zip = new JSZip()

        const request_link = 'http://' + location.host + "/GetCountryById/" + country_id + "/";
        let response = await fetch(request_link).then(response => response.json());
        response = response["country_information"][0]
        const country_folder = response["folder"];
        const country_name = response["name"];

        save_file_name += " مجموعه سند {" + country_name + "}"


        let extension = ".txt"
        if (country_name.includes("فاوا")) {
            extension = '.docx';
        }


        for (const [doc_id, doc_info] of Object.entries(file_name_list)) {

            const document_name = doc_info['name'] + extension

            const path = 'http://' + location.host + '/media/data/' + country_folder + '\\' + document_name;

            await fetch(path)
                .then(res => res.arrayBuffer())
                .then(value => {
                    zip.file(document_name, value);
                })
        }
        zip.generateAsync({
            type: "blob"
        })
            .then(function (content) {
                // see FileSaver.js
                saveAs(content, save_file_name + ".zip");
            });
        stopFullPageBlockUI('دانلود اسناد');
    }

    async function DownloadSerachResultFunction() {
        const save_file_name = " تنظیم‌گران در"
        downloadFiles(SearchResultValue, save_file_name)
    }

    async function ExportExcelSerachResultFunction() {
        var csv = "";

        sep = ","


        let Csv = "نام سند" + sep + "موضوع سند" + sep + "مرجع تصویب" + sep + "تاریخ تصویب" + sep +
            "تنظیم‌گر (ابزار تنظیم)" +
            "\n"
        for (const [doc_id, doc_info] of Object.entries(SearchResultValue)) {
            let document_regulators = doc_info["regulators"]
            document_regulators = document_regulators.toString().replaceAll(',', ' / ');

            Csv += doc_info['name'] + sep + doc_info['subject'] + sep +
                doc_info['approval_reference'] + sep +
                doc_info['approval_date'] + sep +
                document_regulators + "\n"

        }

        let save_file_name = " تنظیم‌گران در"
        save_file_name += " مجموعه سند {" + $('#country option:selected').text() + "}"

        let csvContent = "data:text/csv;charset=utf-8,%EF%BB%BF" + encodeURI(Csv);
        var link = document.createElement("a");
        link.setAttribute("href", csvContent);
        link.setAttribute("download", save_file_name + ".csv");
        document.body.appendChild(link);
        link.click()
    }



    function showToastMessage(message_text) {
        document.getElementById('toast_message').innerText = message_text
        var toastElList = [].slice.call(document.querySelectorAll('.toast'))
        var toastList = toastElList.map(function (toastEl) {
            return new bootstrap.Toast(toastEl)
        });
        toastList.forEach(toast => toast.show())
    }

    /* Search after press Enter */
    $("#info_form").submit(function () { return false; });
    $("#KeywordsBox").keyup(function (event) {
        if (event.keyCode === 13) {
            ShowResult()
        }
    });

</script>




<script src="../../static/js/tooltip_handler.js"></script>
<!-- Intro Js -->
<script src="../../static/js/regularity/regularity_tour.js">
</script>
<script src="../../static/js/tour.js"></script>

<!-- <script src="../../static/js/UserLogSave.js"></script>-->
<script src="../../static/js/signout_function.js"></script>



<!-- Blocking UI -->
<script src="../../static/js/blockUI.js"></script>
<script src="../../static/js/blockUI_handler.js"></script>
<link rel="stylesheet" href="../../static/styles/loader.css">

</html>